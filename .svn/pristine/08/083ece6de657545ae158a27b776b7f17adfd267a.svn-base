<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="advanceBill">
<select id="getAdvanceRentList" parameterType="Map" resultType="Map">
SELECT * FROM (
SELECT S.*,NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0)+NVL(S.SXF_PRICE,0)+NVL(S.GLF_PRICE,0)+NVL(S.LXZZS_PRICE,0) RENT_PRICE,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.BEGINNING_NUM,
         T.ITEM_FLAG,
         T.PAYLIST_CODE,
         CASE WHEN TT.PAY_WAY IN (2,4,6) AND T.BEGINNING_NUM =1
         THEN MAX(DECODE(T.BEGINNING_NAME,'本金',0)) 
         ELSE MAX(DECODE(T.BEGINNING_NAME,'本金',T.BEGINNING_MONEY)) END CAPITAL_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'利息',T.BEGINNING_MONEY)) INTEREST_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'手续费',T.BEGINNING_MONEY)) SXF_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'管理费',T.BEGINNING_MONEY)) GLF_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'利息增值税',T.BEGINNING_MONEY)) LXZZS_PRICE,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TTT.SHOW_NODE,
         TTT.TAX_TYPE,
		 TT.LEASE_CODE,
		 TT.PAY_ID,
		 TTT.TAX_RATE
     FROM ( SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           '租金' ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(
	  			select frb.beginning_receive_data,frb.beginning_num,frb.paylist_code,round(frb.BEGINNING_MONEY,2) BEGINNING_MONEY,frb.ITEM_FLAG
              ,frb.BEGINNING_NAME
              from fi_r_beginning frb
              left join (
                   select frb.paylist_code,max(frb.beginning_num)+1 beginning_num from fi_r_beginning frb 
                  where frb.ITEM_FLAG=2
          			  and frb.BEGINNING_NAME IN('本金','利息','管理费','手续费','利息增值税')
                  and TRUNC(frb.beginning_receive_data)&lt;=TRUNC(SYSDATE)
                  group by frb.paylist_code
              ) frb1 on frb1.paylist_code=frb.paylist_code
              where frb.ITEM_FLAG=2 and frb.beginning_num&lt;=NVL(frb1.beginning_num,1)
			  and frb.BEGINNING_NAME IN('本金','利息','管理费','手续费','利息增值税')
				
         )W
    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND W.BEGINNING_NUM = WW.RENT_LIST 
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 SU.SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD 
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
		        T_SYS_SUPPLIERS SU,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
		    AND V.SUP_ID = SU.SUP_ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
        AND FIA.INVOICEPATTERN='FP_TQ'
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
       SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if>
      WHERE TTT.IF_INVOICE = 1 
        AND TT.PROJECT_STATUS >= TTT.SHOW_NODE 
        AND TT.IS_INVOICE_MONTH='提前开具'
        AND TT.PRO_CODE NOT LIKE '%TEST%'
      GROUP BY TT.SUP_SHORTNAME, T.BEGINNING_NUM, T.ITEM_FLAG, T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START, TT.ON_CARD,TT.PAY_WAY,TT.SUB_COMPANY_NAME, TTT.SHOW_NODE,TTT.TAX_TYPE,TT.LEASE_CODE,TT.PAY_ID,TTT.TAX_RATE         
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE,T.BEGINNING_NUM,nlssort(T.ITEM_FLAG,'NLS_SORT=SCHINESE_PINYIN_M')
  )S WHERE NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0)+NVL(S.SXF_PRICE,0)+NVL(S.GLF_PRICE,0)+NVL(S.LXZZS_PRICE,0) >0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE != null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE != null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  AND <![CDATA[ROWNUM <= #{PAGE_END} ]]>
  )SS  WHERE SS.ROWNO >=#{PAGE_BEGIN}
</select>

<select id="getAdvanceRentCount" parameterType="Map" resultType="Int">
    SELECT COUNT(1) FROM (
SELECT S.*,NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0)+NVL(S.SXF_PRICE,0)+NVL(S.GLF_PRICE,0)+NVL(S.LXZZS_PRICE,0) RENT_PRICE,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.BEGINNING_NUM,
         T.ITEM_FLAG,
         T.PAYLIST_CODE,
         CASE WHEN TT.PAY_WAY IN (2,4,6) AND T.BEGINNING_NUM =1
         THEN MAX(DECODE(T.BEGINNING_NAME,'本金',0)) 
         ELSE MAX(DECODE(T.BEGINNING_NAME,'本金',T.BEGINNING_MONEY)) END CAPITAL_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'利息',T.BEGINNING_MONEY)) INTEREST_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'手续费',T.BEGINNING_MONEY)) SXF_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'管理费',T.BEGINNING_MONEY)) GLF_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'利息增值税',T.BEGINNING_MONEY)) LXZZS_PRICE,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TTT.SHOW_NODE,
         TTT.TAX_TYPE,
		 TT.LEASE_CODE,
		 TT.PAY_ID,
		 TTT.TAX_RATE
     FROM ( SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           '租金' ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(
				select frb.beginning_receive_data,frb.beginning_num,frb.paylist_code,round(frb.BEGINNING_MONEY,2) BEGINNING_MONEY,frb.ITEM_FLAG
              ,frb.BEGINNING_NAME
              from fi_r_beginning frb
              left join (
                   select frb.paylist_code,max(frb.beginning_num)+1 beginning_num from fi_r_beginning frb 
                  where frb.ITEM_FLAG=2
          			  and frb.BEGINNING_NAME IN('本金','利息','管理费','手续费','利息增值税')
                  and TRUNC(frb.beginning_receive_data)&lt;=TRUNC(SYSDATE)
                  group by frb.paylist_code
              ) frb1 on frb1.paylist_code=frb.paylist_code
              where frb.ITEM_FLAG=2 and frb.beginning_num&lt;=NVL(frb1.beginning_num,1)
			  and frb.BEGINNING_NAME IN('本金','利息','管理费','手续费','利息增值税')
         )W
    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND W.BEGINNING_NUM = WW.RENT_LIST 
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
                 HE.PRO_NAME,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 SU.SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD 
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
		        T_SYS_SUPPLIERS SU,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
		    AND V.SUP_ID = SU.SUP_ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
        AND FIA.INVOICEPATTERN='FP_TQ'
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
       SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if>
      WHERE  TTT.IF_INVOICE = 1
       	AND TT.PROJECT_STATUS >= TTT.SHOW_NODE 
       	AND TT.IS_INVOICE_MONTH='提前开具'
       	AND TT.PRO_CODE NOT LIKE '%TEST%'
      GROUP BY TT.SUP_SHORTNAME, T.BEGINNING_NUM, T.ITEM_FLAG, T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START,TT.SUB_COMPANY_NAME, TT.ON_CARD,TT.PAY_WAY, TTT.SHOW_NODE,TTT.TAX_TYPE,TT.LEASE_CODE,TT.PAY_ID,TTT.TAX_RATE     
  )S WHERE NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0)+NVL(S.SXF_PRICE,0)+NVL(S.GLF_PRICE,0)+NVL(S.LXZZS_PRICE,0)>0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE != null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE != null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
)SS
</select>

<select id="getAllRentBillMess" parameterType="Map" resultType="Map">

SELECT S.*,NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0)+NVL(S.SXF_PRICE,0)+NVL(S.GLF_PRICE,0)+NVL(S.LXZZS_PRICE,0) INVOICE_AMT,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.BEGINNING_NUM,
         T.ITEM_FLAG,
         T.PAYLIST_CODE,
         CASE WHEN TT.PAY_WAY IN (2,4,6) AND T.BEGINNING_NUM =1
         THEN MAX(DECODE(T.BEGINNING_NAME,'本金',0)) 
         ELSE MAX(DECODE(T.BEGINNING_NAME,'本金',T.BEGINNING_MONEY)) END CAPITAL_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'利息',T.BEGINNING_MONEY)) INTEREST_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'手续费',T.BEGINNING_MONEY)) SXF_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'管理费',T.BEGINNING_MONEY)) GLF_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'利息增值税',T.BEGINNING_MONEY)) LXZZS_PRICE,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TTT.SHOW_NODE,
         TTT.TAX_TYPE,
		 TT.LEASE_CODE,
		 TT.PAY_ID,
		 TTT.TAX_RATE
     FROM ( SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           '租金' ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(
	  			select frb.beginning_receive_data,frb.beginning_num,frb.paylist_code,round(frb.BEGINNING_MONEY,2) BEGINNING_MONEY,frb.ITEM_FLAG
              ,frb.BEGINNING_NAME
              from fi_r_beginning frb
              left join (
                   select frb.paylist_code,max(frb.beginning_num)+1 beginning_num from fi_r_beginning frb 
                  where frb.ITEM_FLAG=2
          			  and frb.BEGINNING_NAME IN('本金','利息','管理费','手续费','利息增值税')
                  and TRUNC(frb.beginning_receive_data)&lt;=TRUNC(SYSDATE)
                  group by frb.paylist_code
              ) frb1 on frb1.paylist_code=frb.paylist_code
              where frb.ITEM_FLAG=2 and frb.beginning_num&lt;=NVL(frb1.beginning_num,1)
			  and frb.BEGINNING_NAME IN('本金','利息','管理费','手续费','利息增值税')
         )W
    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND W.BEGINNING_NUM = WW.RENT_LIST 
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 SU.SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD 
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
		        T_SYS_SUPPLIERS SU,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
		    AND V.SUP_ID = SU.SUP_ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
        AND FIA.INVOICEPATTERN='FP_TQ'
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
       SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if>
      WHERE TTT.IF_INVOICE = 1 
        AND TT.PROJECT_STATUS >= TTT.SHOW_NODE 
        AND TT.IS_INVOICE_MONTH='提前开具'
        AND TT.PRO_CODE NOT LIKE '%TEST%'
      GROUP BY TT.SUP_SHORTNAME, T.BEGINNING_NUM, T.ITEM_FLAG, T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START, TT.ON_CARD,TT.PAY_WAY,TT.SUB_COMPANY_NAME, TTT.SHOW_NODE,TTT.TAX_TYPE,TT.LEASE_CODE,TT.PAY_ID,TTT.TAX_RATE         
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE,T.BEGINNING_NUM,nlssort(T.ITEM_FLAG,'NLS_SORT=SCHINESE_PINYIN_M')
  )S WHERE NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0)+NVL(S.SXF_PRICE,0)+NVL(S.GLF_PRICE,0)+NVL(S.LXZZS_PRICE,0) >0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE != null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE != null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
</select>

<select id="getFirstRentList" parameterType="Map" resultType="Map">
 SELECT * FROM (
SELECT S.*,NVL(S.ACCRUE_MONEY,0)+NVL(S.FIRSTRENT_MONEY,0)+NVL(S.STARTLX_MONEY,0)+${COLUMNSITEMTOTALMONEY} TOTAL_MONEY,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.PAYLIST_CODE,
         TT.PAY_WAY,
		 CASE WHEN MIN(to_number(decode(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))= 
			          MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM))) 
			          THEN TO_CHAR(MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))) 
	        		  ELSE (case when MIN(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))||'-'|| 
	        		  MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))='-' then '' else 
	        		  MIN(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))||'-'|| 
	        		  MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM))) end)
	        		   END RENT_LIST,
         
         MAX(DECODE(T.BEGINNING_NAME,'首期租金',T.BEGINNING_MONEY)) ACCRUE_MONEY,
         CASE WHEN TT.PAY_WAY IN (2,4,6) THEN MAX(DECODE(T.BEGINNING_NAME,'第一期租金',T.BEGINNING_MONEY))
           ELSE 0 END FIRSTRENT_MONEY,
		 CASE WHEN TT.PAY_WAY IN (2,4,6) THEN MAX(DECODE(T.BEGINNING_NAME,'租前利息',T.BEGINNING_MONEY))
           ELSE 0 END STARTLX_MONEY,
           ${COLUMNSITEM},
		 getdictdatabycode('业务类型',TT.MULTIPLE_MODEL) PROJECT_MODEL,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TTT.SHOW_NODE,
         TTT.TAX_TYPE,
         TT.LEASE_CODE,
		 TT.PAY_ID,
		 TT.MULTIPLE_MODEL,
		 TTT.TAX_RATE
    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(select frb.beginning_receive_data,frb.beginning_num,frb.paylist_code,round(frb.BEGINNING_MONEY,2) BEGINNING_MONEY,frb.ITEM_FLAG
              ,CASE WHEN frb.ITEM_FLAG=1 AND frb.BEGINNING_NAME='本金' THEN '第一期租金' WHEN frb.ITEM_FLAG=1 AND frb.BEGINNING_NAME='利息' THEN '租前利息' ELSE frb.BEGINNING_NAME END BEGINNING_NAME
              from fi_r_beginning frb 
              where (frb.beginning_num = 1 OR frb.beginning_num IS NULL)
              and frb.ITEM_FLAG != 2
			  and frb.BEGINNING_NAME IN(<include refid="tqkpColumns"/>)
         )W
   LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND ((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 case when V.START_DATE is null then trunc(sysdate) else V.START_DATE end CONFIRM_DATE_START,
                 case when V.START_DATE is null then trunc(sysdate) else V.START_DATE end CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 SU.SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD 
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
		        T_SYS_SUPPLIERS SU,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
		    AND V.SUP_ID = SU.SUP_ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
        SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
     WHERE  TTT.IF_INVOICE = 1 
        AND TT.PROJECT_STATUS >= TTT.SHOW_NODE 
        AND TT.IS_INVOICE_MONTH = '提前开具' 
        AND TT.PRO_CODE NOT LIKE '%TEST%'
      GROUP BY TT.SUP_SHORTNAME,T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START
	  ,TT.PAY_WAY, TT.ON_CARD,TTT.SHOW_NODE,TTT.TAX_TYPE,TT.LEASE_CODE,TT.PAY_ID,TT.MULTIPLE_MODEL,TTT.TAX_RATE
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE
  )S WHERE NVL(S.ACCRUE_MONEY,0)+NVL(S.FIRSTRENT_MONEY,0)+NVL(S.STARTLX_MONEY,0)+${COLUMNSITEMTOTALMONEY} !=0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND S.MULTIPLE_MODEL= #{PLATFORM_TYPE}</if>
  AND <![CDATA[ROWNUM <= #{PAGE_END}]]>
  )SS  WHERE SS.ROWNO >=#{PAGE_BEGIN}
</select>

<select id="getFirstRentCount" parameterType="Map" resultType="Int">
SELECT COUNT(1) FROM (    
  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.PAYLIST_CODE,
         TT.PAY_WAY,
		 CASE WHEN MIN(to_number(decode(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))= 
			          MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM))) 
			          THEN TO_CHAR(MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))) 
	        		  ELSE (case when MIN(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))||'-'|| 
	        		  MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))='-' then '' else 
	        		  MIN(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))||'-'|| 
	        		  MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM))) end)
	        		   END RENT_LIST,
        
         MAX(DECODE(T.BEGINNING_NAME,'首期租金',T.BEGINNING_MONEY)) ACCRUE_MONEY,
         CASE WHEN TT.PAY_WAY IN (2,4,6) THEN MAX(DECODE(T.BEGINNING_NAME,'第一期租金',T.BEGINNING_MONEY))
           ELSE 0 END FIRSTRENT_MONEY,
		 CASE WHEN TT.PAY_WAY IN (2,4,6) THEN MAX(DECODE(T.BEGINNING_NAME,'租前利息',T.BEGINNING_MONEY))
           ELSE 0 END STARTLX_MONEY,
         ${COLUMNSITEM},
		 getdictdatabycode('业务类型',TT.MULTIPLE_MODEL) PROJECT_MODEL,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TTT.SHOW_NODE,
         TTT.TAX_TYPE,
         TT.LEASE_CODE,
		 TT.PAY_ID,
		 TT.MULTIPLE_MODEL,
		 TTT.TAX_RATE
    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM( select frb.beginning_receive_data,frb.beginning_num,frb.paylist_code,round(frb.BEGINNING_MONEY,2) BEGINNING_MONEY,frb.ITEM_FLAG
              ,CASE WHEN frb.ITEM_FLAG=1 AND frb.BEGINNING_NAME='本金' THEN '第一期租金' WHEN frb.ITEM_FLAG=1 AND frb.BEGINNING_NAME='利息' THEN '租前利息' ELSE frb.BEGINNING_NAME END BEGINNING_NAME
              from fi_r_beginning frb 
              where (frb.beginning_num = 1 OR frb.beginning_num IS NULL)
              and frb.ITEM_FLAG != 2
			  and frb.BEGINNING_NAME IN(<include refid="tqkpColumns"/>)
         )W
    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 case when V.START_DATE is null then trunc(sysdate) else V.START_DATE end CONFIRM_DATE_START,
                 case when V.START_DATE is null then trunc(sysdate) else V.START_DATE end CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 SU.SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD 
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
		        T_SYS_SUPPLIERS SU,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
		    AND V.SUP_ID = SU.SUP_ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
        )TT ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
        SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
   WHERE TTT.IF_INVOICE = 1 
        AND TT.PROJECT_STATUS >= TTT.SHOW_NODE 
        AND TT.IS_INVOICE_MONTH = '提前开具' 
        AND TT.PRO_CODE NOT LIKE '%TEST%'
   GROUP BY TT.SUP_SHORTNAME,T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START
	  ,TT.PAY_WAY, TT.ON_CARD,TTT.SHOW_NODE,TTT.TAX_TYPE,TT.LEASE_CODE,TT.PAY_ID,TT.MULTIPLE_MODEL,TTT.TAX_RATE
  )S WHERE NVL(S.ACCRUE_MONEY,0)+NVL(S.FIRSTRENT_MONEY,0)+NVL(S.STARTLX_MONEY,0)+${COLUMNSITEMTOTALMONEY} !=0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
   <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND S.MULTIPLE_MODEL= #{PLATFORM_TYPE}</if>
</select>

<select id="getBillFirstInviceMess" parameterType="Map" resultType="Map">
SELECT S.*,NVL(S.ACCRUE_MONEY,0)+NVL(S.FIRSTRENT_MONEY,0)+NVL(S.STARTLX_MONEY,0)+${COLUMNSITEMTOTALMONEY} INVOICE_AMT,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.PAYLIST_CODE,
         TT.PAY_WAY,
		 CASE WHEN MIN(to_number(decode(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))= 
			          MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM))) 
			          THEN TO_CHAR(MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))) 
	        		  ELSE (case when MIN(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))||'-'|| 
	        		  MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))='-' then '' else 
	        		  MIN(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))||'-'|| 
	        		  MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM))) end)
	        		   END RENT_LIST,
         
         MAX(DECODE(T.BEGINNING_NAME,'首期租金',T.BEGINNING_MONEY)) ACCRUE_MONEY,
         CASE WHEN TT.PAY_WAY IN (2,4,6) THEN MAX(DECODE(T.BEGINNING_NAME,'第一期租金',T.BEGINNING_MONEY))
           ELSE 0 END FIRSTRENT_MONEY,
		 CASE WHEN TT.PAY_WAY IN (2,4,6) THEN MAX(DECODE(T.BEGINNING_NAME,'租前利息',T.BEGINNING_MONEY))
           ELSE 0 END STARTLX_MONEY,
         ${COLUMNSITEM},
		 getdictdatabycode('业务类型',TT.MULTIPLE_MODEL) PROJECT_MODEL,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TTT.SHOW_NODE,
         TTT.TAX_TYPE,
         TT.LEASE_CODE,
		 TT.PAY_ID,
		 TT.MULTIPLE_MODEL,
		 TTT.TAX_RATE
    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(select frb.beginning_receive_data,frb.beginning_num,frb.paylist_code,round(frb.BEGINNING_MONEY,2) BEGINNING_MONEY,frb.ITEM_FLAG
              ,CASE WHEN frb.ITEM_FLAG=1 AND frb.BEGINNING_NAME='本金' THEN '第一期租金' WHEN frb.ITEM_FLAG=1 AND frb.BEGINNING_NAME='利息' THEN '租前利息' ELSE frb.BEGINNING_NAME END BEGINNING_NAME
              from fi_r_beginning frb 
              where (frb.beginning_num = 1 OR frb.beginning_num IS NULL)
              and frb.ITEM_FLAG != 2
			  and frb.BEGINNING_NAME IN(<include refid="tqkpColumns"/>)
         )W
   LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND ((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 case when V.START_DATE is null then trunc(sysdate) else V.START_DATE end CONFIRM_DATE_START,
                 case when V.START_DATE is null then trunc(sysdate) else V.START_DATE end CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 SU.SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD 
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
		        T_SYS_SUPPLIERS SU,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
		    AND V.SUP_ID = SU.SUP_ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
        SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
     WHERE  TTT.IF_INVOICE = 1 
        AND TT.PROJECT_STATUS >= TTT.SHOW_NODE 
        AND TT.IS_INVOICE_MONTH = '提前开具' 
        AND TT.PRO_CODE NOT LIKE '%TEST%'
      GROUP BY TT.SUP_SHORTNAME,T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START
	  ,TT.PAY_WAY, TT.ON_CARD,TTT.SHOW_NODE,TTT.TAX_TYPE,TT.LEASE_CODE,TT.PAY_ID,TT.MULTIPLE_MODEL,TTT.TAX_RATE
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE
  )S WHERE NVL(S.ACCRUE_MONEY,0)+NVL(S.FIRSTRENT_MONEY,0)+NVL(S.STARTLX_MONEY,0)+${COLUMNSITEMTOTALMONEY} !=0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND S.MULTIPLE_MODEL= #{PLATFORM_TYPE}</if>
</select>

<select id="getAdvanceMergeList" parameterType="Map" resultType="Map">
SELECT * FROM (
	SELECT S.*, NVL(S.CAPITAL_PRICE_TOTAL,0)+NVL(S.INTEREST_PRICE_TOTAL,0) RENT_PRICE_TOTAL,
	       NVL(S.CAPITAL_PRICE_TOTAL,0)+NVL(S.INTEREST_PRICE_TOTAL,0)+NVL(S.OVER_PRICE_TOTAL,0)+NVL(S.FEE_PRICE,0)+NVL(S.LEAVING_PRICE,0)+NVL(S.ACCRUE_RENT_PRICE,0) INVOICE_AMT,
	       ROWNUM ROWNO FROM (
          SELECT TO_CHAR(MAX(TT.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
                 TT.PAYLIST_CODE,
		             CASE WHEN MIN(to_number(decode(TT.BEGINNING_NUM,0,NULL,TT.BEGINNING_NUM)))= 
			          MAX(to_number(DECODE(TT.BEGINNING_NUM,0,NULL,TT.BEGINNING_NUM))) 
			          THEN TO_CHAR(MAX(to_number(DECODE(TT.BEGINNING_NUM,0,NULL,TT.BEGINNING_NUM)))) 
	        		  ELSE (case when MIN(to_number(DECODE(TT.BEGINNING_NUM,0,NULL,TT.BEGINNING_NUM)))||'-'|| 
	        		  MAX(to_number(DECODE(TT.BEGINNING_NUM,0,NULL,TT.BEGINNING_NUM)))='-' then '' else 
	        		  MIN(to_number(DECODE(TT.BEGINNING_NUM,0,NULL,TT.BEGINNING_NUM)))||'-'|| 
	        		  MAX(to_number(DECODE(TT.BEGINNING_NUM,0,NULL,TT.BEGINNING_NUM))) end)
	        		   END RENT_LIST,
			         MAX(TT.BEGINNING_NUM) LEASE_TERM,
			         SUM(DECODE(TT.BEGINNING_NAME,'本金',TT.BEGINNING_MONEY,'第一期租金',TT.BEGINNING_MONEY)) CAPITAL_PRICE_TOTAL,
			         SUM(DECODE(TT.BEGINNING_NAME,'利息',TT.BEGINNING_MONEY)) INTEREST_PRICE_TOTAL,
			         SUM(DECODE(TT.BEGINNING_NAME,'违约金',TT.BEGINNING_MONEY)) OVER_PRICE_TOTAL,
			         SUM(DECODE(TT.BEGINNING_NAME,'手续费',TT.BEGINNING_MONEY)) FEE_PRICE,
			         SUM(DECODE(TT.BEGINNING_NAME,'留购价款',TT.BEGINNING_MONEY)) LEAVING_PRICE,
			         SUM(DECODE(TT.BEGINNING_NAME,'起租租金',TT.BEGINNING_MONEY)) ACCRUE_RENT_PRICE,
			         TT.PRO_CODE,
			         TT.CLIENT_NAME,
			         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
			         TT.ON_CARD,
			         TT.SUP_SHORTNAME,
			         TTT.SHOW_NODE,
			         TT.INVOICE_TARGET_TYPE,
			         TT.INVOICE_TARGET_ID 
		    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
                     W.BEGINNING_NUM,
                     W.ITEM_FLAG ,
                     W.PAYLIST_CODE,
                     W.BEGINNING_NAME,
                     W.INVOICE_TARGET_ID,
                     W.INVOICE_TARGET_TYPE,
                     W.BILL_TYPE,
                     W.BILL_METHOD IS_INVOICE_MONTH,
                     W.BEGINNING_MONEY,
                     W.ON_CARD,
                     W.MULTIPLE_MODEL,
                     W.START_CONFIRM_DATE CONFIRM_DATE_START,
                     W.START_CONFIRM_DATE CONFIRM_DATE_END,
                     W.LEASING_MODEL,
                     W.SUP_SHORTNAME,
                     W.PRO_CODE,
                     W.PAY_WAY,
                     W.CLIENT_NAME
		      FROM( SELECT R.BEGINNING_RECEIVE_DATA,
	                   R.BEGINNING_NUM,
	                   R.ITEM_FLAG,
	                   R.PAYLIST_CODE,
                       CASE WHEN R.IS_DIFFERENCE IN (0,1) AND R.BEGINNING_NAME='本金' AND R.BEGINNING_NUM =1  THEN '第一期租金'
                               WHEN R.BEGINNING_NAME='回购留购价款' THEN '留购价款' ELSE R.BEGINNING_NAME END BEGINNING_NAME,
	                   R.BEGINNING_MONEY,
	                   HE.INVOICE_TARGET_TYPE,
	                   HE.INVOICE_TARGET_ID,
	                   HE.BILL_TYPE,
	                   HE.BILL_METHOD ,
	                   CASE WHEN GETDICTDATABYCODE('牌抵挂',PH.PLEDGE_STATUS)='不上牌' THEN '不上牌' ELSE '上牌' END ON_CARD,
	                   PH.PROJECT_MODEL MULTIPLE_MODEL,
	                   PH.START_CONFIRM_DATE ,
	                   getDictShortnameByCode('发票_租赁模式',PH.PLATFORM_TYPE) LEASING_MODEL,
	                   PH.SUP_SHORTNAME,
	                   PH.PRO_CODE,
                       R.IS_DIFFERENCE PAY_WAY,
	                   CL.NAME CLIENT_NAME
	              FROM FI_R_BEGINNING R 
	            LEFT JOIN FI_INVOICE_AGREEMENT HE ON R.PAYLIST_CODE = R.PAYLIST_CODE
	            LEFT JOIN FIL_PROJECT_HEAD PH ON R.PROJECT_ID = PH.ID
	            LEFT JOIN FIL_CUST_CLIENT CL ON PH.CLIENT_ID = CL.ID
	            WHERE R.BEGINNING_FLAG =0 AND HE.BILL_TYPE = 1
		         )W
		    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.TARGET_TYPE,DE.TARGET_ID,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID,
				                  nvl(de.RENT_LIST,0) RENT_LIST
		                 FROM FI_SALEITEM_INVOICE SI,FI_SALEITEM_INVOICE_DETAIL DE 
		                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 and si.invoice_type!='收据'
		               )WW
		           ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
		          AND W.INVOICE_TARGET_TYPE = WW.TARGET_TYPE
		          AND W.INVOICE_TARGET_ID = WW.TARGET_ID 
		          AND W.BEGINNING_NAME = WW.ITEM_NAME	AND W.BEGINNING_NUM = WW.RENT_LIST
		        WHERE WW.SALEITEM_INVOICE_ID IS NULL
		          AND W.INVOICE_TARGET_ID IS NOT NULL
              AND W.INVOICE_TARGET_TYPE IS NOT NULL
		          )TT
		     LEFT JOIN (
		       SELECT HF.*,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE FROM v_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
		     )TTT ON TT.BEGINNING_NAME = TTT.FUND_TYPE
		      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if>
		      WHERE  TT.CONFIRM_DATE_START > TO_DATE('2012-09-01','YYYY-MM-DD')  
		        AND TTT.IF_INVOICE = 1 
		        AND TT.IS_INVOICE_MONTH = '合并开具' 
		        AND TT.PRO_CODE NOT LIKE '%TEST%'
		      GROUP BY TT.SUP_SHORTNAME,TT.PAYLIST_CODE,TT.PRO_CODE,TT.CLIENT_NAME, TT.CONFIRM_DATE_START,TT.ON_CARD, TTT.SHOW_NODE,TT.INVOICE_TARGET_TYPE,TT.INVOICE_TARGET_ID    
           ORDER BY nlssort(TT.SUP_SHORTNAME,'NLS_SORT=SCHINESE_PINYIN_M'),nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE
      )S WHERE NVL(S.CAPITAL_PRICE_TOTAL,0)+NVL(S.INTEREST_PRICE_TOTAL,0)+NVL(S.OVER_PRICE_TOTAL,0)+NVL(S.FEE_PRICE,0)+NVL(S.LEAVING_PRICE,0)+NVL(S.ACCRUE_RENT_PRICE,0) >0
          <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
	      <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
	      <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
		  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
		  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
		  AND <![CDATA[ROWNUM <= #{PAGE_END}]]>
      )SS WHERE SS.ROWNO >= #{PAGE_BEGIN}
</select>

<select id="getAdvanceMergeCount" parameterType="Map" resultType="Int">
SELECT COUNT(1) FROM (
          SELECT TO_CHAR(MAX(TT.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
                 TT.PAYLIST_CODE,
		             CASE WHEN MIN(to_number(decode(TT.BEGINNING_NUM,0,NULL,TT.BEGINNING_NUM)))= 
			          MAX(to_number(DECODE(TT.BEGINNING_NUM,0,NULL,TT.BEGINNING_NUM))) 
			          THEN TO_CHAR(MAX(to_number(DECODE(TT.BEGINNING_NUM,0,NULL,TT.BEGINNING_NUM)))) 
	        		  ELSE (case when MIN(to_number(DECODE(TT.BEGINNING_NUM,0,NULL,TT.BEGINNING_NUM)))||'-'|| 
	        		  MAX(to_number(DECODE(TT.BEGINNING_NUM,0,NULL,TT.BEGINNING_NUM)))='-' then '' else 
	        		  MIN(to_number(DECODE(TT.BEGINNING_NUM,0,NULL,TT.BEGINNING_NUM)))||'-'|| 
	        		  MAX(to_number(DECODE(TT.BEGINNING_NUM,0,NULL,TT.BEGINNING_NUM))) end)
	        		   END RENT_LIST,
			         MAX(TT.BEGINNING_NUM) LEASE_TERM,
			         SUM(DECODE(TT.BEGINNING_NAME,'本金',TT.BEGINNING_MONEY,'第一期租金',TT.BEGINNING_MONEY)) CAPITAL_PRICE_TOTAL,
			         SUM(DECODE(TT.BEGINNING_NAME,'利息',TT.BEGINNING_MONEY)) INTEREST_PRICE_TOTAL,
			         SUM(DECODE(TT.BEGINNING_NAME,'违约金',TT.BEGINNING_MONEY)) OVER_PRICE_TOTAL,
			         SUM(DECODE(TT.BEGINNING_NAME,'手续费',TT.BEGINNING_MONEY)) FEE_PRICE,
			         SUM(DECODE(TT.BEGINNING_NAME,'留购价款',TT.BEGINNING_MONEY)) LEAVING_PRICE,
			         SUM(DECODE(TT.BEGINNING_NAME,'起租租金',TT.BEGINNING_MONEY)) ACCRUE_RENT_PRICE,
			         TT.PRO_CODE,
			         TT.CLIENT_NAME,
			         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
			         TT.ON_CARD,
			         TT.SUP_SHORTNAME,
			         TTT.SHOW_NODE,
			         TT.INVOICE_TARGET_TYPE,
			         TT.INVOICE_TARGET_ID 
		    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
                     W.BEGINNING_NUM,
                     W.ITEM_FLAG ,
                     W.PAYLIST_CODE,
                     W.BEGINNING_NAME,
                     W.INVOICE_TARGET_ID,
                     W.INVOICE_TARGET_TYPE,
                     W.BILL_TYPE,
                     W.BILL_METHOD IS_INVOICE_MONTH,
                     W.BEGINNING_MONEY,
                     W.ON_CARD,
                     W.MULTIPLE_MODEL,
                     W.START_CONFIRM_DATE CONFIRM_DATE_START,
                     W.START_CONFIRM_DATE CONFIRM_DATE_END,
                     W.LEASING_MODEL,
                     W.SUP_SHORTNAME,
                     W.PRO_CODE,
                     W.PAY_WAY,
                     W.CLIENT_NAME
		      FROM( SELECT R.BEGINNING_RECEIVE_DATA,
	                   R.BEGINNING_NUM,
	                   R.ITEM_FLAG,
	                   R.PAYLIST_CODE,
                       CASE WHEN R.IS_DIFFERENCE IN (0,1) AND R.BEGINNING_NAME='本金' AND R.BEGINNING_NUM =1  THEN '第一期租金'
                               WHEN R.BEGINNING_NAME='回购留购价款' THEN '留购价款' ELSE R.BEGINNING_NAME END BEGINNING_NAME,
	                   R.BEGINNING_MONEY,
	                   HE.INVOICE_TARGET_TYPE,
	                   HE.INVOICE_TARGET_ID,
	                   HE.BILL_TYPE,
	                   HE.BILL_METHOD ,
	                   CASE WHEN GETDICTDATABYCODE('牌抵挂',PH.PLEDGE_STATUS)='不上牌' THEN '不上牌' ELSE '上牌' END ON_CARD,
	                   PH.PROJECT_MODEL MULTIPLE_MODEL,
	                   PH.START_CONFIRM_DATE ,
	                   getDictShortnameByCode('发票_租赁模式',PH.PLATFORM_TYPE) LEASING_MODEL,
	                   PH.SUP_SHORTNAME,
	                   PH.PRO_CODE,
                       R.IS_DIFFERENCE PAY_WAY,
	                   CL.NAME CLIENT_NAME
	              FROM FI_R_BEGINNING R 
	            LEFT JOIN FI_INVOICE_AGREEMENT HE ON R.PAYLIST_CODE = R.PAYLIST_CODE
	            LEFT JOIN FIL_PROJECT_HEAD PH ON R.PROJECT_ID = PH.ID
	            LEFT JOIN FIL_CUST_CLIENT CL ON PH.CLIENT_ID = CL.ID
	            WHERE R.BEGINNING_FLAG =0 AND HE.BILL_TYPE = 1
		         )W
		    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.TARGET_TYPE,DE.TARGET_ID,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID,
				              nvl(de.RENT_LIST,0) RENT_LIST
		                 FROM FI_SALEITEM_INVOICE SI,FI_SALEITEM_INVOICE_DETAIL DE 
		                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 and si.invoice_type!='收据'
		               )WW
		           ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
		          AND W.INVOICE_TARGET_TYPE = WW.TARGET_TYPE
		          AND W.INVOICE_TARGET_ID = WW.TARGET_ID 
		          AND W.BEGINNING_NAME = WW.ITEM_NAME	AND W.BEGINNING_NUM = WW.RENT_LIST
		        WHERE WW.SALEITEM_INVOICE_ID IS NULL
		          AND W.INVOICE_TARGET_ID IS NOT NULL
              AND W.INVOICE_TARGET_TYPE IS NOT NULL
		          )TT
		     LEFT JOIN (
		       SELECT HF.*,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE FROM v_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
		     )TTT ON TT.BEGINNING_NAME = TTT.FUND_TYPE
		      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if>
		      WHERE  TT.CONFIRM_DATE_START > TO_DATE('2012-09-01','YYYY-MM-DD')  
		        AND TTT.IF_INVOICE = 1 
		        AND TT.IS_INVOICE_MONTH = '合并开具' 
		        AND TT.PRO_CODE NOT LIKE '%TEST%'
		      GROUP BY TT.SUP_SHORTNAME,TT.PAYLIST_CODE,TT.PRO_CODE,TT.CLIENT_NAME, TT.CONFIRM_DATE_START,TT.ON_CARD, TTT.SHOW_NODE,TT.INVOICE_TARGET_TYPE,TT.INVOICE_TARGET_ID    
           ORDER BY nlssort(TT.SUP_SHORTNAME,'NLS_SORT=SCHINESE_PINYIN_M'),nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE
      )S WHERE NVL(S.CAPITAL_PRICE_TOTAL,0)+NVL(S.INTEREST_PRICE_TOTAL,0)+NVL(S.OVER_PRICE_TOTAL,0)+NVL(S.FEE_PRICE,0)+NVL(S.LEAVING_PRICE,0)+NVL(S.ACCRUE_RENT_PRICE,0) >0
          <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
	      <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
	      <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
		  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
		  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
</select>

<select id="getHeXiaoList" parameterType="Map" resultType="Map">
	SELECT * FROM (
SELECT TTT.*,ROWNUM ROWNO FROM (
	  SELECT SI.ID,
			  SI.PROJ_ID,
        SI.LEASE_CODE,
        SI.PAY_ID,
        SI.Paylist_Code,
		SI.AMOUNT_MEMO,
			  SI.INVOICE_TYPE,
			  SI.FUND_TYPE,
			  SI.FUND_NAME,
			  SI.RENT_LIST,
			  SI.INVOICE_CODE,
			  TO_CHAR(SI.INVOICE_DATE,'YYYY-MM-DD') INVOICE_DATE,
			  SI.IF_EXPORT_FP,
			  SI.STATUS,
			  SI.CREATOR,
			  SI.CREATE_DATE,
			  SI.MODIFICATOR,
			  SI.MODIFY_DATE,
			  SI.IS_HEBING,
			  SI.ERRFLAG,
			  SI.ALL_INVOICE_ID,
			  SI.ALL_INVOICE_NUM COUNT_NO,
			  SI.INVOICE_AMT,
        GETDICTDATABYCODE('上牌方式',VPS.CARDWAY) ON_CARD,
			  HE.PRO_NAME,
			  HE.PRO_CODE,
			  HE.STATUS PROJECT_STATUS,
			  getdictdatabycode('业务类型',HE.PLATFORM_TYPE) PROJECT_MODEL,
			  CL.NAME CLIENT_NAME,
			  SU.SUP_SHORTNAME,
			  SU.SUP_NAME,
			  VPS.START_DATE START_CONFIRM_DATE,
			  FIA.NO TARGET_ID,
	          FIA.W_NAME TARGET_NAME,
	          FIA.W_ADDR TARGET_ADD,
	          CASE WHEN FIA.W_DUTY is not null THEN FIA.W_DUTY
	               ELSE FIA.W_CODE_OR_CARD END  TARGET_TAX_CODE,
	          FIA.W_PHONE TARGET_TEL,
	          FIA.W_PHONE TARGET_ADD_PHONE,
	          CASE WHEN SI.TAX_TYPE=1
	          THEN DECODE(FIA.W_TAX_QUALIFICATION,'一般纳税人','专票','个人','普票','小规模纳税人','普票','其他')
	          ELSE DECODE(SI.TAX_TYPE,0,'专票',2,'普票') END TAX_TYPE,
	          FIA.W_TAX_QUALIFICATION TARGET_TAX_QUALIFICATION,
	          FIA.W_BANK TARGET_BANK,
	          (FIA.W_BANK ||' ' || FIA.W_BANK_NUMBER) TARGET_BANK_ACCOUNT,
	          FIA.W_BANK_NUMBER TARGET_ACCOUNT,
	          tsei.EMS_FLAG,
	          tsei.EMS_TO_NAME,
	          tsei.EMS_TO_PHONE,
	          tsei.EMS_TO_DW,
	          tsei.EMS_TO_ADDR,
	          tsei.EMS_TO_CITY,
	          tsei.EMS_TO_CODE,
			  HE.PLATFORM_TYPE,
			  SI.TAX_RATE
		FROM FI_SALEITEM_INVOICE SI 
     LEFT join v_plan_scheme VPS on SI.Paylist_Code=VPS.PAYLIST_CODE
     left join FIL_INVOICE_APPLICATION FIA on VPS.PAYLIST_CODE=FIA.PAYLIST_CODE
     left join t_sys_ems_info tsei on FIA.EMS_ID=tsei.id
    LEFT JOIN FIL_PROJECT_HEAD HE ON  SI.PROJ_ID = HE.ID
    LEFT JOIN FIL_CUST_CLIENT CL ON HE.CLIENT_ID = CL.ID
    LEFT JOIN T_SYS_SUPPLIERS SU ON VPS.SUP_ID = SU.SUP_ID
    WHERE (SI.IS_HEBING IS NULL OR SI.IS_HEBING =0) and SI.IS_TQKJ=2
     ORDER BY SI.PAYLIST_CODE,SI.RENT_LIST nulls first,nlssort(FIA.W_NAME,'NLS_SORT=SCHINESE_PINYIN_M')
   )TTT WHERE TTT.INVOICE_TYPE = #{INVOICE_TYPE}
		  AND TTT.STATUS = 0 
		  AND TTT.INVOICE_CODE IS NULL
        <if test="START_TIME !=null and START_TIME !=''">AND TTT.START_CONFIRM_DATE >= TO_DATE(#{START_TIME},'YYYY-MM-DD')</if>
	      <if test="END_TIME !=null and END_TIME !=''">AND <![CDATA[TTT.START_CONFIRM_DATE <= TO_DATE(#{END_TIME},'YYYY-MM-DD') ]]></if>
	      <if test="PRO_CODE !=null and PRO_CODE !=''">AND TTT.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
	      <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND TTT.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
		  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND TTT.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if> 
	      <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND TTT.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if> 
	      <if test="CLIENT_NAME !=null and CLIENT_NAME !=''">AND TTT.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if>
	      <if test="FUND_NAME !=null and FUND_NAME !=''">AND TTT.FUND_TYPE = #{FUND_NAME}</if>
	      <if test="TAX_TYPE !=null and TAX_TYPE !=''">AND TTT.TAX_TYPE = #{TAX_TYPE}</if>
	      <if test="ON_CARD !=null and ON_CARD !=''">AND TTT.ON_CARD = #{ON_CARD}</if> 
	      <if test="IF_EXPORT_FP !=null and IF_EXPORT_FP !=''">AND TTT.IF_EXPORT_FP = #{IF_EXPORT_FP}</if>
		  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND TTT.PLATFORM_TYPE = #{PLATFORM_TYPE}</if>
		  AND <![CDATA[ROWNUM <= #{PAGE_END}]]>
   )WT WHERE WT.ROWNO >= #{PAGE_BEGIN}  
</select>

<select id="getHeXiaoCount" parameterType="Map" resultType="Int">
	SELECT COUNT(*) FROM (
	   SELECT SI.ID,
			  SI.PROJ_ID,
        SI.LEASE_CODE,
        SI.PAY_ID,
        SI.Paylist_Code,
			SI.AMOUNT_MEMO,
			  SI.INVOICE_TYPE,
			  SI.FUND_TYPE,
			  SI.FUND_NAME,
			  SI.RENT_LIST,
			  SI.INVOICE_CODE,
			  TO_CHAR(SI.INVOICE_DATE,'YYYY-MM-DD') INVOICE_DATE,
			  SI.IF_EXPORT_FP,
			  SI.STATUS,
			  SI.CREATOR,
			  SI.CREATE_DATE,
			  SI.MODIFICATOR,
			  SI.MODIFY_DATE,
			  SI.IS_HEBING,
			  SI.ERRFLAG,
			  SI.ALL_INVOICE_ID,
			  SI.ALL_INVOICE_NUM COUNT_NO,
			  SI.INVOICE_AMT,
        GETDICTDATABYCODE('上牌方式',VPS.CARDWAY) ON_CARD,
			  HE.PRO_NAME,
			  HE.PRO_CODE,
			  HE.STATUS PROJECT_STATUS,
			  getdictdatabycode('业务类型',HE.PLATFORM_TYPE) PROJECT_MODEL,
			  CL.NAME CLIENT_NAME,
			  SU.SUP_SHORTNAME,
			  SU.SUP_NAME,
			  VPS.START_DATE START_CONFIRM_DATE,
			  FIA.NO TARGET_ID,
	          FIA.W_NAME TARGET_NAME,
	          FIA.W_ADDR TARGET_ADD,
	          CASE WHEN FIA.W_DUTY is not null THEN FIA.W_DUTY
	               ELSE FIA.W_CODE_OR_CARD END  TARGET_TAX_CODE,
	          FIA.W_PHONE TARGET_TEL,
	          FIA.W_PHONE TARGET_ADD_PHONE,
	          CASE WHEN SI.TAX_TYPE=1
	          THEN DECODE(FIA.W_TAX_QUALIFICATION,'一般纳税人','专票','个人','普票','小规模纳税人','普票','其他')
	          ELSE DECODE(SI.TAX_TYPE,0,'专票',2,'普票') END TAX_TYPE,
	          FIA.W_TAX_QUALIFICATION TARGET_TAX_QUALIFICATION,
	          FIA.W_BANK TARGET_BANK,
	          (FIA.W_BANK ||' ' || FIA.W_BANK_NUMBER) TARGET_BANK_ACCOUNT,
	          FIA.W_BANK_NUMBER TARGET_ACCOUNT,
	          tsei.EMS_FLAG,
	          tsei.EMS_TO_NAME,
	          tsei.EMS_TO_PHONE,
	          tsei.EMS_TO_DW,
	          tsei.EMS_TO_ADDR,
	          tsei.EMS_TO_CITY,
	          tsei.EMS_TO_CODE,
			  HE.PLATFORM_TYPE,
			  SI.TAX_RATE
		FROM FI_SALEITEM_INVOICE SI 
     LEFT join v_plan_scheme VPS on SI.Paylist_Code=VPS.PAYLIST_CODE
     left join FIL_INVOICE_APPLICATION FIA on VPS.PAYLIST_CODE=FIA.PAYLIST_CODE
     left join t_sys_ems_info tsei on FIA.EMS_ID=tsei.id
    LEFT JOIN FIL_PROJECT_HEAD HE ON  SI.PROJ_ID = HE.ID
    LEFT JOIN FIL_CUST_CLIENT CL ON HE.CLIENT_ID = CL.ID
    LEFT JOIN T_SYS_SUPPLIERS SU ON VPS.SUP_ID = SU.SUP_ID
    WHERE (SI.IS_HEBING IS NULL OR SI.IS_HEBING =0)  and SI.IS_TQKJ=2
     ORDER BY SI.PAYLIST_CODE,SI.RENT_LIST,nlssort(FIA.W_NAME,'NLS_SORT=SCHINESE_PINYIN_M')
   )TTT WHERE TTT.INVOICE_TYPE = #{INVOICE_TYPE}
		  AND TTT.STATUS = 0 
		  AND TTT.INVOICE_CODE IS NULL
	      <if test="START_TIME !=null and START_TIME !=''">AND TTT.START_CONFIRM_DATE >= TO_DATE(#{START_TIME},'YYYY-MM-DD')</if>
	      <if test="END_TIME !=null and END_TIME !=''">AND <![CDATA[TTT.START_CONFIRM_DATE <= TO_DATE(#{END_TIME},'YYYY-MM-DD') ]]></if>
	      <if test="PRO_CODE !=null and PRO_CODE !=''">AND TTT.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
	      <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND TTT.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
		  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND TTT.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if> 
	      <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND TTT.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if> 
	      <if test="CLIENT_NAME !=null and CLIENT_NAME !=''">AND TTT.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if>
	      <if test="FUND_NAME !=null and FUND_NAME !=''">AND TTT.FUND_TYPE = #{FUND_NAME}</if>
	      <if test="TAX_TYPE !=null and TAX_TYPE !=''">AND TTT.TAX_TYPE = #{TAX_TYPE}</if>
	      <if test="ON_CARD !=null and ON_CARD !=''">AND TTT.ON_CARD = #{ON_CARD}</if> 
	      <if test="IF_EXPORT_FP !=null and IF_EXPORT_FP !=''">AND TTT.IF_EXPORT_FP = #{IF_EXPORT_FP}</if>
		  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND TTT.PLATFORM_TYPE = #{PLATFORM_TYPE}</if>
</select>



<sql id="tqkpColumns"> 
   SELECT distinct CF.FUND_TYPE
       FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF,T_SYS_DATA_DICTIONARY tsdd  
       WHERE HF.ID = CF.RULER_ID  and HF.is_invoice_month='提前开具' and CF.IF_INVOICE=1 and tsdd.type='发票_资金别名' and CF.FUND_TYPE=tsdd.flag
</sql>

<select id="tqkpColumnsMaxMoney" resultType="String">
	select 
          WM_CONCAT('MAX(DECODE(T.BEGINNING_NAME,''' || t1.FUND_TYPE || ''',T.BEGINNING_MONEY)) ' || t1.shortname) 
    from (
          SELECT distinct CF.FUND_TYPE,tsdd.shortname
       FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF,T_SYS_DATA_DICTIONARY tsdd  
       WHERE HF.ID = CF.RULER_ID  and HF.is_invoice_month='提前开具' and CF.IF_INVOICE=1 and tsdd.type='发票_资金别名' and CF.FUND_TYPE=tsdd.flag
        and CF.FUND_TYPE not in ('首期租金','第一期租金','租前利息'
        
        )
   ) t1 
</select>

<select id="tqkpColumnsTotalMoney" resultType="String">
		select 
		       replace(replace(WM_CONCAT('NVL(' || 'S.' || t1.shortname  || ';0)'),',','+'),';',',')
    from (
          SELECT distinct tsdd.shortname
       FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF,T_SYS_DATA_DICTIONARY tsdd  
       WHERE HF.ID = CF.RULER_ID  and HF.is_invoice_month='提前开具' and CF.IF_INVOICE=1 and tsdd.type='发票_资金别名' and CF.FUND_TYPE=tsdd.flag
        and CF.FUND_TYPE not in ('首期租金','第一期租金','租前利息'
        
        )
   ) t1 
</select>

<select id="tqkjColumnsAllTitel" resultType="map">
	SELECT distinct CF.FUND_TYPE,upper(tsdd.shortname) shortname
       FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF,T_SYS_DATA_DICTIONARY tsdd  
       WHERE HF.ID = CF.RULER_ID  and HF.is_invoice_month='提前开具' and CF.IF_INVOICE=1 and tsdd.type='发票_资金别名' and CF.FUND_TYPE=tsdd.flag
        and CF.FUND_TYPE not in ('首期租金','第一期租金','租前利息','本金','利息','违约金','利息增值税'
        )
</select>

</mapper>