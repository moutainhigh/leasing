<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="Receipt">
<select id="getDbReceiptApplyList" parameterType="Map" resultType="Map">
SELECT * FROM (
SELECT S.*,NVL(S.BEGINNING_MONEY,0) TOTAL_MONEY,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(T.BEGINNING_RECEIVE_DATA,'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.PAYLIST_CODE,
         TT.PAY_WAY,
         T.BEGINNING_MONEY,
		 GETDICTSITEDATABYCODE('业务类型',TT.MULTIPLE_MODEL) PROJECT_MODEL,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TT.LEASE_CODE,
		 TT.PAY_ID,
		 TT.MULTIPLE_MODEL,
		 TT.SUP_NAME INVOICE_TO_NAME
    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  BA.D_PAY_PROJECT BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.RE_STATUS = 0 AND BA.RED_STATUS = 0 AND BA.D_STATUS=0
              AND (BA.PERIOD = 1 OR BA.PERIOD IS NULL)
              AND BA.D_PAY_PROJECT IN('供应商保证金')
         )W
   LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND ((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD,
				 V.SUP_NAME
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
        SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.RECEIPT_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
     WHERE  TTT.IF_RECEIPT = 1
        AND TT.PROJECT_STATUS >= TTT.RECEIPT_NODE
        AND TT.PRO_CODE NOT LIKE '%TEST%'
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE
  )S WHERE NVL(S.BEGINNING_MONEY,0) !=0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND S.MULTIPLE_MODEL= #{PLATFORM_TYPE}</if>
  AND <![CDATA[ROWNUM <= #{PAGE_END}]]>
  )SS  WHERE SS.ROWNO >=#{PAGE_BEGIN}
</select>

<select id="getDbReceiptApplyCount" parameterType="Map" resultType="Int">
SELECT COUNT(1) FROM (
  SELECT S.*,NVL(S.BEGINNING_MONEY,0) TOTAL_MONEY,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(T.BEGINNING_RECEIVE_DATA,'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.PAYLIST_CODE,
         TT.PAY_WAY,
         T.BEGINNING_MONEY,
		 GETDICTSITEDATABYCODE('业务类型',TT.MULTIPLE_MODEL) PROJECT_MODEL,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TT.LEASE_CODE,
		 TT.PAY_ID,
		 TT.MULTIPLE_MODEL,
		 TT.SUP_NAME INVOICE_TO_NAME
    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  BA.D_PAY_PROJECT BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.RE_STATUS = 0 AND BA.RED_STATUS = 0 AND BA.D_STATUS=0
              AND (BA.PERIOD = 1 OR BA.PERIOD IS NULL)
              AND BA.D_PAY_PROJECT IN('供应商保证金')
         )W
   LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND ((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD,
				 V.SUP_NAME
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
        SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.RECEIPT_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
     WHERE  TTT.IF_RECEIPT = 1
        AND TT.PROJECT_STATUS >= TTT.RECEIPT_NODE
        AND TT.PRO_CODE NOT LIKE '%TEST%'
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE
  )S WHERE NVL(S.BEGINNING_MONEY,0) !=0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND S.MULTIPLE_MODEL= #{PLATFORM_TYPE}</if>
  )SS
</select>

<select id="getAllDbReceiptMess" parameterType="Map" resultType="Map">
	SELECT S.*,NVL(S.BEGINNING_MONEY,0) INVOICE_AMT,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(T.BEGINNING_RECEIVE_DATA,'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.PAYLIST_CODE,
         TT.PAY_WAY,
         T.BEGINNING_MONEY,
		 GETDICTSITEDATABYCODE('业务类型',TT.MULTIPLE_MODEL) PROJECT_MODEL,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TT.LEASE_CODE,
		 TT.PAY_ID,
		 TT.MULTIPLE_MODEL,
		 TT.SUP_NAME INVOICE_TO_NAME
    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  BA.D_PAY_PROJECT BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.RE_STATUS = 0 AND BA.RED_STATUS = 0 AND BA.D_STATUS=0
              AND (BA.PERIOD = 1 OR BA.PERIOD IS NULL)
              AND BA.D_PAY_PROJECT IN('供应商保证金')
         )W
   LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND ((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD,
				 V.SUP_NAME
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
        SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.RECEIPT_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
     WHERE  TTT.IF_RECEIPT = 1
        AND TT.PROJECT_STATUS >= TTT.RECEIPT_NODE
        AND TT.PRO_CODE NOT LIKE '%TEST%'
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE
  )S WHERE NVL(S.BEGINNING_MONEY,0) !=0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND S.MULTIPLE_MODEL= #{PLATFORM_TYPE}</if>
</select>


<select id="getReceiptFirstpayApplyList" parameterType="Map" resultType="Map">
 SELECT * FROM (
SELECT S.*,NVL(S.ACCRUE_MONEY,0)+NVL(S.FIRSTRENT_MONEY,0)+NVL(S.STARTLX_MONEY,0)+${COLUMNSITEMTOTALMONEY} TOTAL_MONEY,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.PAYLIST_CODE,
         TT.PAY_WAY,
        
         MAX(DECODE(T.BEGINNING_NAME,'首期租金',T.BEGINNING_MONEY)) ACCRUE_MONEY,
         CASE WHEN TT.PAY_WAY IN (2,4,6) THEN MAX(DECODE(T.BEGINNING_NAME,'第一期租金',T.BEGINNING_MONEY))
           ELSE 0 END FIRSTRENT_MONEY,
		 CASE WHEN TT.PAY_WAY IN (2,4,6) THEN MAX(DECODE(T.BEGINNING_NAME,'租前利息',T.BEGINNING_MONEY))
           ELSE 0 END STARTLX_MONEY,
           ${COLUMNSITEM},
		 GETDICTSITEDATABYCODE('业务类型',TT.MULTIPLE_MODEL) PROJECT_MODEL,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TT.LEASE_CODE,
		 TT.PAY_ID,
		 TT.MULTIPLE_MODEL,
		 TT.W_NAME INVOICE_TO_NAME
    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  CASE WHEN BA.D_PAY_PROJECT='本金' THEN '第一期租金' WHEN BA.D_PAY_PROJECT='利息' THEN '租前利息' ELSE BA.D_PAY_PROJECT END BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.RE_STATUS = 0 AND BA.RED_STATUS = 0 AND BA.D_STATUS=0
              AND (BA.PERIOD = 1 OR BA.PERIOD IS NULL)
              AND BA.D_PAY_PROJECT IN(<include refid="sjkpColumns"/>)
         )W
   LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND ((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD,
				 FIA.W_NAME
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
        SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.RECEIPT_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
     WHERE  TTT.IF_RECEIPT = 1
        AND TT.PROJECT_STATUS >= TTT.RECEIPT_NODE
        AND TT.PRO_CODE NOT LIKE '%TEST%'
      GROUP BY TT.SUP_SHORTNAME,T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START
	  ,TT.PAY_WAY, TT.ON_CARD,TT.LEASE_CODE,TT.PAY_ID,TT.MULTIPLE_MODEL,TT.W_NAME
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE
  )S WHERE NVL(S.ACCRUE_MONEY,0)+NVL(S.FIRSTRENT_MONEY,0)+NVL(S.STARTLX_MONEY,0)+${COLUMNSITEMTOTALMONEY} !=0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND S.MULTIPLE_MODEL= #{PLATFORM_TYPE}</if>
  AND <![CDATA[ROWNUM <= #{PAGE_END}]]>
  )SS  WHERE SS.ROWNO >=#{PAGE_BEGIN}
</select>

<select id="getReceiptFirstPayApplyCount" parameterType="Map" resultType="Int">
SELECT COUNT(1) FROM (
SELECT S.*,NVL(S.ACCRUE_MONEY,0)+NVL(S.FIRSTRENT_MONEY,0)+NVL(S.STARTLX_MONEY,0)+${COLUMNSITEMTOTALMONEY} TOTAL_MONEY,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.PAYLIST_CODE,
         TT.PAY_WAY,
         
         MAX(DECODE(T.BEGINNING_NAME,'首期租金',T.BEGINNING_MONEY)) ACCRUE_MONEY,
         CASE WHEN TT.PAY_WAY IN (2,4,6) THEN MAX(DECODE(T.BEGINNING_NAME,'第一期租金',T.BEGINNING_MONEY))
           ELSE 0 END FIRSTRENT_MONEY,
		 CASE WHEN TT.PAY_WAY IN (2,4,6) THEN MAX(DECODE(T.BEGINNING_NAME,'租前利息',T.BEGINNING_MONEY))
           ELSE 0 END STARTLX_MONEY,
          ${COLUMNSITEM},
		 GETDICTSITEDATABYCODE('业务类型',TT.MULTIPLE_MODEL) PROJECT_MODEL,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TT.LEASE_CODE,
		 TT.PAY_ID,
		 TT.MULTIPLE_MODEL,
		 TT.W_NAME INVOICE_TO_NAME
    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  CASE WHEN BA.D_PAY_PROJECT='本金' THEN '第一期租金' WHEN BA.D_PAY_PROJECT='利息' THEN '租前利息' ELSE BA.D_PAY_PROJECT END BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.RE_STATUS = 0 AND BA.RED_STATUS = 0 AND BA.D_STATUS=0
              AND (BA.PERIOD = 1 OR BA.PERIOD IS NULL)
              AND BA.D_PAY_PROJECT IN(<include refid="sjkpColumns"/>)
         )W
   LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND ((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD,
				 FIA.W_NAME 
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
        SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.RECEIPT_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
     WHERE  TTT.IF_RECEIPT = 1
        AND TT.PROJECT_STATUS >= TTT.RECEIPT_NODE
        AND TT.PRO_CODE NOT LIKE '%TEST%'
      GROUP BY TT.SUP_SHORTNAME,T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START
	  ,TT.PAY_WAY, TT.ON_CARD,TT.LEASE_CODE,TT.PAY_ID,TT.MULTIPLE_MODEL,TT.W_NAME
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE
  )S WHERE NVL(S.ACCRUE_MONEY,0)+NVL(S.FIRSTRENT_MONEY,0)+NVL(S.STARTLX_MONEY,0)+${COLUMNSITEMTOTALMONEY} !=0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND S.MULTIPLE_MODEL= #{PLATFORM_TYPE}</if>
  )SS
</select>

<select id="getAllFirstReceiptMess" parameterType="Map" resultType="Map">
SELECT S.*,NVL(S.ACCRUE_MONEY,0)+NVL(S.FIRSTRENT_MONEY,0)+NVL(S.STARTLX_MONEY,0)+${COLUMNSITEMTOTALMONEY} INVOICE_AMT,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.PAYLIST_CODE,
         TT.PAY_WAY,
        
         MAX(DECODE(T.BEGINNING_NAME,'首期租金',T.BEGINNING_MONEY)) ACCRUE_MONEY,
         CASE WHEN TT.PAY_WAY IN (2,4,6) THEN MAX(DECODE(T.BEGINNING_NAME,'第一期租金',T.BEGINNING_MONEY))
           ELSE 0 END FIRSTRENT_MONEY,
		 CASE WHEN TT.PAY_WAY IN (2,4,6) THEN MAX(DECODE(T.BEGINNING_NAME,'租前利息',T.BEGINNING_MONEY))
           ELSE 0 END STARTLX_MONEY,
           ${COLUMNSITEM},
		 GETDICTSITEDATABYCODE('业务类型',TT.MULTIPLE_MODEL) PROJECT_MODEL,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TT.LEASE_CODE,
		 TT.PAY_ID,
		 TT.MULTIPLE_MODEL,
		 TT.W_NAME INVOICE_TO_NAME
    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  CASE WHEN BA.D_PAY_PROJECT='本金' THEN '第一期租金' WHEN BA.D_PAY_PROJECT='利息' THEN '租前利息' ELSE BA.D_PAY_PROJECT END BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.RE_STATUS = 0 AND BA.RED_STATUS = 0 AND BA.D_STATUS=0
              AND (BA.PERIOD = 1 OR BA.PERIOD IS NULL)
              AND BA.D_PAY_PROJECT IN(<include refid="sjkpColumns"/>)
         )W
   LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND ((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD,
				 FIA.W_NAME 
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
        SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.RECEIPT_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
     WHERE  TTT.IF_RECEIPT = 1
        AND TT.PROJECT_STATUS >= TTT.RECEIPT_NODE
        AND TT.PRO_CODE NOT LIKE '%TEST%'
      GROUP BY TT.SUP_SHORTNAME,T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START
	  ,TT.PAY_WAY, TT.ON_CARD,TT.LEASE_CODE,TT.PAY_ID,TT.MULTIPLE_MODEL,TT.W_NAME
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE
  )S WHERE NVL(S.ACCRUE_MONEY,0)+NVL(S.FIRSTRENT_MONEY,0)+NVL(S.STARTLX_MONEY,0)+${COLUMNSITEMTOTALMONEY} !=0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND S.MULTIPLE_MODEL= #{PLATFORM_TYPE}</if>
</select>

<select id="getReceiptRentApplyList" parameterType="Map" resultType="Map">
SELECT * FROM (
SELECT S.*,NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0)+NVL(S.SXF_PRICE,0)+NVL(S.GLF_PRICE,0)+NVL(S.LXZZS_PRICE,0) RENT_PRICE,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.BEGINNING_NUM,
         T.ITEM_FLAG,
         T.PAYLIST_CODE,
         CASE WHEN TT.PAY_WAY IN (2,4,6) AND T.BEGINNING_NUM =1
         THEN MAX(DECODE(T.BEGINNING_NAME,'本金',0)) 
         ELSE MAX(DECODE(T.BEGINNING_NAME,'本金',T.BEGINNING_MONEY)) END CAPITAL_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'利息',T.BEGINNING_MONEY)) INTEREST_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'手续费',T.BEGINNING_MONEY)) SXF_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'管理费',T.BEGINNING_MONEY)) GLF_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'利息增值税',T.BEGINNING_MONEY)) LXZZS_PRICE,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
		 TT.LEASE_CODE,
		 TT.PAY_ID,
		 TT.W_NAME INVOICE_TO_NAME
     FROM ( SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           CASE WHEN W.ITEM_FLAG = 1 THEN '租金' ELSE '违约金' END ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  BA.D_PAY_PROJECT BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.RED_STATUS = 0
               AND BA.D_STATUS=1
         )W
    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
                AND DE.ITEM_STATUS = 0
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND W.BEGINNING_NUM = WW.RENT_LIST 
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD,
				 FIA.W_NAME
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
        
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
       SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.RECEIPT_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if>
      WHERE TTT.IF_RECEIPT = 1
	    AND TT.PROJECT_STATUS >= TTT.RECEIPT_NODE
        AND TT.PRO_CODE NOT LIKE '%TEST%'
      GROUP BY TT.SUP_SHORTNAME, T.BEGINNING_NUM, T.ITEM_FLAG, T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START, TT.ON_CARD,TT.PAY_WAY,TT.SUB_COMPANY_NAME,TT.LEASE_CODE,TT.PAY_ID,TT.W_NAME         
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE,T.BEGINNING_NUM,nlssort(T.ITEM_FLAG,'NLS_SORT=SCHINESE_PINYIN_M')
  )S WHERE NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0)+NVL(S.SXF_PRICE,0)+NVL(S.GLF_PRICE,0)+NVL(S.LXZZS_PRICE,0) >0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE != null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE != null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  AND <![CDATA[ROWNUM <= #{PAGE_END} ]]>
  )SS  WHERE SS.ROWNO >=#{PAGE_BEGIN}
</select>

<select id="getReceiptRentApplyCount" parameterType="Map" resultType="Int">
SELECT COUNT(1) FROM ( 
	SELECT S.*,NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0)+NVL(S.SXF_PRICE,0)+NVL(S.GLF_PRICE,0)+NVL(S.LXZZS_PRICE,0) RENT_PRICE,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.BEGINNING_NUM,
         T.ITEM_FLAG,
         T.PAYLIST_CODE,
         CASE WHEN TT.PAY_WAY IN (2,4,6) AND T.BEGINNING_NUM =1
         THEN MAX(DECODE(T.BEGINNING_NAME,'本金',0)) 
         ELSE MAX(DECODE(T.BEGINNING_NAME,'本金',T.BEGINNING_MONEY)) END CAPITAL_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'利息',T.BEGINNING_MONEY)) INTEREST_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'手续费',T.BEGINNING_MONEY)) SXF_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'管理费',T.BEGINNING_MONEY)) GLF_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'利息增值税',T.BEGINNING_MONEY)) LXZZS_PRICE,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
		 TT.LEASE_CODE,
		 TT.PAY_ID,
		 TT.W_NAME INVOICE_TO_NAME
     FROM ( SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           CASE WHEN W.ITEM_FLAG = 1 THEN '租金' ELSE '违约金' END ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  BA.D_PAY_PROJECT BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.RED_STATUS = 0
               AND BA.D_STATUS=1
         )W
    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
                AND DE.ITEM_STATUS = 0
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND W.BEGINNING_NUM = WW.RENT_LIST 
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD,
				 FIA.W_NAME
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
        
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
       SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.RECEIPT_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if>
      WHERE TTT.IF_RECEIPT = 1
	    AND TT.PROJECT_STATUS >= TTT.RECEIPT_NODE
        AND TT.PRO_CODE NOT LIKE '%TEST%'
      GROUP BY TT.SUP_SHORTNAME, T.BEGINNING_NUM, T.ITEM_FLAG, T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START, TT.ON_CARD,TT.PAY_WAY,TT.SUB_COMPANY_NAME,TT.LEASE_CODE,TT.PAY_ID,TT.W_NAME         
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE,T.BEGINNING_NUM,nlssort(T.ITEM_FLAG,'NLS_SORT=SCHINESE_PINYIN_M')
  )S WHERE NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0)+NVL(S.SXF_PRICE,0)+NVL(S.GLF_PRICE,0)+NVL(S.LXZZS_PRICE,0) >0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE != null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE != null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  )SS
</select>

<!--TODO start-->
<select id="getReceiptRentVirtualApplyList" parameterType="Map" resultType="Map">
SELECT * FROM (
SELECT S.*,NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0)+NVL(S.DAMAGE_PRICE, 0) RENT_PRICE,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.BEGINNING_NUM,
         T.ITEM_FLAG,
         T.PAYLIST_CODE,
         CASE WHEN TT.PAY_WAY IN (2,4,6) AND T.BEGINNING_NUM =1
         THEN MAX(DECODE(T.BEGINNING_NAME,'本金',0)) 
         ELSE MAX(DECODE(T.BEGINNING_NAME,'本金',T.BEGINNING_MONEY)) END CAPITAL_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'利息',T.BEGINNING_MONEY)) INTEREST_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'违约金',T.BEGINNING_MONEY)) DAMAGE_PRICE,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
		 TT.LEASE_CODE,
		 TT.PAY_ID
     FROM ( SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           CASE WHEN W.ITEM_FLAG = 1 THEN '租金' ELSE '违约金' END ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  BA.D_PAY_PROJECT BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =1 AND BA.RED_STATUS = 0 AND BA.RE_STATUS = 4
               AND BA.D_STATUS IN (1,2)
         )W
    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
                AND DE.ITEM_STATUS = 1
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND W.BEGINNING_NUM = WW.RENT_LIST 
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if>
      WHERE  TT.PRO_CODE NOT LIKE '%TEST%'
      GROUP BY TT.SUP_SHORTNAME, T.BEGINNING_NUM, T.ITEM_FLAG, T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START, TT.ON_CARD,TT.PAY_WAY,TT.SUB_COMPANY_NAME,TT.LEASE_CODE,TT.PAY_ID        
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE,T.BEGINNING_NUM,nlssort(T.ITEM_FLAG,'NLS_SORT=SCHINESE_PINYIN_M')
  )S WHERE NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0) + NVL(S.DAMAGE_PRICE, 0) > 0 
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE != null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE != null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  AND <![CDATA[ROWNUM <= #{PAGE_END} ]]>
  )SS  WHERE SS.ROWNO >=#{PAGE_BEGIN}
</select>

<select id="getReceiptRentVirtualApplyCount" parameterType="Map" resultType="Int">
SELECT COUNT(1) FROM ( 
	SELECT S.*,NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0) RENT_PRICE,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.BEGINNING_NUM,
         T.ITEM_FLAG,
         T.PAYLIST_CODE,
         CASE WHEN TT.PAY_WAY IN (2,4,6) AND T.BEGINNING_NUM =1
         THEN MAX(DECODE(T.BEGINNING_NAME,'本金',0)) 
         ELSE MAX(DECODE(T.BEGINNING_NAME,'本金',T.BEGINNING_MONEY)) END CAPITAL_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'利息',T.BEGINNING_MONEY)) INTEREST_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'违约金',T.BEGINNING_MONEY)) DAMAGE_PRICE,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
		 TT.LEASE_CODE,
		 TT.PAY_ID
     FROM ( SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           CASE WHEN W.ITEM_FLAG = 1 THEN '租金' ELSE '违约金' END ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  BA.D_PAY_PROJECT BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =1 AND BA.RED_STATUS = 0 AND BA.RE_STATUS = 4
               AND BA.D_STATUS IN (1,2)
         )W
    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
                AND DE.ITEM_STATUS = 1
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND W.BEGINNING_NUM = WW.RENT_LIST 
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if>
      WHERE TT.PRO_CODE NOT LIKE '%TEST%'
      GROUP BY TT.SUP_SHORTNAME, T.BEGINNING_NUM, T.ITEM_FLAG, T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START, TT.ON_CARD,TT.PAY_WAY,TT.SUB_COMPANY_NAME,TT.LEASE_CODE,TT.PAY_ID         
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE,T.BEGINNING_NUM,nlssort(T.ITEM_FLAG,'NLS_SORT=SCHINESE_PINYIN_M')
  )S WHERE NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0) + NVL(S.DAMAGE_PRICE, 0) > 0 
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE != null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE != null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  )SS
</select>

<select id="getAllRentReceiptVirtualMess" parameterType="Map" resultType="Map">

SELECT S.*,NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0)+NVL(S.DAMAGE_PRICE, 0) INVOICE_AMT,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.BEGINNING_NUM,
         T.ITEM_FLAG,
         T.PAYLIST_CODE,
         CASE WHEN TT.PAY_WAY IN (2,4,6) AND T.BEGINNING_NUM =1
         THEN MAX(DECODE(T.BEGINNING_NAME,'本金',0)) 
         ELSE MAX(DECODE(T.BEGINNING_NAME,'本金',T.BEGINNING_MONEY)) END CAPITAL_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'利息',T.BEGINNING_MONEY)) INTEREST_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'违约金',T.BEGINNING_MONEY)) DAMAGE_PRICE,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
		 TT.LEASE_CODE,
		 TT.PAY_ID
     FROM ( SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           CASE WHEN W.ITEM_FLAG = 1 THEN '租金' ELSE '违约金' END ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  BA.D_PAY_PROJECT BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =1 AND BA.RED_STATUS = 0 AND BA.RE_STATUS = 4
               AND BA.D_STATUS IN (1,2)
         )W
    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
                AND DE.ITEM_STATUS = 1
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND W.BEGINNING_NUM = WW.RENT_LIST 
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if>
      WHERE  TT.PRO_CODE NOT LIKE '%TEST%'
      GROUP BY TT.SUP_SHORTNAME, T.BEGINNING_NUM, T.ITEM_FLAG, T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START, TT.ON_CARD,TT.PAY_WAY,TT.SUB_COMPANY_NAME,TT.LEASE_CODE,TT.PAY_ID        
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE,T.BEGINNING_NUM,nlssort(T.ITEM_FLAG,'NLS_SORT=SCHINESE_PINYIN_M')
  )S WHERE NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0) + NVL(S.DAMAGE_PRICE, 0) > 0 
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE != null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE != null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
</select>

<!--TODO end-->

<select id="getAllRentReceiptMess" parameterType="Map" resultType="Map">
SELECT S.*,NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0)+NVL(S.SXF_PRICE,0)+NVL(S.GLF_PRICE,0)+NVL(S.LXZZS_PRICE,0) INVOICE_AMT,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.BEGINNING_NUM,
         T.ITEM_FLAG,
         T.PAYLIST_CODE,
         CASE WHEN TT.PAY_WAY IN (2,4,6) AND T.BEGINNING_NUM =1
         THEN MAX(DECODE(T.BEGINNING_NAME,'本金',0)) 
         ELSE MAX(DECODE(T.BEGINNING_NAME,'本金',T.BEGINNING_MONEY)) END CAPITAL_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'利息',T.BEGINNING_MONEY)) INTEREST_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'手续费',T.BEGINNING_MONEY)) SXF_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'管理费',T.BEGINNING_MONEY)) GLF_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'利息增值税',T.BEGINNING_MONEY)) LXZZS_PRICE,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
		 TT.LEASE_CODE,
		 TT.PAY_ID,
		 TT.W_NAME INVOICE_TO_NAME
     FROM ( SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           CASE WHEN W.ITEM_FLAG = 1 THEN '租金' ELSE '违约金' END ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  BA.D_PAY_PROJECT BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.RED_STATUS = 0
              AND BA.D_STATUS=1
         )W
    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND W.BEGINNING_NUM = WW.RENT_LIST 
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD,
				 FIA.W_NAME
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
       
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
       SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.RECEIPT_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if>
      WHERE TTT.IF_RECEIPT = 1
	    AND TT.PROJECT_STATUS >= TTT.RECEIPT_NODE
        AND TT.PRO_CODE NOT LIKE '%TEST%'
      GROUP BY TT.SUP_SHORTNAME, T.BEGINNING_NUM, T.ITEM_FLAG, T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START, TT.ON_CARD,TT.PAY_WAY,TT.SUB_COMPANY_NAME,TT.LEASE_CODE,TT.PAY_ID,TT.W_NAME         
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE,T.BEGINNING_NUM,nlssort(T.ITEM_FLAG,'NLS_SORT=SCHINESE_PINYIN_M')
  )S WHERE NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0)+NVL(S.SXF_PRICE,0)+NVL(S.GLF_PRICE,0)+NVL(S.LXZZS_PRICE,0) >0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE != null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE != null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
</select>

<select id="getReceiptHeXiaoList" parameterType="Map" resultType="Map">
SELECT * FROM (
SELECT TTT.*,ROWNUM ROWNO FROM (
	  SELECT SI.ID,
			  SI.PROJ_ID,
        SI.LEASE_CODE,
        SI.PAY_ID,
        SI.Paylist_Code,
		SI.AMOUNT_MEMO,
			  SI.INVOICE_TYPE,
			  SI.FUND_TYPE,
			  SI.FUND_NAME,
			  SI.RENT_LIST,
			  SI.INVOICE_CODE,
			  TO_CHAR(SI.INVOICE_DATE,'YYYY-MM-DD') INVOICE_DATE,
			  SI.IF_EXPORT_FP,
			  SI.STATUS,
			  SI.CREATOR,
			  SI.CREATE_DATE,
			  SI.MODIFICATOR,
			  SI.MODIFY_DATE,
			  SI.IS_HEBING,
			  SI.ERRFLAG,
			  SI.ALL_INVOICE_ID,
			  SI.ALL_INVOICE_NUM COUNT_NO,
			  SI.INVOICE_AMT,
			  SI.INVOICE_TO_NAME,
        GETDICTDATABYCODE('上牌方式',VPS.CARDWAY) ON_CARD,
			  HE.PRO_NAME,
			  HE.PRO_CODE,
			  HE.STATUS PROJECT_STATUS,
			  GETDICTSITEDATABYCODE('业务类型',HE.PLATFORM_TYPE) PROJECT_MODEL,
			  CL.NAME CLIENT_NAME,
			  VPS.SUP_NAME SUP_SHORTNAME,
			  VPS.SUP_NAME,
			  VPS.START_DATE START_CONFIRM_DATE,
			  FIA.NO TARGET_ID,
	          FIA.W_NAME TARGET_NAME,
	          FIA.W_ADDR TARGET_ADD,
	          CASE WHEN FIA.W_DUTY is not null THEN FIA.W_DUTY
	               ELSE FIA.W_CODE_OR_CARD END  TARGET_TAX_CODE,
	          FIA.W_PHONE TARGET_TEL,
	          FIA.W_PHONE TARGET_ADD_PHONE,
	          CASE WHEN SI.TAX_TYPE=1
	          THEN DECODE(FIA.W_TAX_QUALIFICATION,'一般纳税人','专票','个人','普票','小规模纳税人','普票','其他')
	          ELSE DECODE(SI.TAX_TYPE,0,'专票',2,'普票') END TAX_TYPE,
	          FIA.W_TAX_QUALIFICATION TARGET_TAX_QUALIFICATION,
	          FIA.W_BANK TARGET_BANK,
	          (FIA.W_BANK ||' ' || FIA.W_BANK_NUMBER) TARGET_BANK_ACCOUNT,
	          FIA.W_BANK_NUMBER TARGET_ACCOUNT,
	          tsei.EMS_FLAG,
	          tsei.EMS_TO_NAME,
	          tsei.EMS_TO_PHONE,
	          tsei.EMS_TO_DW,
	          tsei.EMS_TO_ADDR,
	          tsei.EMS_TO_CITY,
	          tsei.EMS_TO_CODE,
			  HE.PLATFORM_TYPE,
			  SI.TAX_RATE
		FROM FI_SALEITEM_INVOICE SI 
     LEFT join v_plan_scheme VPS on SI.Paylist_Code=VPS.PAYLIST_CODE
     left join FIL_INVOICE_APPLICATION FIA on VPS.PAYLIST_CODE=FIA.PAYLIST_CODE
     left join t_sys_ems_info tsei on FIA.EMS_ID=tsei.id
    LEFT JOIN FIL_PROJECT_HEAD HE ON  SI.PROJ_ID = HE.ID
    LEFT JOIN FIL_CUST_CLIENT CL ON HE.CLIENT_ID = CL.ID
    WHERE (SI.IS_HEBING IS NULL OR SI.IS_HEBING =0)  and SI.IS_TQKJ=1
     ORDER BY SI.PAYLIST_CODE,SI.RENT_LIST,nlssort(FIA.W_NAME,'NLS_SORT=SCHINESE_PINYIN_M')
   )TTT WHERE TTT.INVOICE_TYPE = #{INVOICE_TYPE}
		  AND TTT.STATUS = 0 
		  AND TTT.INVOICE_CODE IS NULL
        <if test="START_TIME !=null and START_TIME !=''">AND TTT.START_CONFIRM_DATE >= TO_DATE(#{START_TIME},'YYYY-MM-DD')</if>
	      <if test="END_TIME !=null and END_TIME !=''">AND <![CDATA[TTT.START_CONFIRM_DATE <= TO_DATE(#{END_TIME},'YYYY-MM-DD') ]]></if>
	      <if test="PRO_CODE !=null and PRO_CODE !=''">AND TTT.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
	      <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND TTT.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
		  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND TTT.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if> 
	      <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND TTT.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if> 
	      <if test="CLIENT_NAME !=null and CLIENT_NAME !=''">AND TTT.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if>
	      <if test="FUND_NAME !=null and FUND_NAME !=''">AND TTT.FUND_TYPE = #{FUND_NAME}</if>
	      <if test="TAX_TYPE !=null and TAX_TYPE !=''">AND TTT.TAX_TYPE = #{TAX_TYPE}</if>
	      <if test="ON_CARD !=null and ON_CARD !=''">AND TTT.ON_CARD = #{ON_CARD}</if> 
	      <if test="IF_EXPORT_FP !=null and IF_EXPORT_FP !=''">AND TTT.IF_EXPORT_FP = #{IF_EXPORT_FP}</if>
		  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND TTT.PLATFORM_TYPE = #{PLATFORM_TYPE}</if>
		   AND <![CDATA[ROWNUM <= #{PAGE_END}]]>
   )WT WHERE WT.ROWNO >= #{PAGE_BEGIN}  
</select>

<select id="getReceiptHeXiaoCount" parameterType="Map" resultType="Int">
 SELECT COUNT(*) FROM (
	   SELECT SI.ID,
			  SI.PROJ_ID,
        SI.LEASE_CODE,
        SI.PAY_ID,
        SI.Paylist_Code,
			SI.AMOUNT_MEMO,
			  SI.INVOICE_TYPE,
			  SI.FUND_TYPE,
			  SI.FUND_NAME,
			  SI.RENT_LIST,
			  SI.INVOICE_CODE,
			  TO_CHAR(SI.INVOICE_DATE,'YYYY-MM-DD') INVOICE_DATE,
			  SI.IF_EXPORT_FP,
			  SI.STATUS,
			  SI.CREATOR,
			  SI.CREATE_DATE,
			  SI.MODIFICATOR,
			  SI.MODIFY_DATE,
			  SI.IS_HEBING,
			  SI.ERRFLAG,
			  SI.ALL_INVOICE_ID,
			  SI.ALL_INVOICE_NUM COUNT_NO,
			  SI.INVOICE_AMT,
			  SI.INVOICE_TO_NAME,
        GETDICTDATABYCODE('上牌方式',VPS.CARDWAY) ON_CARD,
			  HE.PRO_NAME,
			  HE.PRO_CODE,
			  HE.STATUS PROJECT_STATUS,
			  GETDICTSITEDATABYCODE('业务类型',HE.PLATFORM_TYPE) PROJECT_MODEL,
			  CL.NAME CLIENT_NAME,
			  VPS.SUP_NAME SUP_SHORTNAME,
			  VPS.SUP_NAME,
			  VPS.START_DATE START_CONFIRM_DATE,
			  FIA.NO TARGET_ID,
	          FIA.W_NAME TARGET_NAME,
	          FIA.W_ADDR TARGET_ADD,
	          CASE WHEN FIA.W_DUTY is not null THEN FIA.W_DUTY
	               ELSE FIA.W_CODE_OR_CARD END  TARGET_TAX_CODE,
	          FIA.W_PHONE TARGET_TEL,
	          FIA.W_PHONE TARGET_ADD_PHONE,
	          CASE WHEN SI.TAX_TYPE=1
	          THEN DECODE(FIA.W_TAX_QUALIFICATION,'一般纳税人','专票','个人','普票','小规模纳税人','普票','其他')
	          ELSE DECODE(SI.TAX_TYPE,0,'专票',2,'普票') END TAX_TYPE,
	          FIA.W_TAX_QUALIFICATION TARGET_TAX_QUALIFICATION,
	          FIA.W_BANK TARGET_BANK,
	          (FIA.W_BANK ||' ' || FIA.W_BANK_NUMBER) TARGET_BANK_ACCOUNT,
	          FIA.W_BANK_NUMBER TARGET_ACCOUNT,
	          tsei.EMS_FLAG,
	          tsei.EMS_TO_NAME,
	          tsei.EMS_TO_PHONE,
	          tsei.EMS_TO_DW,
	          tsei.EMS_TO_ADDR,
	          tsei.EMS_TO_CITY,
	          tsei.EMS_TO_CODE,
			  HE.PLATFORM_TYPE,
			  SI.TAX_RATE
		FROM FI_SALEITEM_INVOICE SI 
     LEFT join v_plan_scheme VPS on SI.Paylist_Code=VPS.PAYLIST_CODE
     left join FIL_INVOICE_APPLICATION FIA on VPS.PAYLIST_CODE=FIA.PAYLIST_CODE
     left join t_sys_ems_info tsei on FIA.EMS_ID=tsei.id
    LEFT JOIN FIL_PROJECT_HEAD HE ON  SI.PROJ_ID = HE.ID
    LEFT JOIN FIL_CUST_CLIENT CL ON HE.CLIENT_ID = CL.ID
    WHERE (SI.IS_HEBING IS NULL OR SI.IS_HEBING =0)  and SI.IS_TQKJ=1
     ORDER BY SI.PAYLIST_CODE,SI.RENT_LIST,nlssort(FIA.W_NAME,'NLS_SORT=SCHINESE_PINYIN_M')
   )TTT WHERE TTT.INVOICE_TYPE = #{INVOICE_TYPE}
		  AND TTT.STATUS = 0 
		  AND TTT.INVOICE_CODE IS NULL
	      <if test="START_TIME !=null and START_TIME !=''">AND TTT.START_CONFIRM_DATE >= TO_DATE(#{START_TIME},'YYYY-MM-DD')</if>
	      <if test="END_TIME !=null and END_TIME !=''">AND <![CDATA[TTT.START_CONFIRM_DATE <= TO_DATE(#{END_TIME},'YYYY-MM-DD') ]]></if>
	      <if test="PRO_CODE !=null and PRO_CODE !=''">AND TTT.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
	      <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND TTT.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
		  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND TTT.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if> 
	      <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND TTT.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if> 
	      <if test="CLIENT_NAME !=null and CLIENT_NAME !=''">AND TTT.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if>
	      <if test="FUND_NAME !=null and FUND_NAME !=''">AND TTT.FUND_TYPE = #{FUND_NAME}</if>
	      <if test="TAX_TYPE !=null and TAX_TYPE !=''">AND TTT.TAX_TYPE = #{TAX_TYPE}</if>
	      <if test="ON_CARD !=null and ON_CARD !=''">AND TTT.ON_CARD = #{ON_CARD}</if> 
	      <if test="IF_EXPORT_FP !=null and IF_EXPORT_FP !=''">AND TTT.IF_EXPORT_FP = #{IF_EXPORT_FP}</if>
		  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND TTT.PLATFORM_TYPE = #{PLATFORM_TYPE}</if>
</select>

<select id="getDBRReceiptApplyList" parameterType="Map" resultType="Map">
SELECT * FROM (
SELECT S.*,NVL(S.BEGINNING_MONEY,0) TOTAL_MONEY,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(T.BEGINNING_RECEIVE_DATA,'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.PAYLIST_CODE,
         TT.PAY_WAY,
         T.BEGINNING_MONEY,
		 GETDICTSITEDATABYCODE('业务类型',TT.MULTIPLE_MODEL) PROJECT_MODEL,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TT.LEASE_CODE,
		 TT.PAY_ID,
		 TT.MULTIPLE_MODEL,
		 TT.W_NAME INVOICE_TO_NAME
    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  BA.D_PAY_PROJECT BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.RE_STATUS = 0 AND BA.RED_STATUS = 0 AND BA.D_STATUS=0
              AND (BA.PERIOD = 1 OR BA.PERIOD IS NULL)
              AND BA.D_PAY_PROJECT IN('担保费')
         )W
   LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND ((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD,
				 FIA.W_NAME
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
        SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.RECEIPT_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
     WHERE  TTT.IF_RECEIPT = 1
        AND TT.PROJECT_STATUS >= TTT.RECEIPT_NODE
        AND TT.PRO_CODE NOT LIKE '%TEST%'
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE
  )S WHERE NVL(S.BEGINNING_MONEY,0) !=0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND S.MULTIPLE_MODEL= #{PLATFORM_TYPE}</if>
  AND <![CDATA[ROWNUM <= #{PAGE_END}]]>
  )SS  WHERE SS.ROWNO >=#{PAGE_BEGIN}
</select>

<select id="getDBRReceiptApplyCount" parameterType="Map" resultType="Int">
SELECT COUNT(1) FROM (
  SELECT S.*,NVL(S.BEGINNING_MONEY,0) TOTAL_MONEY,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(T.BEGINNING_RECEIVE_DATA,'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.PAYLIST_CODE,
         TT.PAY_WAY,
         T.BEGINNING_MONEY,
		 GETDICTSITEDATABYCODE('业务类型',TT.MULTIPLE_MODEL) PROJECT_MODEL,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TT.LEASE_CODE,
		 TT.PAY_ID,
		 TT.MULTIPLE_MODEL,
		 TT.W_NAME INVOICE_TO_NAME
    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  BA.D_PAY_PROJECT BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.RE_STATUS = 0 AND BA.RED_STATUS = 0 AND BA.D_STATUS=0
              AND (BA.PERIOD = 1 OR BA.PERIOD IS NULL)
              AND BA.D_PAY_PROJECT IN('担保费')
         )W
   LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND ((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD,
				 FIA.W_NAME
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
        SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.RECEIPT_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
     WHERE  TTT.IF_RECEIPT = 1
        AND TT.PROJECT_STATUS >= TTT.RECEIPT_NODE
        AND TT.PRO_CODE NOT LIKE '%TEST%'
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE
  )S WHERE NVL(S.BEGINNING_MONEY,0) !=0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND S.MULTIPLE_MODEL= #{PLATFORM_TYPE}</if>
  )SS
</select>

<select id="getAllDBRReceiptMess" parameterType="Map" resultType="Map">
	SELECT S.*,NVL(S.BEGINNING_MONEY,0) INVOICE_AMT,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(T.BEGINNING_RECEIVE_DATA,'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.PAYLIST_CODE,
         TT.PAY_WAY,
         T.BEGINNING_MONEY,
		 GETDICTSITEDATABYCODE('业务类型',TT.MULTIPLE_MODEL) PROJECT_MODEL,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TT.LEASE_CODE,
		 TT.PAY_ID,
		 TT.MULTIPLE_MODEL,
		 TT.W_NAME INVOICE_TO_NAME
    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  BA.D_PAY_PROJECT BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.RE_STATUS = 0 AND BA.RED_STATUS = 0 AND BA.D_STATUS=0
              AND (BA.PERIOD = 1 OR BA.PERIOD IS NULL)
              AND BA.D_PAY_PROJECT IN('担保费')
         )W
   LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND ((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD,
				 FIA.W_NAME
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
        SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.RECEIPT_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
     WHERE  TTT.IF_RECEIPT = 1
        AND TT.PROJECT_STATUS >= TTT.RECEIPT_NODE
        AND TT.PRO_CODE NOT LIKE '%TEST%'
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE
  )S WHERE NVL(S.BEGINNING_MONEY,0) !=0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND S.MULTIPLE_MODEL= #{PLATFORM_TYPE}</if>
</select>

<select id="getCSReceiptApplyList" parameterType="Map" resultType="Map">
SELECT * FROM (
SELECT S.*,NVL(S.BEGINNING_MONEY,0) TOTAL_MONEY,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(T.BEGINNING_RECEIVE_DATA,'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.PAYLIST_CODE,
         TT.PAY_WAY,
         T.BEGINNING_MONEY,
		 GETDICTSITEDATABYCODE('业务类型',TT.MULTIPLE_MODEL) PROJECT_MODEL,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TT.LEASE_CODE,
		 TT.PAY_ID,
		 TT.MULTIPLE_MODEL,
		 TT.SUB_COMPANY_NAME INVOICE_TO_NAME
    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  BA.D_PAY_PROJECT BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.RE_STATUS = 0 AND BA.RED_STATUS = 0 AND BA.D_STATUS=0
              AND (BA.PERIOD = 1 OR BA.PERIOD IS NULL)
              AND BA.D_PAY_PROJECT IN('厂商保证金')
         )W
   LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND ((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD 
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
        SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.RECEIPT_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
     WHERE  TTT.IF_RECEIPT = 1
        AND TT.PROJECT_STATUS >= TTT.RECEIPT_NODE
        AND TT.PRO_CODE NOT LIKE '%TEST%'
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE
  )S WHERE NVL(S.BEGINNING_MONEY,0) !=0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND S.MULTIPLE_MODEL= #{PLATFORM_TYPE}</if>
  AND <![CDATA[ROWNUM <= #{PAGE_END}]]>
  )SS  WHERE SS.ROWNO >=#{PAGE_BEGIN}
</select>

<select id="getCSReceiptApplyCount" parameterType="Map" resultType="Int">
SELECT COUNT(1) FROM (
  SELECT S.*,NVL(S.BEGINNING_MONEY,0) TOTAL_MONEY,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(T.BEGINNING_RECEIVE_DATA,'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.PAYLIST_CODE,
         TT.PAY_WAY,
         T.BEGINNING_MONEY,
		 GETDICTSITEDATABYCODE('业务类型',TT.MULTIPLE_MODEL) PROJECT_MODEL,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TT.LEASE_CODE,
		 TT.PAY_ID,
		 TT.MULTIPLE_MODEL,
		 TT.SUB_COMPANY_NAME INVOICE_TO_NAME
    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  BA.D_PAY_PROJECT BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.RE_STATUS = 0 AND BA.RED_STATUS = 0 AND BA.D_STATUS=0
              AND (BA.PERIOD = 1 OR BA.PERIOD IS NULL)
              AND BA.D_PAY_PROJECT IN('厂商保证金')
         )W
   LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND ((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD 
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
        SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.RECEIPT_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
     WHERE  TTT.IF_RECEIPT = 1
        AND TT.PROJECT_STATUS >= TTT.RECEIPT_NODE
        AND TT.PRO_CODE NOT LIKE '%TEST%'
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE
  )S WHERE NVL(S.BEGINNING_MONEY,0) !=0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND S.MULTIPLE_MODEL= #{PLATFORM_TYPE}</if>
  )SS
</select>

<select id="getAllCSReceiptMess" parameterType="Map" resultType="Map">
	SELECT S.*,NVL(S.BEGINNING_MONEY,0) INVOICE_AMT,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(T.BEGINNING_RECEIVE_DATA,'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.PAYLIST_CODE,
         TT.PAY_WAY,
         T.BEGINNING_MONEY,
		 GETDICTSITEDATABYCODE('业务类型',TT.MULTIPLE_MODEL) PROJECT_MODEL,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TT.LEASE_CODE,
		 TT.PAY_ID,
		 TT.MULTIPLE_MODEL,
		 TT.SUB_COMPANY_NAME INVOICE_TO_NAME
    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  BA.D_PAY_PROJECT BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.RE_STATUS = 0 AND BA.RED_STATUS = 0 AND BA.D_STATUS=0
              AND (BA.PERIOD = 1 OR BA.PERIOD IS NULL)
              AND BA.D_PAY_PROJECT IN('厂商保证金')
         )W
   LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND ((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD 
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
        SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.RECEIPT_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
     WHERE  TTT.IF_RECEIPT = 1
        AND TT.PROJECT_STATUS >= TTT.RECEIPT_NODE
        AND TT.PRO_CODE NOT LIKE '%TEST%'
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE
  )S WHERE NVL(S.BEGINNING_MONEY,0) !=0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND S.MULTIPLE_MODEL= #{PLATFORM_TYPE}</if>
</select>



<sql id="sjkpColumns"> 
   SELECT distinct CF.FUND_TYPE
       FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF,T_SYS_DATA_DICTIONARY tsdd  
       WHERE HF.ID = CF.RULER_ID  and CF.IF_RECEIPT=1 and tsdd.type='发票_资金别名' and CF.FUND_TYPE=tsdd.flag
</sql>

<select id="sjkpColumnsMaxMoney" resultType="String">
	select 
          WM_CONCAT('MAX(DECODE(T.BEGINNING_NAME,''' || t1.FUND_TYPE || ''',T.BEGINNING_MONEY)) ' || t1.shortname) 
    from (
          SELECT distinct CF.FUND_TYPE,tsdd.shortname
       FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF,T_SYS_DATA_DICTIONARY tsdd  
       WHERE HF.ID = CF.RULER_ID  and CF.IF_RECEIPT=1 and tsdd.type='发票_资金别名' and CF.FUND_TYPE=tsdd.flag
        and CF.FUND_TYPE not in ('首期租金','第一期租金','租前利息','厂商保证金','供应商保证金','担保费'
        
        )
   ) t1 
</select>

<select id="sjkpColumnsTotalMoney" resultType="String">
		select 
		       replace(replace(WM_CONCAT('NVL(' || 'S.' || t1.shortname  || ';0)'),',','+'),';',',')
    from (
          SELECT distinct tsdd.shortname
       FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF,T_SYS_DATA_DICTIONARY tsdd  
       WHERE HF.ID = CF.RULER_ID and CF.IF_RECEIPT=1 and tsdd.type='发票_资金别名' and CF.FUND_TYPE=tsdd.flag
        and CF.FUND_TYPE not in ('首期租金','第一期租金','租前利息','厂商保证金','供应商保证金','担保费'
        
        )
   ) t1 
</select>

<select id="sjkjColumnsAllTitel" resultType="map">
	SELECT distinct CF.FUND_TYPE,upper(tsdd.shortname) shortname
       FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF,T_SYS_DATA_DICTIONARY tsdd  
       WHERE HF.ID = CF.RULER_ID  and CF.IF_RECEIPT=1 and tsdd.type='发票_资金别名' and CF.FUND_TYPE=tsdd.flag
        and CF.FUND_TYPE not in ('首期租金','第一期租金','租前利息','本金','利息','违约金','利息增值税','厂商保证金','供应商保证金','担保费'
        )
</select>
</mapper>