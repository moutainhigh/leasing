<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="dossierBorrow">
   <!-- 档案合同借阅查询 -->
	<select id="doShowDossierBorrowApplyList" parameterType="map"
		resultType="map">
		SELECT FDS.ID,
		FDS.CLIENT_ID,
		CLIENT_NAME,
		PROJECT_CODE,
		PORTFOLIO_NUMBER,
		CABINET_NUMBER,
		PAYLIST_CODE,
		FDS.STATUS,
		TS.FLAG STATUS_NAME,
		FILE_NAME,
		FILE_TYPE,
		DOSSIER_APPLY_ID,
		DOSSIER_COUNT,
		DOSSIER_PAGE,
		FDS.DOSSIER_TEMP,
		TDD.FLAG DOSSIER_TEMP_NAME,
		STORAGE_DATE,
		FDS.DOSSIER_CODE,
		FPH.ID PROJECT_ID
		FROM FIL_DOSSIER_STORAGE FDS,
		FIL_PROJECT_HEAD FPH,
		(SELECT D.CODE, D.FLAG
		FROM T_SYS_DATA_DICTIONARY D
		WHERE D.TYPE = #{F_TYPE}) TDD,
		(SELECT TD.CODE, TD.FLAG
		FROM T_SYS_DATA_DICTIONARY TD
		WHERE TD.TYPE = #{S_TYPE}) TS
		WHERE FDS.STATUS = 0
		AND FDS.PROJECT_CODE=FPH.PRO_CODE(+)
		AND FDS.STATUS = TS.CODE(+)
		AND FDS.DOSSIER_TEMP = TDD.CODE(+)
		AND FDS.CLIENT_ID=#{CLIENT_ID}
		<if test="PROJECT_CODE!=null and PROJECT_CODE!=''">AND FDS.PROJECT_CODE=#{PROJECT_CODE}</if>
		<if test="PROJECT_CODE==null or PROJECT_CODE==''">AND FDS.PROJECT_CODE IS NULL</if>
		<if test="CABINET_NUMBER!=null and CABINET_NUMBER!=''">AND FDS.CABINET_NUMBER=#{CABINET_NUMBER}</if>
	</select>
    <!-- 借阅添加 -->
	<insert id="doAddBorrowApp" parameterType="map">
		INSERT INTO FIL_DOSSIER_BORROWAPP
		(ID,
		DOSSIERINFO,
		BORROWNAME,
		BORROWIDCOARD,
		PREDICTTIME,
		RESTOREPURPOSE,
		FILEPATH,
		BORROWPHONE,
		RECIEVETYPE,
		BORROWADDRESS,
		POSTCODE,
		PROJECT_CODE,
		CLIENT_ID,
		CREATE_CODE,
		CLIENT_NAME,
		FILEPATH_NAME,
		CREATE_DATE)
		VALUES
		(#{ID,jdbcType=VARCHAR},
		#{DOSSIERINFO,jdbcType=VARCHAR},
		#{BORROWNAME,jdbcType=VARCHAR},
		#{BORROWIDCOARD,jdbcType=VARCHAR},
		#{PREDICTTIME,jdbcType=VARCHAR},
		#{RESTOREPURPOSE,jdbcType=VARCHAR},
		#{FILEPATH,jdbcType=VARCHAR},
		#{BORROWPHONE,jdbcType=VARCHAR},
		#{RECIEVETYPE,jdbcType=VARCHAR},
		#{BORROWADDRESS,jdbcType=VARCHAR},
		#{POSTCODE,jdbcType=VARCHAR},
		#{PROJECT_CODE,jdbcType=VARCHAR},
		#{CLIENT_ID,jdbcType=VARCHAR},
		#{CREATE_CODE,jdbcType=VARCHAR},
		#{CLIENT_NAME,jdbcType=VARCHAR},
		#{_FILE_NAME,jdbcType=VARCHAR},
		SYSDATE)
	</insert>
	<select id="doShowBorrowApp" parameterType="string" resultType="map">
		SELECT ID,
		       DOSSIERINFO,
		       BORROWNAME,
		       BORROWIDCOARD,
		       PREDICTTIME,
		       RESTOREPURPOSE,
		       FILEPATH,
		       BORROWPHONE,
		       RECIEVETYPE,
		       BORROWADDRESS,
		       POSTCODE,
		       REMINDHUMANCODE,
		       REMINDREMARK,
		       END_DATE,
		       PROJECT_CODE,
		       CLIENT_ID,
		       TO_CHAR(CREATE_DATE,'YYYY-MM-DD')CREATE_DATE,
		       CREATE_CODE,
		       FILEPATH_NAME,
		       CLIENT_NAME
		  FROM FIL_DOSSIER_BORROWAPP
		  WHERE ID=#{BORROW_APP_ID}
	</select>
	
	<select id="doShowDossierStatus" parameterType="map" resultType="map">
	SELECT F.STATUS,TDD.FLAG DOSSIER_STATUS  FROM FIL_DOSSIER_STORAGE F,
	(SELECT TD.CODE,TD.FLAG FROM T_SYS_DATA_DICTIONARY TD WHERE TD.TYPE=#{_TYPE})TDD
	 WHERE 
	 F.STATUS=TDD.CODE
	 AND
	 F.ID=#{DOSSIERID}
	</select>
	<insert id="doAddBorrowOutInfo" parameterType="map">
	INSERT INTO FIL_DOSSIER_BORROWRESTORE(
	DBRID, 
	DOSSIERNAME, 
	DOSSIERCOUNT, 
	BORROWDATE, 
	INTENDRESTOREDATE, 
	FACTRESTOREDATE, 
	RESTOREPURPOSE, 
	BORROWNAME, 
	BORROWIDCARD, 
	FILEPATH, 
	DOSSIER_BORROWAPPID, 
	CLIENT_ID, 
	PROJECT_CODE, 
	DOSSIERPACKAGECODE, 
	DOSSIERBOXCODE, 
	DOSSIER_STORAGE_ID, 
	BORROWPHONE, 
	RECIEVETYPE, 
	BORROWADDRESS, 
	POSTCODE, 
	FILEPAGE, 
	OPERATOR_CODE, 
	DOSSIERSTATUS, 
	DOSSIER_CODE, 
	DOSSIER_TEMP, 
	PAYLIST_CODE, 
	FILEPATH_NAME
	)
	VALUES(
	SEQ_DOSSIER_BORROWRESTORE.NEXTVAL, 
	#{DOSSIERNAME,jdbcType=VARCHAR}, 
	#{DOSSIERCOUNT,jdbcType=VARCHAR}, 
	SYSDATE, 
	#{INTENDRESTOREDATE,jdbcType=VARCHAR}, 
	#{FACTRESTOREDATE,jdbcType=VARCHAR}, 
	#{RESTOREPURPOSE,jdbcType=VARCHAR}, 
	#{BORROWNAME,jdbcType=VARCHAR}, 
	#{BORROWIDCARD,jdbcType=VARCHAR}, 
	#{FILEPATH,jdbcType=VARCHAR}, 
	#{DOSSIER_BORROWAPPID,jdbcType=VARCHAR}, 
	#{CLIENT_ID,jdbcType=VARCHAR}, 
	#{PROJECT_CODE,jdbcType=VARCHAR}, 
	#{DOSSIERPACKAGECODE,jdbcType=VARCHAR}, 
	#{DOSSIERBOXCODE,jdbcType=VARCHAR}, 
	#{DOSSIER_STORAGE_ID,jdbcType=VARCHAR}, 
	#{BORROWPHONE,jdbcType=VARCHAR}, 
	#{RECIEVETYPE,jdbcType=VARCHAR}, 
	#{BORROWADDRESS,jdbcType=VARCHAR}, 
	#{POSTCODE,jdbcType=VARCHAR}, 
	#{FILEPAGE,jdbcType=VARCHAR}, 
	#{OPERATOR_CODE,jdbcType=VARCHAR}, 
	#{DOSSIERSTATUS,jdbcType=VARCHAR}, 
	#{DOSSIER_CODE,jdbcType=VARCHAR}, 
	#{DOSSIER_TEMP,jdbcType=VARCHAR}, 
	#{PAYLIST_CODE,jdbcType=VARCHAR}, 
	#{FILEPATH_NAME,jdbcType=VARCHAR})
	</insert>
	
	<select id="doShowDossierBorrowedInfo" parameterType="map" resultType="map">
		SELECT FDB.DBRID,
		       FDB.DOSSIERNAME,
		       FDB.DOSSIERCOUNT,
		       FDB.BORROWDATE,
		       FDB.INTENDRESTOREDATE,
		       FDB.FACTRESTOREDATE,
		       FDB.RESTOREPURPOSE,
		       FDB.                    BORROWNAME,
		       FDB.                    BORROWIDCARD,
		       FDB.STATUS,
		       TDD.FLAG                STATUS_NAME,
		       FDS.STATUS              DOSSIER_STATUS,
		       DTD.FLAG                DOSSIER_STATUS_NAME,
		       FDB.FILEPATH,
		       FDB.DOSSIER_BORROWAPPID,
		       FDB.CLIENT_ID,
		       FC.NAME                 CLIENT_NAME,
		       FDB.                    PROJECT_CODE,
		       FDB.DOSSIERPACKAGECODE,
		       FDB.DOSSIERBOXCODE,
		       FDB.DOSSIER_STORAGE_ID,
		       FDB.BORROWPHONE,
		       FDB.                    RECIEVETYPE,
		       FDB.BORROWADDRESS,
		       FDB.POSTCODE,
		       FDB.FILEPAGE,
		       FDB.OPERATOR_CODE,
		       FDB.DOSSIERSTATUS,
		       FDB.DOSSIER_CODE,
		       FDB.DOSSIER_TEMP,
		       FDB.PAYLIST_CODE,
		       FDB.FILEPATH_NAME
		  FROM FIL_DOSSIER_BORROWRESTORE FDB,
		       FIL_DOSSIER_STORAGE FDS,
		       (SELECT T.CODE, T.FLAG
		          FROM T_SYS_DATA_DICTIONARY T
		         WHERE T.TYPE = #{_TYPE}) TDD,
		       (SELECT T.CODE, T.FLAG
		          FROM T_SYS_DATA_DICTIONARY T
		         WHERE T.TYPE = #{_DTYPE}) DTD,
		       FIL_CUST_CLIENT FC
		 WHERE FDB.STATUS = TDD.CODE(+)
		   AND FDB.CLIENT_ID = FC.ID
		   AND FDB.DOSSIER_STORAGE_ID = FDS.ID(+)
		   AND FDS.STATUS = DTD.CODE
		 <if test="DOSSIER_BORROWED_ID!=null and DOSSIER_BORROWED_ID!=''">AND FDB.DBRID={DOSSIER_BORROWED_ID}</if>
		 <if test="BORROW_APP_ID!=null and BORROW_APP_ID!=''">AND FDB.DOSSIER_BORROWAPPID=#{BORROW_APP_ID}</if>
		 <if test="DOSSIER_ID!=null and DOSSIER_ID!=''">AND FDB.DOSSIER_STORAGE_ID=#{DOSSIER_ID}</if>
		 ORDER BY FDB.DBRID
	</select>
	
	<update id="updateDossierBorrowStatusById" parameterType="map">
		UPDATE FIL_DOSSIER_BORROWRESTORE SET STATUS=#{STATUS},FACTRESTOREDATE=SYSDATE WHERE DBRID=#{DOSSIER_BORROWED_ID}
	</update>
	
	<update id="doUpdateBorrowAppSave" parameterType="map">
		UPDATE FIL_DOSSIER_BORROWAPP SET 
		<if test="DOSSIERINFO!=null and DOSSIERINFO!=''">DOSSIERINFO=#{DOSSIERINFO},</if> 
		BORROWNAME=#{BORROWNAME,jdbcType=VARCHAR}, 
		BORROWIDCOARD=#{BORROWIDCOARD,jdbcType=VARCHAR}, 
		PREDICTTIME=#{PREDICTTIME,jdbcType=VARCHAR},
		RESTOREPURPOSE=#{ RESTOREPURPOSE,jdbcType=VARCHAR},
		FILEPATH=#{FILEPATH,jdbcType=VARCHAR},
		BORROWPHONE=#{BORROWPHONE,jdbcType=VARCHAR},
		RECIEVETYPE=#{RECIEVETYPE,jdbcType=VARCHAR},
		BORROWADDRESS=#{BORROWADDRESS,jdbcType=VARCHAR},
		POSTCODE=#{POSTCODE,jdbcType=VARCHAR},
		REMINDHUMANCODE=#{REMINDHUMANCODE ,jdbcType=VARCHAR},
		REMINDREMARK=#{REMINDREMARK,jdbcType=VARCHAR},
		END_DATE=#{END_DATE,jdbcType=VARCHAR},
		PROJECT_CODE=#{PROJECT_CODE,jdbcType=VARCHAR},
		CLIENT_ID=#{CLIENT_ID,jdbcType=VARCHAR},
		CLIENT_NAME=#{CLIENT_NAME,jdbcType=VARCHAR},
		FILEPATH_NAME=#{FILEPATH_NAME,jdbcType=VARCHAR}
		WHERE ID=#{BORROWID}
	</update>
</mapper>