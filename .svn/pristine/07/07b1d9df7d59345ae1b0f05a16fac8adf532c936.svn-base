<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="projectContractControlManager">
     <select id="getAllProjectControlData" parameterType="map"
		resultType="map">
		SELECT
		CASE WHEN FPH.LEASE_MODEL='BACK_LEASING' AND FPH.PLATFORM_TYPE ='4' THEN
		FPH.PARENT_ID
		ELSE FPH.ID END AS ID,
		FPH.PARENT_ID,
		TSDD1.FLAG STATUS_NAME,FPH.PRO_CODE,FCL.NAME
		CUST_NAME,FPH.COMPANY_NAME,FPH.SUP_SHORTNAME SUP_NAME,
		TO_CHAR(FPH.CREATE_TIME,'YYYY-MM-DD') CREATE_TIME,TSDD.FLAG
		PLATFORM_NAME, FCL.TYPE CUST_TYPE,FPH.ZKL,
		FPH.CLERK_NAME,FPH.PLATFORM_TYPE,TSDD2.FLAG
		CUST_TYPE_NAME,FPH.STATUS,FCL.ID CUST_ID,FPH.LEASE_CODE,
		--TTT.NAME_ LCNAME,
		TTT.IS_READ,
		(SELECT 1 FROM FIL_PROJECT_HEAD FPH1 WHERE FPH1.PARENT_ID=FPH.ID AND
		FPH1.LEASE_MODEL='BACK_LEASING' AND FPH.PLATFORM_TYPE ='4' ) AS
		ADD_PROJECT,
		TSDD1.FLAG AS LC_STATUS,
		TTT.NAME_ AS LCNAME,
		TTT.ID_ TTT_ID,TTT.JM_ID
		FROM FIL_PROJECT_HEAD FPH
		LEFT JOIN FIL_CUST_CLIENT FCL ON FPH.CLIENT_ID=FCL.ID
		LEFT JOIN T_SYS_SITE_DICTIONARY TSDD ON FPH.PLATFORM_TYPE=TSDD.CODE AND
		TSDD.TYPE=#{tags1}
		LEFT JOIN T_SYS_SITE_DICTIONARY TSDD1 ON FPH.STATUS=TSDD1.CODE AND
		TSDD1.TYPE=#{tags2}
		LEFT JOIN T_SYS_DATA_DICTIONARY TSDD2 ON FCL.TYPE=TSDD2.CODE AND
		TSDD2.TYPE=#{tags3}
		LEFT JOIN (SELECT
		JBPM4_TASK.EXECUTION_ID_,JBPM4_TASK.NAME_,JBPM4_HIST_PROCINST.PROJECT_ID,JBPM4_HIST_PROCINST.ID_,
		JM.ID JM_ID
		,JBPM4_HIST_PROCINST.IS_READ
		FROM JBPM4_TASK
		JOIN JBPM4_HIST_PROCINST
		ON JBPM4_TASK.EXECUTION_ID_ || '.'  LIKE  JBPM4_HIST_PROCINST.ID_|| '.%'
		LEFT JOIN (SELECT M.JBPM_ID,MAX(M.ID)ID FROM JBPM_MEMO M GROUP BY
		M.JBPM_ID) JM
		ON JM.JBPM_ID=JBPM4_HIST_PROCINST.ID_
		) TTT
		ON TTT.ID_ = FPH.JBPM_ID  WHERE FPH.ID=557481
		ORDER BY FPH.ID DESC
	</select>
		
		
    <select id="getAllProjectControlDataCount" parameterType="map"
		resultType="int">
		SELECT COUNT(1)
		FROM FIL_PROJECT_HEAD FPH
		LEFT JOIN FIL_CUST_CLIENT FCL
		ON FPH.CLIENT_ID=FCL.ID
		WHERE FPH.ID=557481
	</select>
	
	<insert id="addProjectControlFileContext">
	      <if test="num != 0">
		   	 <foreach collection="list" item="item" index="index" >  
             INSERT INTO T_SHANGCHUANWENJIAN(
				ID
				,FILE_NAME 
				,FILE_PATH 
				,PROJECT_ID
				,UPLOAD_DATE
				,FILE_SIZE
				,SCOPETYPE
			 )VALUES
			
	            (SEQ_SHANGCHUANWENJIAN.NEXTVAL
				,#{item.FILE_NAME}
				,#{item.FILE_PATH}
				,#{PROJECT_ID}
				,sysdate
				,#{item.FILE_SIZE}
				,2
				)
	         </foreach>  
		   </if>
	</insert>
	
	<select id="queryProjectControlFileContext" parameterType="map"
		resultType="map">
		 SELECT ID, 
		 FILE_NAME, 
		 FILE_PATH, 
		 PROJECT_ID,
		 TO_CHAR(UPLOAD_DATE, 'YYYY-MM-DD') UPLOAD_DATE,
		 FILE_SIZE FROM T_SHANGCHUANWENJIAN 
		 WHERE SCOPETYPE=2 AND PROJECT_ID=#{PROJECT_ID}
	</select>
	
</mapper>