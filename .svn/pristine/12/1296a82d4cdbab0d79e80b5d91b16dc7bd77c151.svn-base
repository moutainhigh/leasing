<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="OtherInvoice">
<!-- 增值税留购价款申请界面 -->
<select id="getVatOtherApplyList" parameterType="Map" resultType="Map">
SELECT * FROM (
SELECT S.*,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(T.BEGINNING_RECEIVE_DATA,'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         TO_CHAR(T.BEGINNING_PLAN_DATE,'YYYY-MM-DD') BEGINNING_PLAN_DATE,
         T.BEGINNING_NUM,
         T.ITEM_FLAG,
         T.PAYLIST_CODE,
         T.BEGINNING_NAME,
         T.BEGINNING_MONEY,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TT.SUP_SHORTNAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TTT.MERGE_NAME,
         TTT.SHOW_NODE,
         <if test="LEAVING != null and LEAVING !=''">BPE.REMARK,</if>
         T.INVOICE_TARGET_ID,
         T.INVOICE_TARGET_TYPE 
    FROM ( SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_PLAN_DATE,
           W.BEGINNING_NAME,
           W.INVOICE_TARGET_ID,
           W.INVOICE_TARGET_TYPE,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,
                  CASE WHEN BA.D_PAY_PROJECT='回购留购价款' THEN '留购价款' ELSE BA.D_PAY_PROJECT END BEGINNING_NAME,
                  BA.D_RECEIVE_DATE BEGINNING_PLAN_DATE,
                  BA.INVOICE_TARGET_ID,BA.INVOICE_TARGET_TYPE,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.D_STATUS =0 AND BA.RED_STATUS = 0 AND BA.RE_STATUS = 0
              <if test="BEGINNING_NAMES != null">
		        AND BA.D_PAY_PROJECT IN  <foreach collection="BEGINNING_NAMES" close=")" open="(" separator="," item="item">#{item}</foreach>
		      </if>
         )W
    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.TARGET_TYPE,DE.TARGET_ID,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                 FROM FI_SALEITEM_INVOICE SI,FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE= '增值税发票'
               )WW
           ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
          AND W.INVOICE_TARGET_TYPE = WW.TARGET_TYPE
          AND W.INVOICE_TARGET_ID = WW.TARGET_ID 
          AND W.BEGINNING_NAME = WW.ITEM_NAME
        WHERE WW.SALEITEM_INVOICE_ID IS NULL
          AND W.INVOICE_TARGET_ID IS NOT NULL
          AND W.INVOICE_TARGET_TYPE IS NOT NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 CL.NAME CLIENT_NAME,
                 V.START_CONFIRM_DATE CONFIRM_DATE_START,
                 V.START_CONFIRM_DATE CONFIRM_DATE_END,
                 getDictShortnameByCode('发票_租赁模式',HE.PLATFORM_TYPE) LEASING_MODEL,
                 HE.PROJECT_MODEL MULTIPLE_MODEL,
                 HE.INVOICE_METHOD IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.STATUS RENT_STATUS,
                 SU.SUP_SHORTNAME,
                 CASE WHEN GETDICTDATABYCODE('牌抵挂',HE.PLEDGE_STATUS)='不上牌' THEN '不上牌' ELSE '上牌' END ON_CARD   
          FROM  FIL_RENT_PLAN_HEAD_MAX_V V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
		        T_SYS_SUPPLIERS SU
		  WHERE V.PROJECT_ID =HE.ID
		        AND HE.CLIENT_ID = CL.ID
		        AND HE.SUP_ID = SU.SUP_ID
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
       SELECT HF.*,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
      <if test="LEAVING != null and LEAVING !=''">INNER JOIN VI_BASE_PROJ_END BPE ON BPE.PAYLIST_CODE = TT.PAYLIST_CODE</if> 
      WHERE TT.CONFIRM_DATE_START >= TO_DATE('2012-09-01','YYYY-MM-DD')  
      <if test="LEAVING != null and LEAVING !=''">AND TT.PROJECT_STATUS IN (30,35,40)</if>
        AND TT.PROJECT_STATUS >= TTT.SHOW_NODE  
		AND TT.IS_INVOICE_MONTH = '按月开具'        
        AND TT.PRO_CODE NOT LIKE '%TEST%'
   ORDER BY nlssort(TT.SUP_SHORTNAME,'NLS_SORT=SCHINESE_PINYIN_M'),nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE
  )S WHERE 1=1
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  AND <![CDATA[ROWNUM <= #{PAGE_END}]]>
  ORDER BY S.BEGINNING_NUM  )SS  WHERE SS.ROWNO >= #{PAGE_BEGIN}  
</select>

<select id="getVatOtherApplyCount" parameterType="Map" resultType="Int"> 
  SELECT COUNT(1)
    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.INVOICE_TARGET_ID,
           W.INVOICE_TARGET_TYPE,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  CASE WHEN BA.D_PAY_PROJECT='回购留购价款' THEN '留购价款' ELSE BA.D_PAY_PROJECT END BEGINNING_NAME,
                  BA.INVOICE_TARGET_ID,BA.INVOICE_TARGET_TYPE,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.D_STATUS =0 AND BA.RED_STATUS = 0 AND BA.RE_STATUS = 0
              <if test="BEGINNING_NAMES != null">
		        AND BA.D_PAY_PROJECT IN  <foreach collection="BEGINNING_NAMES" close=")" open="(" separator="," item="item">#{item}</foreach>
		      </if>
         )W
    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.TARGET_TYPE,DE.TARGET_ID,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                 FROM FI_SALEITEM_INVOICE SI,FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE= '增值税发票'
               )WW
           ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
          AND W.INVOICE_TARGET_TYPE = WW.TARGET_TYPE
          AND W.INVOICE_TARGET_ID = WW.TARGET_ID 
          AND W.BEGINNING_NAME = WW.ITEM_NAME
        WHERE WW.SALEITEM_INVOICE_ID IS NULL
          AND W.INVOICE_TARGET_ID IS NOT NULL
          AND W.INVOICE_TARGET_TYPE IS NOT NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 CL.NAME CLIENT_NAME,
                 V.START_CONFIRM_DATE CONFIRM_DATE_START,
                 V.START_CONFIRM_DATE CONFIRM_DATE_END,
                 getDictShortnameByCode('发票_租赁模式',HE.PLATFORM_TYPE) LEASING_MODEL,
                 HE.PROJECT_MODEL MULTIPLE_MODEL,
                 HE.INVOICE_METHOD IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 SU.SUP_SHORTNAME,
                 CASE WHEN GETDICTDATABYCODE('牌抵挂',HE.PLEDGE_STATUS)='不上牌' THEN '不上牌' ELSE '上牌' END ON_CARD 
          FROM  FIL_RENT_PLAN_HEAD_MAX_V V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
		        T_SYS_SUPPLIERS SU
		  WHERE V.PROJECT_ID =HE.ID
		        AND HE.CLIENT_ID = CL.ID
		        AND HE.SUP_ID = SU.SUP_ID
     )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
       SELECT HF.*,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
      <if test="LEAVING != null and LEAVING !=''">INNER JOIN VI_BASE_PROJ_END BPE ON BPE.PAYLIST_CODE = TT.PAYLIST_CODE</if> 
      WHERE TT.CONFIRM_DATE_START >= TO_DATE('2012-09-01','YYYY-MM-DD')
      <if test="LEAVING != null and LEAVING !=''">AND TT.PROJECT_STATUS IN (30,35,40)</if> 
        AND TT.PROJECT_STATUS >= TTT.SHOW_NODE 
        AND TT.IS_INVOICE_MONTH = '按月开具'        
        AND TT.PRO_CODE NOT LIKE '%TEST%'
  <if test="START_TIME !=null and START_TIME !=''">AND TT.CONFIRM_DATE_START >= TO_DATE(#{START_TIME},'YYYY-MM-DD')</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[TT.CONFIRM_DATE_START <= TO_DATE(#{STOP_TIME},'YYYY-MM-DD')]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND T.BEGINNING_RECEIVE_DATA >= TO_DATE(#{BEGIN_TIME},'YYYY-MM-DD')</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[T.BEGINNING_RECEIVE_DATA <= TO_DATE(#{END_TIME},'YYYY-MM-DD')]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND TT.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND TT.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND TT.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND TT.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND TT.ON_CARD = #{ON_CARD}</if>
</select>

<!-- 营业税留购价款申请界面 -->
<select id="getBusTaxOtherApplyList" parameterType="Map" resultType="Map">
SELECT * FROM (
SELECT S.*,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(T.BEGINNING_RECEIVE_DATA,'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         TO_CHAR(T.BEGINNING_PLAN_DATE,'YYYY-MM-DD') BEGINNING_PLAN_DATE,
         T.BEGINNING_NUM,
         T.ITEM_FLAG,
         T.PAYLIST_CODE,
         T.BEGINNING_NAME,
         T.BEGINNING_MONEY,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TT.SUP_SHORTNAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TTT.MERGE_NAME,
         TTT.SHOW_NODE,
         <if test="LEAVING != null and LEAVING !=''">BPE.REMARK,</if>
         T.INVOICE_TARGET_ID,
         T.INVOICE_TARGET_TYPE  
    FROM ( SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_PLAN_DATE,
           W.BEGINNING_NAME,
           W.INVOICE_TARGET_ID,
           W.INVOICE_TARGET_TYPE,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  CASE WHEN BA.D_PAY_PROJECT='回购留购价款' THEN '留购价款' ELSE BA.D_PAY_PROJECT END BEGINNING_NAME,
                  BA.D_RECEIVE_DATE BEGINNING_PLAN_DATE,
                  BA.INVOICE_TARGET_ID,BA.INVOICE_TARGET_TYPE,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.D_STATUS =0 AND BA.RED_STATUS = 0 AND BA.RE_STATUS = 0
              <if test="BEGINNING_NAMES != null">
		        AND BA.D_PAY_PROJECT IN  <foreach collection="BEGINNING_NAMES" close=")" open="(" separator="," item="item">#{item}</foreach>
		      </if>
         )W
    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.TARGET_TYPE,DE.TARGET_ID,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                 FROM FI_SALEITEM_INVOICE SI,FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE= '营业税发票'
               )WW
           ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
          AND W.INVOICE_TARGET_TYPE = WW.TARGET_TYPE
          AND W.INVOICE_TARGET_ID = WW.TARGET_ID 
          AND W.BEGINNING_NAME = WW.ITEM_NAME
          WHERE WW.SALEITEM_INVOICE_ID IS NULL 
          AND W.INVOICE_TARGET_ID IS NOT NULL
          AND W.INVOICE_TARGET_TYPE IS NOT NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 CL.NAME CLIENT_NAME,
                 HE.STATUS PROJECT_STATUS,
                 V.START_CONFIRM_DATE CONFIRM_DATE_START,
                 V.START_CONFIRM_DATE CONFIRM_DATE_END,
                 getDictShortnameByCode('发票_租赁模式',HE.PLATFORM_TYPE) LEASING_MODEL,
                 HE.PROJECT_MODEL MULTIPLE_MODEL,
                 HE.INVOICE_METHOD IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 SU.SUP_SHORTNAME,
                 CASE WHEN GETDICTDATABYCODE('牌抵挂',HE.PLEDGE_STATUS)='不上牌' THEN '不上牌' ELSE '上牌' END ON_CARD 
          FROM  FIL_RENT_PLAN_HEAD_MAX_V V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
		        T_SYS_SUPPLIERS SU
		  WHERE V.PROJECT_ID =HE.ID
		        AND HE.CLIENT_ID = CL.ID
		        AND HE.SUP_ID = SU.SUP_ID
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
       SELECT HF.*,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
      <if test="LEAVING != null and LEAVING !=''">INNER JOIN VI_BASE_PROJ_END BPE ON BPE.PAYLIST_CODE = TT.PAYLIST_CODE</if> 
      WHERE <![CDATA[TT.CONFIRM_DATE_START < TO_DATE('2012-09-01','YYYY-MM-DD')]]>
      <if test="LEAVING != null and LEAVING !=''">AND TT.PROJECT_STATUS IN (30,35,40)</if>
        AND TT.PROJECT_STATUS >= TTT.SHOW_NODE 
        AND TT.IS_INVOICE_MONTH = '按月开具'        
        AND TT.PRO_CODE NOT LIKE '%TEST%'
   ORDER BY nlssort(TT.SUP_SHORTNAME,'NLS_SORT=SCHINESE_PINYIN_M'), nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE
  )S WHERE 1=1
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  AND <![CDATA[ROWNUM <= #{PAGE_END}]]>
  ORDER BY S.BEGINNING_NUM  )SS  WHERE SS.ROWNO >= #{PAGE_BEGIN} 
</select>

<select id="getBusTaxOtherApplyCount" parameterType="Map" resultType="Int">
 SELECT COUNT(1)
    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.INVOICE_TARGET_ID,
           W.INVOICE_TARGET_TYPE,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  CASE WHEN BA.D_PAY_PROJECT='回购留购价款' THEN '留购价款' ELSE BA.D_PAY_PROJECT END BEGINNING_NAME,
                  BA.INVOICE_TARGET_ID,BA.INVOICE_TARGET_TYPE,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.D_STATUS =0 AND BA.RED_STATUS = 0 AND BA.RE_STATUS = 0
              <if test="BEGINNING_NAMES != null">
		        AND BA.D_PAY_PROJECT IN  <foreach collection="BEGINNING_NAMES" close=")" open="(" separator="," item="item">#{item}</foreach>
		      </if>
         )W
    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.TARGET_TYPE,DE.TARGET_ID,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                 FROM FI_SALEITEM_INVOICE SI,FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE= '营业税发票'
               )WW
           ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
          AND W.INVOICE_TARGET_TYPE = WW.TARGET_TYPE
          AND W.INVOICE_TARGET_ID = WW.TARGET_ID 
          AND W.BEGINNING_NAME = WW.ITEM_NAME
        WHERE WW.SALEITEM_INVOICE_ID IS NULL
          AND W.INVOICE_TARGET_ID IS NOT NULL
          AND W.INVOICE_TARGET_TYPE IS NOT NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 CL.NAME CLIENT_NAME,
                 V.START_CONFIRM_DATE CONFIRM_DATE_START,
                 V.START_CONFIRM_DATE CONFIRM_DATE_END,
                 getDictShortnameByCode('发票_租赁模式',HE.PLATFORM_TYPE) LEASING_MODEL,
                 HE.PROJECT_MODEL MULTIPLE_MODEL,
                 HE.INVOICE_METHOD IS_INVOICE_MONTH,
                 SU.SUP_SHORTNAME,
                 V.PAYLIST_CODE,
                 CASE WHEN GETDICTDATABYCODE('牌抵挂',HE.PLEDGE_STATUS)='不上牌' THEN '不上牌' ELSE '上牌' END ON_CARD 
          FROM  FIL_RENT_PLAN_HEAD_MAX_V V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
		        T_SYS_SUPPLIERS SU
		  WHERE V.PROJECT_ID =HE.ID
		        AND HE.CLIENT_ID = CL.ID
		        AND HE.SUP_ID = SU.SUP_ID
     )TT ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
       SELECT HF.*,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
      <if test="LEAVING != null and LEAVING !=''">INNER JOIN VI_BASE_PROJ_END BPE ON BPE.PAYLIST_CODE = TT.PAYLIST_CODE</if> 
   WHERE <![CDATA[TT.CONFIRM_DATE_START < TO_DATE('2012-09-01','YYYY-MM-DD')]]>
   <if test="LEAVING != null and LEAVING !=''">AND TT.PROJECT_STATUS IN (30,35,40)</if>
     AND TT.PROJECT_STATUS >= TTT.SHOW_NODE 
     AND TT.IS_INVOICE_MONTH = '按月开具'        
     AND TT.PRO_CODE NOT LIKE '%TEST%'
   <if test="START_TIME !=null and START_TIME !=''">AND TT.CONFIRM_DATE_START >= TO_DATE(#{START_TIME},'YYYY-MM-DD')</if>
   <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[TT.CONFIRM_DATE_START <= TO_DATE(#{STOP_TIME},'YYYY-MM-DD')]]></if>
   <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND T.BEGINNING_RECEIVE_DATA >= TO_DATE(#{BEGIN_TIME},'YYYY-MM-DD')</if>
   <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[T.BEGINNING_RECEIVE_DATA <= TO_DATE(#{END_TIME},'YYYY-MM-DD')]]></if>
   <if test="PRO_CODE !=null and PRO_CODE !=''">AND TT.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
   <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND TT.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
   <if test="PRO_NAME !=null and PRO_NAME !=''">AND TT.PRO_NAME LIKE '%${PRO_NAME}%'</if>
   <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND TT.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
   <if test="ON_CARD != null and ON_CARD !=''">AND TT.ON_CARD = #{ON_CARD}</if>
</select>

<select id="getAllOtherInvoiceMess" parameterType="Map" resultType="Map">
SELECT S.*,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(T.BEGINNING_RECEIVE_DATA,'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         TO_CHAR(T.BEGINNING_PLAN_DATE,'YYYY-MM-DD') BEGINNING_PLAN_DATE,
         T.BEGINNING_NUM,
         T.ITEM_FLAG,
         T.PAYLIST_CODE,
         T.BEGINNING_NAME FUND_NAME,
         T.BEGINNING_MONEY INVOICE_AMT,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TT.SUP_SHORTNAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TTT.MERGE_NAME,
         TTT.SHOW_NODE,
         <if test="LEAVING != null and LEAVING !=''">BPE.REMARK,</if>
         T.INVOICE_TARGET_ID TARGET_ID,
         T.INVOICE_TARGET_TYPE TARGET_TYPE
    FROM ( SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_PLAN_DATE,
           W.BEGINNING_NAME,
           W.INVOICE_TARGET_ID,
           W.INVOICE_TARGET_TYPE,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,
                  CASE WHEN BA.D_PAY_PROJECT='回购留购价款' THEN '留购价款' ELSE BA.D_PAY_PROJECT END BEGINNING_NAME,
                  BA.D_RECEIVE_DATE BEGINNING_PLAN_DATE,
                  BA.INVOICE_TARGET_ID,BA.INVOICE_TARGET_TYPE,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.D_STATUS =0 AND BA.RED_STATUS = 0 AND BA.RE_STATUS = 0
              <if test="BEGINNING_NAMES != null">
		        AND BA.D_PAY_PROJECT IN  <foreach collection="BEGINNING_NAMES" close=")" open="(" separator="," item="item">#{item}</foreach>
		      </if>
         )W
    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.TARGET_TYPE,DE.TARGET_ID,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                 FROM FI_SALEITEM_INVOICE SI,FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 
                AND SI.INVOICE_TYPE= #{INVOICE_TYPE}
               )WW
           ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
          AND W.INVOICE_TARGET_TYPE = WW.TARGET_TYPE
          AND W.INVOICE_TARGET_ID = WW.TARGET_ID 
          AND W.BEGINNING_NAME = WW.ITEM_NAME
        WHERE WW.SALEITEM_INVOICE_ID IS NULL
          AND W.INVOICE_TARGET_ID IS NOT NULL
          AND W.INVOICE_TARGET_TYPE IS NOT NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 CL.NAME CLIENT_NAME,
                 V.START_CONFIRM_DATE CONFIRM_DATE_START,
                 V.START_CONFIRM_DATE CONFIRM_DATE_END,
                 getDictShortnameByCode('发票_租赁模式',HE.PLATFORM_TYPE) LEASING_MODEL,
                 HE.PROJECT_MODEL MULTIPLE_MODEL,
                 HE.INVOICE_METHOD IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.STATUS RENT_STATUS,
                 SU.SUP_SHORTNAME,
                 CASE WHEN GETDICTDATABYCODE('牌抵挂',HE.PLEDGE_STATUS)='不上牌' THEN '不上牌' ELSE '上牌' END ON_CARD 
          FROM  FIL_RENT_PLAN_HEAD_MAX_V V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
		        T_SYS_SUPPLIERS SU
		  WHERE V.PROJECT_ID =HE.ID
		        AND HE.CLIENT_ID = CL.ID
		        AND HE.SUP_ID = SU.SUP_ID
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
       SELECT HF.*,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
      <if test="LEAVING != null and LEAVING !=''">INNER JOIN VI_BASE_PROJ_END BPE ON BPE.PAYLIST_CODE = TT.PAYLIST_CODE</if> 
      WHERE TT.PROJECT_STATUS >= TTT.SHOW_NODE
      <if test="VAT_FLAG !=null and VAT_FLAG !=''">AND TT.CONFIRM_DATE_START >= TO_DATE('2012-09-01','YYYY-MM-DD')</if>  
      <if test="BUS_FLAG !=null and BUS_FLAG !=''">AND <![CDATA[TT.CONFIRM_DATE_START <=TO_DATE('2012-09-01','YYYY-MM-DD')]]></if> 
      <if test="LEAVING != null and LEAVING !=''">AND TT.PROJECT_STATUS IN (30,35,40)</if>
		AND TT.IS_INVOICE_MONTH = '按月开具'        
        AND TT.PRO_CODE NOT LIKE '%TEST%'
   ORDER BY nlssort(TT.SUP_SHORTNAME,'NLS_SORT=SCHINESE_PINYIN_M'),nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE
  )S
  <where>
	  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
	  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
	  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
	  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
	  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
	  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
	  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
	  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
	  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  </where> 
</select>

</mapper> 