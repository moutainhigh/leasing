<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="dossierManager">

	<sql id="doShowDossierManager_comm">
			FROM FIL_PROJECT_HEAD FPH,
	               FIL_CUST_CLIENT FCC,
	               (SELECT code, flag as platform_type_name FROM t_sys_site_dictionary WHERE status!=-2 and type=#{YEWU_TYPE}) YEWU,
	               (SELECT F.CLIENT_ID,
	               		   F.CLIENT_NAME,
	                       <if test="DOSSIER_TYPE_FLAG==1">
	                       F.PROJECT_CODE,
	                       F.PAYLIST_CODE,
	                       </if>
	                       F.PORTFOLIO_NUMBER,
	                       F.CABINET_NUMBER,
	                       F.FILE_TYPE,
	                       MAX(F.STATUS)STATUS,
                              MAX(F.CREATE_DATE)CREATE_DATE
	                  FROM FIL_DOSSIER_STORAGE F
	                  WHERE F.FILE_TYPE=(SELECT SHORTNAME FROM T_SYS_SITE_DICTIONARY WHERE STATUS!=-2 AND TYPE=#{_TYPE}  AND FLAG=#{DOSSIER_TYPE} ) 
                         <if test="DOSSIER_TYPE_FLAG!=1">AND F.PROJECT_CODE IS NULL</if>
	           		  <if test="DOSSIER_TYPE_FLAG==1">AND F.PROJECT_CODE IS NOT NULL</if>
	                 GROUP BY F.CLIENT_ID,
	                 	      F.CLIENT_NAME,
	                          <if test="DOSSIER_TYPE_FLAG==1">
	                          F.PROJECT_CODE,
	                          F.PAYLIST_CODE,
	                          </if>
	                          F.PORTFOLIO_NUMBER,
	                          F.CABINET_NUMBER,
	                          F.FILE_TYPE
	                          ) FDS
	         WHERE FPH.CLIENT_ID = FCC.ID
		           AND FPH.PLATFORM_TYPE = YEWU.CODE(+)
<!-- 		           AND FPH.BUSINESS_SECTOR = SWBK.CODE(+) -->
		           <if test="DOSSIER_TYPE_FLAG!=1">AND FPH.CLIENT_ID=FDS.CLIENT_ID(+)</if>
		           <if test="DOSSIER_TYPE_FLAG==1">AND FPH.LEASE_CODE = FDS.PROJECT_CODE(+)</if>
		           AND FPH.STATUS >= 20
		           <if test="SUPPLIER_NAMES!=null and SUPPLIER_NAMES!=''">AND FPH.SUP_SHORTNAME LIKE '%'||#{SUPPLIER_NAMES}||'%'</if>
		           <if test="CABINET_NUMBER!=null and CABINET_NUMBER!=''">AND FDS.CABINET_NUMBER LIKE '%'||#{CABINET_NUMBER}||'%'</if>
		           <if test="PORTFOLIO_NUMBER!=null and PORTFOLIO_NUMBER!=''">AND FDS.PORTFOLIO_NUMBER LIKE '%'||#{PORTFOLIO_NUMBER}||'%'</if>
		           <if test="CLIENT_NAME!=null and CLIENT_NAME!=''">AND FCC.NAME LIKE '%'||#{CLIENT_NAME}||'%'</if>
<!-- 		           <if test="BUSINESS_PLATE!=null and BUSINESS_PLATE!=''">AND SWBK.TPM_BUSINESS_PLATE=#{BUSINESS_PLATE}</if> -->
			           <if test="PLATFORM_TYPE_NAME!=null and PLATFORM_TYPE_NAME!=''">AND YEWU.CODE=#{PLATFORM_TYPE_NAME}</if>
			           <if test="PROJECT_CODE!=null and PROJECT_CODE!=''">AND FPH.LEASE_CODE LIKE '%'||#{PROJECT_CODE}||'%'</if>
           <if test="DOSSIER_TYPE_FLAG!=1">
           GROUP BY 
           			FCC.NAME,
		          FPH.CLIENT_ID,
		          FDS.CLIENT_NAME,
		          FPH.PLATFORM_TYPE,
		          YEWU.PLATFORM_TYPE_NAME,
		<!-- 	  SWBK.TPM_BUSINESS_PLATE, -->
		          FDS.PORTFOLIO_NUMBER,
		          FDS.CABINET_NUMBER,
		          FPH.SUP_SHORTNAME
       	  </if>
	</sql>
	<select id="doShowDossierManagerList" parameterType="map" resultType="map">
		SELECT TT.* FROM (SELECT T.*,ROWNUM RN FROM (
			SELECT 
		  			<if test="DOSSIER_TYPE_FLAG==1">
		  			   FPH.LEASE_CODE            
		  			   PROJECT_CODE,
		  			   FPH.ID PROJECT_ID,
		  			   FDS.STATUS,
		  			</if>
		  			<if test="DOSSIER_TYPE_FLAG!=1">
		  				MAX(FDS.STATUS)STATUS,
		  			</if>
		  			   CASE WHEN FDS.CLIENT_NAME IS NOT NULL THEN FDS.CLIENT_NAME ELSE FCC.NAME END CLIENT_NAME,
		               FPH.CLIENT_ID,
		               FPH.PLATFORM_TYPE,
		               YEWU.PLATFORM_TYPE_NAME,
<!-- 		               SWBK.TPM_BUSINESS_PLATE, -->
		               FDS.PORTFOLIO_NUMBER,
		               FDS.CABINET_NUMBER,
		              
		               FPH.SUP_SHORTNAME SUPPLIER_NAMES
	         <include refid="doShowDossierManager_comm"/>
	        <if test="DOSSIER_TYPE_FLAG==1">
	        	ORDER BY FDS.STATUS DESC NULLS LAST , FDS.CREATE_DATE DESC 
	        </if>
       	) T)TT WHERE 
       				TT.RN BETWEEN #{PAGE_BEGIN}  AND #{PAGE_END}
	</select>
	
	<select id="doShowDossierManagerListCount" parameterType="map" resultType="int">
		SELECT COUNT(1) <include refid="doShowDossierManager_comm"/>
	</select>
	
	<select id="doShowDetailList" parameterType="map" resultType="map">
		SELECT FDS.ID,FDS.CLIENT_ID,FDS.PORTFOLIO_NUMBER,FDS.FILE_TYPE,
			   FDS.PROJECT_CODE,
		       FDS.CABINET_NUMBER,
		       FDS.PAYLIST_CODE,
		       FDS.STATUS,
		       DS.FLAG STATUS_NAME,
		       FDS.FILE_NAME,
		       TO_CHAR(STORAGE_DATE,'YYYY-MM-DD')STORAGE_DATE,
		       FDS.DOSSIER_COUNT,
		       FDS.DOSSIER_PAGE,
		       FDS.DOSSIER_TEMP,
		       (CASE WHEN FDS.DOSSIER_TEMP=1 THEN '原件' ELSE '复印件' END)DOSSIER_TEMP_NAME,
		       FDS.CLIENT_NAME,
			   FCC.CUST_ID,
  	      FDS.DOSSIER_FILE_TYPE 
		  FROM FIL_DOSSIER_STORAGE FDS,
	      (SELECT
	      TDD.CODE,
	      TDD.FLAG
	      FROM T_SYS_DATA_DICTIONARY TDD WHERE TDD.TYPE=#{DOSSIER_STATUS}) DS,
		  FIL_CUST_CLIENT FCC
		  WHERE
		  FDS.STATUS=DS.CODE(+)
      	  AND
		  FDS.CLIENT_ID = FCC.ID
		  AND
		  FDS.FILE_TYPE=(SELECT
                          TDD.SHORTNAME
                          FROM T_SYS_DATA_DICTIONARY TDD WHERE TDD.TYPE=#{_TYPE} AND TDD.FLAG=#{DOSSIER_TYPE})
			<if test="PROJECT_CODE!=null and PROJECT_CODE!=''">AND FDS.PROJECT_CODE=#{PROJECT_CODE}</if>
			<if test="PORTFOLIO_NUMBER!=null and PORTFOLIO_NUMBER!=''">AND FDS.PORTFOLIO_NUMBER=#{PORTFOLIO_NUMBER}</if>
			<if test="CABINET_NUMBER!=null and CABINET_NUMBER!=''">AND FDS.CABINET_NUMBER=#{CABINET_NUMBER}</if>            
			<if test="CLIENT_NAME!=null and CLIENT_NAME!=''">AND FDS.CLIENT_NAME=#{CLIENT_NAME}</if>            
		 GROUP BY FDS.ID,
		 		  FDS.PORTFOLIO_NUMBER,
				  FDS.FILE_TYPE,
				  FDS.CLIENT_ID,
		          FDS.CABINET_NUMBER,
		          FDS.PAYLIST_CODE,
		          FDS.STATUS,
		          FDS.PROJECT_CODE,
		          FDS.FILE_NAME,
		          FDS.STORAGE_DATE,
		          FDS.DOSSIER_COUNT,
		          FDS.DOSSIER_PAGE,
		          FDS.DOSSIER_TEMP,
		          FDS.CLIENT_NAME,
		          DS.FLAG,
				  FCC.CUST_ID,
			   	  FDS.DOSSIER_FILE_TYPE
		 ORDER BY FILE_NAME, PAYLIST_CODE
	</select>
	
	<select id="selectDossierStorage" parameterType="map" resultType="map">
		SELECT FDS.*,FCC.CUST_ID FROM FIL_DOSSIER_STORAGE FDS,FIL_CUST_CLIENT FCC WHERE FDS.CLIENT_ID = FCC.ID AND FDS.ID = #{ID}
	</select>
	
	<update id="doUpdateDossierStatusById" parameterType="map">
		UPDATE FIL_DOSSIER_STORAGE SET STATUS=#{STATUS} WHERE ID=#{DOSSIER_ID}
	</update>
	
	<select id="doMgDossierLedgerList" parameterType="map" resultType="map">
	SELECT TT.* FROM (SELECT TA.*,ROWNUM RN FROM  (SELECT T.* FROM  ( SELECT DISTINCT FDS.PROJECT_CODE,
       FPH.SUP_SHORTNAME,
       FDS.CLIENT_NAME,
       FPH.PRODUCT_NAME,
       FPH.AMOUNT,
       TO_CHAR(FDS.CREATE_DATE, 'YYYY-MM-DD') CREATE_DATE,
       nvl(TA00.DOSSIER_COUNT,0) A00,
       nvl(TA01.DOSSIER_COUNT,0) A01,
       nvl(TA03.DOSSIER_COUNT,0) A03,
       nvl(TA04.DOSSIER_COUNT,0) A04,
       nvl(TA06.DOSSIER_COUNT,0) A06,
       nvl(TA07.DOSSIER_COUNT,0) A07,
       nvl(TA48.DOSSIER_COUNT,0) A48,
       nvl(TA49.DOSSIER_COUNT,0) A49,
       nvl(TC05.DOSSIER_COUNT,0) C05,
       nvl(TC06.DOSSIER_COUNT,0) C06,
       nvl(TC13.DOSSIER_COUNT,0) C13,
       nvl(TC15.DOSSIER_COUNT,0) C15,
       nvl(QTD.DOSSIER_COUNT,0) QT,
       nvl(TBD.DOSSIER_COUNT,0) BD,
       nvl(THGZ.DOSSIER_COUNT,0) HGZ,
       nvl(TFDJZ.DOSSIER_COUNT,0) FDJZ,
       nvl(TLB.DOSSIER_COUNT,0) LB,
       nvl(TFP.DOSSIER_COUNT,0) FP,
       TDD.FLAG REMARK
  FROM FIL_DOSSIER_STORAGE FDS
  LEFT JOIN FIL_PROJECT_HEAD FPH
    ON FDS.PROJECT_CODE = FPH.PRO_CODE
  LEFT JOIN FIL_DOSSIER_STORAGE TA00
    ON FDS.DOSSIER_APPLY_ID = TA00.DOSSIER_APPLY_ID
   AND TA00.FILE_NAME LIKE 'A00%'
  LEFT JOIN FIL_DOSSIER_STORAGE TA01
    ON FDS.DOSSIER_APPLY_ID = TA01.DOSSIER_APPLY_ID
   AND TA01.FILE_NAME LIKE 'A01%'
  LEFT JOIN FIL_DOSSIER_STORAGE TA03
    ON FDS.DOSSIER_APPLY_ID = TA03.DOSSIER_APPLY_ID
   AND TA03.FILE_NAME LIKE 'A03%'
  LEFT JOIN FIL_DOSSIER_STORAGE TA04
    ON FDS.DOSSIER_APPLY_ID = TA04.DOSSIER_APPLY_ID
   AND TA04.FILE_NAME LIKE 'A04%'
  LEFT JOIN FIL_DOSSIER_STORAGE TA06
    ON FDS.DOSSIER_APPLY_ID = TA06.DOSSIER_APPLY_ID
   AND TA06.FILE_NAME LIKE 'A06%'
  LEFT JOIN FIL_DOSSIER_STORAGE TA07
    ON FDS.DOSSIER_APPLY_ID = TA07.DOSSIER_APPLY_ID
   AND TA07.FILE_NAME LIKE 'A07%'
  LEFT JOIN FIL_DOSSIER_STORAGE TC05
    ON FDS.DOSSIER_APPLY_ID = TC05.DOSSIER_APPLY_ID
   AND TC05.FILE_NAME LIKE 'C05%'
  LEFT JOIN FIL_DOSSIER_STORAGE TC06
    ON FDS.DOSSIER_APPLY_ID = TC06.DOSSIER_APPLY_ID
   AND TC06.FILE_NAME LIKE 'C06%'
  LEFT JOIN FIL_DOSSIER_STORAGE TC13
    ON FDS.DOSSIER_APPLY_ID = TC13.DOSSIER_APPLY_ID
   AND TC13.FILE_NAME LIKE 'C13%'
  LEFT JOIN FIL_DOSSIER_STORAGE TC15
    ON FDS.DOSSIER_APPLY_ID = TC15.DOSSIER_APPLY_ID
   AND TC15.FILE_NAME LIKE 'C15%'
  LEFT JOIN FIL_DOSSIER_STORAGE TBD
    ON FDS.DOSSIER_APPLY_ID = TBD.DOSSIER_APPLY_ID
   AND TBD.FILE_NAME LIKE '%保单%'
  LEFT JOIN FIL_DOSSIER_STORAGE THGZ
    ON FDS.DOSSIER_APPLY_ID = THGZ.DOSSIER_APPLY_ID
   AND THGZ.FILE_NAME LIKE '%合格证%'
  LEFT JOIN FIL_DOSSIER_STORAGE TFDJZ
    ON FDS.DOSSIER_APPLY_ID = TFDJZ.DOSSIER_APPLY_ID
   AND TFDJZ.FILE_NAME LIKE '%发动机证%'
  LEFT JOIN FIL_DOSSIER_STORAGE TLB
    ON FDS.DOSSIER_APPLY_ID = TLB.DOSSIER_APPLY_ID
   AND TLB.FILE_NAME LIKE '%绿本%'
  LEFT JOIN FIL_DOSSIER_STORAGE TFP
    ON FDS.DOSSIER_APPLY_ID = TFP.DOSSIER_APPLY_ID
   AND TFP.FILE_NAME LIKE '%发票%'
  LEFT JOIN FIL_DOSSIER_STORAGE TA48
    ON FDS.DOSSIER_APPLY_ID = TA48.DOSSIER_APPLY_ID
   AND TA48.FILE_NAME LIKE '%A48%'
  LEFT JOIN FIL_DOSSIER_STORAGE QTD
    ON FDS.DOSSIER_APPLY_ID = QTD.DOSSIER_APPLY_ID
   AND QTD.FILE_NAME LIKE '%其他%'
  LEFT JOIN FIL_DOSSIER_STORAGE TA49
    ON FDS.DOSSIER_APPLY_ID = TA49.DOSSIER_APPLY_ID
   AND TA49.FILE_NAME LIKE '%A49%'
  LEFT JOIN T_SYS_DATA_DICTIONARY TDD
  ON FPH.PROJECT_MODEL=TDD.CODE
  AND TDD.TYPE='业务类型'
 WHERE FDS.FILE_TYPE = 1
   AND FDS.PROJECT_CODE NOT LIKE '%TEST%'
   AND FDS.DOSSIER_FILE_TYPE='立项合同'
   AND FPH.STATUS>=2 AND <![CDATA[FPH.STATUS<=20]]>
   <if test="CREATE_DATE_END!=null and CREATE_DATE_END!=''">AND TO_CHAR(FDS.CREATE_DATE,'YYYY-MM-DD')&lt;=#{CREATE_DATE_END}</if>
   <if test="CREATE_DATE_START!=null and CREATE_DATE_START!=''">AND TO_CHAR(FDS.CREATE_DATE,'YYYY-MM-DD')>=#{CREATE_DATE_START}</if>
   <if test="REAMARK!=null and REAMARK!=''">AND FDS.REAMARK LIKE '%'||#{REAMARK}||'%'</if>
   <if test="SUP_SHORTNAME!=null and SUP_SHORTNAME!=''">AND FPH.SUP_SHORTNAME LIKE '%'||#{SUP_SHORTNAME}||'%'</if>
 ORDER BY FPH.SUP_SHORTNAME
 )T ORDER BY T.CREATE_DATE DESC)TA 
 <if test="PAGE_END!=null and PAGE_END!=''">WHERE <![CDATA[ROWNUM<=#{PAGE_END}]]></if>
	 )TT
	 <if test="PAGE_BEGIN!=null and PAGE_BEGIN!=''"> WHERE TT.RN>=#{PAGE_BEGIN}</if>
	</select>
	
	<select id="doMgDossierLedgerCount" parameterType="map" resultType="int">
	SELECT COUNT(1) FROM (SELECT distinct FPH.PRO_CODE
	  FROM FIL_DOSSIER_STORAGE FDS
  LEFT JOIN FIL_PROJECT_HEAD FPH
    ON FDS.PROJECT_CODE = FPH.PRO_CODE
  LEFT JOIN FIL_DOSSIER_STORAGE TA00
    ON FDS.DOSSIER_APPLY_ID = TA00.DOSSIER_APPLY_ID
   AND TA00.FILE_NAME LIKE 'A00%'
  LEFT JOIN FIL_DOSSIER_STORAGE TA01
    ON FDS.DOSSIER_APPLY_ID = TA01.DOSSIER_APPLY_ID
   AND TA01.FILE_NAME LIKE 'A01%'
  LEFT JOIN FIL_DOSSIER_STORAGE TA03
    ON FDS.DOSSIER_APPLY_ID = TA03.DOSSIER_APPLY_ID
   AND TA03.FILE_NAME LIKE 'A03%'
  LEFT JOIN FIL_DOSSIER_STORAGE TA04
    ON FDS.DOSSIER_APPLY_ID = TA04.DOSSIER_APPLY_ID
   AND TA04.FILE_NAME LIKE 'A04%'
  LEFT JOIN FIL_DOSSIER_STORAGE TA06
    ON FDS.DOSSIER_APPLY_ID = TA06.DOSSIER_APPLY_ID
   AND TA06.FILE_NAME LIKE 'A06%'
  LEFT JOIN FIL_DOSSIER_STORAGE TA07
    ON FDS.DOSSIER_APPLY_ID = TA07.DOSSIER_APPLY_ID
   AND TA07.FILE_NAME LIKE 'A07%'
  LEFT JOIN FIL_DOSSIER_STORAGE TC05
    ON FDS.DOSSIER_APPLY_ID = TC05.DOSSIER_APPLY_ID
   AND TC05.FILE_NAME LIKE 'C05%'
  LEFT JOIN FIL_DOSSIER_STORAGE TC06
    ON FDS.DOSSIER_APPLY_ID = TC06.DOSSIER_APPLY_ID
   AND TC06.FILE_NAME LIKE 'C06%'
  LEFT JOIN FIL_DOSSIER_STORAGE TC13
    ON FDS.DOSSIER_APPLY_ID = TC13.DOSSIER_APPLY_ID
   AND TC13.FILE_NAME LIKE 'C13%'
  LEFT JOIN FIL_DOSSIER_STORAGE TC15
    ON FDS.DOSSIER_APPLY_ID = TC15.DOSSIER_APPLY_ID
   AND TC15.FILE_NAME LIKE 'C15%'
  LEFT JOIN FIL_DOSSIER_STORAGE TBD
    ON FDS.DOSSIER_APPLY_ID = TBD.DOSSIER_APPLY_ID
   AND TBD.FILE_NAME LIKE '%保单%'
  LEFT JOIN FIL_DOSSIER_STORAGE THGZ
    ON FDS.DOSSIER_APPLY_ID = THGZ.DOSSIER_APPLY_ID
   AND THGZ.FILE_NAME LIKE '%合格证%'
  LEFT JOIN FIL_DOSSIER_STORAGE TFDJZ
    ON FDS.DOSSIER_APPLY_ID = TFDJZ.DOSSIER_APPLY_ID
   AND TFDJZ.FILE_NAME LIKE '%发动机证%'
  LEFT JOIN FIL_DOSSIER_STORAGE TLB
    ON FDS.DOSSIER_APPLY_ID = TLB.DOSSIER_APPLY_ID
   AND TLB.FILE_NAME LIKE '%绿本%'
  LEFT JOIN FIL_DOSSIER_STORAGE TFP
    ON FDS.DOSSIER_APPLY_ID = TFP.DOSSIER_APPLY_ID
   AND TFP.FILE_NAME LIKE '%发票%'
  LEFT JOIN T_SYS_DATA_DICTIONARY TDD
  ON FPH.PROJECT_MODEL=TDD.CODE
  AND TDD.TYPE='业务类型'
 WHERE FDS.FILE_TYPE = 1
   AND FDS.DOSSIER_FILE_TYPE='立项合同'
   AND FPH.STATUS>=2 AND <![CDATA[FPH.STATUS<=20]]>
   <if test="CREATE_DATE!=null and CREATE_DATE!=''">AND TO_CHAR(FDS.CREATE_DATE,'YYYY-MM-DD')=#{CREATE_DATE}</if>
   <if test="SUP_SHORTNAME!=null and SUP_SHORTNAME!=''">AND FPH.SUP_SHORTNAME LIKE '%'||#{SUP_SHORTNAME}||'%'</if>
   AND FDS.PROJECT_CODE NOT LIKE '%TEST%'
   )
	</select>
	
	<update id="doRecieveFile" parameterType="map">
	UPDATE FIL_DOSSIER_STORAGE T SET T.STATUS=#{STATUS} WHERE T.ID=#{ID}
	</update>
	
	<update id="dossierFileRG" parameterType="map">
		UPDATE FIL_DOSSIER_STORAGE T SET T.PORTFOLIO_NUMBER=#{PORTFOLIO_NUMBER,jdbcType=VARCHAR},T.CABINET_NUMBER=#{CABINET_NUMBER,jdbcType=VARCHAR} WHERE T.ID=#{ID}
	</update>
	
	<select id="getpayment" parameterType="map" resultType="map">
		SELECT FFPD.ID, FPH.ID PROJECT_ID, FFPD.PAYLIST_CODE
		  FROM FIL_PROJECT_HEAD FPH, FI_FUND_PAYMENT_DETAIL FFPD
		 WHERE FPH.PRO_CODE = FFPD.PROJECT_CODE
		   AND FPH.ID=#{PROJECT_ID}
	</select>
</mapper>