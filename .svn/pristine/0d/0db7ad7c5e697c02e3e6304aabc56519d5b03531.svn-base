<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="cashDepositK">
	<select id="toMgCashDeposit" parameterType="Map" resultType="Map">
		SELECT T4.*
		  FROM (SELECT T3.*, ROWNUM ROWNU
		          FROM (SELECT FR.PAYLIST_CODE, --支付表编号
		                       FPH.PRO_CODE, --项目编号
		                       FPH.LEASE_CODE, --合同编号
		                       FCC.NAME CLIENT_NAME, --客户名称
		                       TO_CHAR(FPH.CREATE_TIME,'yyyy-MM-dd') CREATE_TIME, --项目创建时间
		                       TO_CHAR(PH.START_DATE,'yyyy-MM-dd') START_DATE, --起租日期
		                       PH.PAY_MONEY, --未还金额 
		                       PH.STATUS, --支付表状态
		                       ph.deposit_sy,  --剩余保证金
		                       ph.deposit_status, --保证金退款
		                       FR.BEGINNING_MONEY BAOZHENGJIN, --客户保证金金额
		                       (CASE
		                         WHEN NVL(FR.BEGINNING_MONEY, 0)>0 AND (NVL(FR.BEGINNING_MONEY, 0) +
		                              NVL(FIO.FX_MONEY, 0)) &lt;= NVL(T2.YS_MONEY1, 0) AND
		                              NVL(FR.BEGINNING_MONEY, 0) >
		                              NVL(T2.YS_MONEY2, 0) THEN
		                          0
		                         ELSE
		                          1
		                       END) TX,    --保证金冲抵提醒： 当为0是进行保证金结清抵扣提醒， 当为1时不做提醒
		                       FIO.FX_MONEY FX_MONEY, --罚息金额
		                       FPS.POUNDAGE_WAY, --保证金处理方式
		                       FPS.ID SCHEME_ID, --方案id
		                       FPH.ID,
		                       FRF.ID FRF_ID
		                  FROM FI_R_BEGINNING FR,
		                       (SELECT T1.PAYLIST_CODE,
		                               SUM(DECODE(ROWS_, 1, T1.YS_MONEY_)) YS_MONEY1,
		                               SUM(DECODE(ROWS_, 2, T1.YS_MONEY_)) YS_MONEY2
		                          FROM (SELECT T.PAYLIST_CODE,
		                                       SUM(T.YS_MONEY) OVER(PARTITION BY T.PAYLIST_CODE ORDER BY T.BEGINNING_NUM ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) YS_MONEY_,
		                                       ROW_NUMBER() OVER(PARTITION BY T.PAYLIST_CODE ORDER BY T.BEGINNING_NUM) ROWS_
		                                  FROM (SELECT FR.PAYLIST_CODE,
		                                               FR.BEGINNING_NUM,
		                                               SUM(FR.BEGINNING_MONEY) YS_MONEY,
		                                               FR.BEGINNING_RECEIVE_DATA
		                                          FROM FI_R_BEGINNING FR
		                                         WHERE FR.ITEM_FLAG = 2
		                                          AND FR.BEGINNING_PAID=0
		                                         GROUP BY FR.PAYLIST_CODE,
		                                                  FR.BEGINNING_NUM,
		                                                  FR.BEGINNING_RECEIVE_DATA) T) T1
		                         GROUP BY T1.PAYLIST_CODE) T2,
		                       (SELECT SUM(FO.RENT_RECE) FX_MONEY, FO.PAY_CODE
		                          FROM FI_OVERDUE FO
		                         WHERE FO.CREATE_DATE = TRUNC(SYSDATE)
		                         GROUP BY FO.PAY_CODE) FIO,
		                       FIL_RENT_PLAN_HEAD_MAX_V PH,
		                       (SELECT MAX(ID) ID, PAY_CODE FROM FI_RETURN_FUND GROUP BY PAY_CODE) FRF,
		                       FIL_PROJECT_HEAD FPH,
		                       FIL_PROJECT_SCHEME FPS,
		                       FIL_CUST_CLIENT FCC
		                 WHERE FR.PAYLIST_CODE = T2.PAYLIST_CODE
		                   AND FR.PAYLIST_CODE = FIO.PAY_CODE(+)
		                   AND FR.PAYLIST_CODE = PH.PAYLIST_CODE
		                   AND PH.PAYLIST_CODE = FRF.PAY_CODE(+)
		                   AND FR.PROJECT_ID = FPH.ID
		                   AND FPH.CLIENT_ID = FCC.ID
		                   AND FPH.ID = FPS.PROJECT_ID
		                   AND PH.STATUS=0
                           --AND PH.DEPOSIT_SY>0
		                   AND FR.BEGINNING_NAME = #{BZJ}
		                   <if test="PAYLIST_CODE!=null and PAYLIST_CODE!=''">AND FR.PAYLIST_CODE LIKE '%'||#{PAYLIST_CODE}||'%'</if>
		                   <if test="PRO_CODE!=null and PRO_CODE!=''">AND FPH.PRO_CODE LIKE '%'||#{PRO_CODE}||'%'</if>
		                   <if test="LEASE_CODE!=null and LEASE_CODE!=''">AND FPH.LEASE_CODE LIKE '%'||#{LEASE_CODE}||'%'</if>
		                   <if test="CLIENT_NAME!=null and CLIENT_NAME!=''">AND FCC.NAME LIKE '%'||#{CLIENT_NAME}||'%'</if>) T3
		         WHERE ROWNUM &lt;= #{PAGE_END}
		         ORDER BY T3.TX ASC,T3.ID DESC,T3.POUNDAGE_WAY DESC NULLS LAST) T4
		 WHERE T4.ROWNU >= #{PAGE_BEGIN}
	</select>
	
	<select id="toMgCashDepositC" parameterType="Map" resultType="int">
		SELECT COUNT(1) FROM(SELECT FR.PAYLIST_CODE, --支付表编号
		                       FPH.PRO_CODE, --项目编号
		                       FPH.LEASE_CODE, --合同编号
		                       FCC.NAME CLIENT_NAME, --客户名称
		                       FPH.CREATE_TIME, --项目创建时间
		                       PH.START_DATE, --起租日期
		                       PH.PAY_MONEY, --未还金额 
		                       PH.STATUS, --支付表状态
		                       FR.BEGINNING_MONEY BAOZHENGJIN, --客户保证金金额
		                       (CASE
		                         WHEN NVL(FR.BEGINNING_MONEY, 0)>0 AND (NVL(FR.BEGINNING_MONEY, 0) +
		                              NVL(FIO.FX_MONEY, 0)) &lt;= NVL(T2.YS_MONEY1, 0) AND
		                              NVL(FR.BEGINNING_MONEY, 0) >
		                              NVL(T2.YS_MONEY2, 0) THEN
		                          0
		                         ELSE
		                          1
		                       END) TX,    --保证金冲抵提醒： 当为0是进行保证金结清抵扣提醒， 当为1时不做提醒
		                       FIO.FX_MONEY FX_MONEY, --罚息金额
		                       FPS.POUNDAGE_WAY, --保证金处理方式
		                       PH.DEPOSIT_STATUS   --保证金状态
		                  FROM FI_R_BEGINNING FR,
		                       (SELECT T1.PAYLIST_CODE,
		                               SUM(DECODE(ROWS_, 1, T1.YS_MONEY_)) YS_MONEY1,
		                               SUM(DECODE(ROWS_, 2, T1.YS_MONEY_)) YS_MONEY2
		                          FROM (SELECT T.PAYLIST_CODE,
		                                       SUM(T.YS_MONEY) OVER(PARTITION BY T.PAYLIST_CODE ORDER BY T.BEGINNING_NUM ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) YS_MONEY_,
		                                       ROW_NUMBER() OVER(PARTITION BY T.PAYLIST_CODE ORDER BY T.BEGINNING_NUM) ROWS_
		                                  FROM (SELECT FR.PAYLIST_CODE,
		                                               FR.BEGINNING_NUM,
		                                               SUM(FR.BEGINNING_MONEY) YS_MONEY,
		                                               FR.BEGINNING_RECEIVE_DATA
		                                          FROM FI_R_BEGINNING FR
		                                         WHERE FR.ITEM_FLAG = 2
		                                         GROUP BY FR.PAYLIST_CODE,
		                                                  FR.BEGINNING_NUM,
		                                                  FR.BEGINNING_RECEIVE_DATA) T) T1
		                         GROUP BY T1.PAYLIST_CODE) T2,
		                       (SELECT SUM(FO.RENT_RECE) FX_MONEY, FO.PAY_CODE
		                          FROM FI_OVERDUE FO
		                         WHERE FO.CREATE_DATE = TRUNC(SYSDATE)
		                         GROUP BY FO.PAY_CODE) FIO,
		                       FIL_RENT_PLAN_HEAD_MAX_V PH,
		                       (SELECT MAX(ID) ID, PAY_CODE FROM FI_RETURN_FUND GROUP BY PAY_CODE) FRF,
		                       FIL_PROJECT_HEAD FPH,
		                       FIL_PROJECT_SCHEME FPS,
		                       FIL_CUST_CLIENT FCC
		                 WHERE FR.PAYLIST_CODE = T2.PAYLIST_CODE
		                   AND FR.PAYLIST_CODE = FIO.PAY_CODE(+)
		                   AND FR.PAYLIST_CODE = PH.PAYLIST_CODE
		                   AND PH.PAYLIST_CODE = FRF.PAY_CODE(+)
		                   AND FR.PROJECT_ID = FPH.ID
		                   AND FPH.CLIENT_ID = FCC.ID
		                   AND FPH.ID = FPS.PROJECT_ID
		                   AND PH.STATUS=0
                           --AND PH.DEPOSIT_SY>0
		                   AND FR.BEGINNING_NAME = #{BZJ}
		                   <if test="PAYLIST_CODE!=null and PAYLIST_CODE!=''">AND FR.PAYLIST_CODE LIKE '%'||#{PAYLIST_CODE}||'%'</if>
		                   <if test="PRO_CODE!=null and PRO_CODE!=''">AND FPH.PRO_CODE LIKE '%'||#{PRO_CODE}||'%'</if>
		                   <if test="LEASE_CODE!=null and LEASE_CODE!=''">AND FPH.LEASE_CODE LIKE '%'||#{LEASE_CODE}||'%'</if>
		                   <if test="CLIENT_NAME!=null and CLIENT_NAME!=''">AND FCC.NAME LIKE '%'||#{CLIENT_NAME}||'%'</if>
		                   ORDER BY FPH.ID DESC)T3
	</select>
	
	<select id="toFindProjectScheme" parameterType="Map" resultType="Map">
		SELECT CL.NAME CLIENT_NAME,
		       CO.BANK_NAME,
		       CO.BANK_ACCOUNT,
		       FHFA.FA_NAME,
		       FHFA.FA_BINK,
		       FHFA.FA_ACCOUNT
		  FROM FIL_PROJECT_HEAD     FPH,
		       FIL_CUST_CLIENT      CL,
		       FIL_CUST_OPENINGBANK CO,
		       FHFA_MANAGER         FHFA
		 WHERE FPH.CLIENT_ID = CL.ID
		   AND FPH.BANK_ID = CO.ID
		   AND FHFA.ID = FPH.FHFA_ID
		   AND FPH.ID = #{ID}
	</select>
	
	<select id="toFindScheme" parameterType="Map" resultType="Map">
		SELECT NVL(S.BAIL_PERCENT, 0) BAIL_PERCENT,
		       NVL(S.DB_BAIL_PERCENT, 0) DB_BAIL_PERCENT,
		       S.SCHEME_CLOB,
		       S.SCHEME_CODE,
		       FRB.BEGINNING_MONEY KHBZJ,
		       HA.LEASE_TOPRIC,
		       HA.TOPRIC_SUBFIRENT
		  FROM FIL_PROJECT_SCHEME S, FI_R_BEGINNING FRB, FIL_RENT_PLAN_HEAD_MAX_V HA
		 WHERE FRB.PROJECT_ID = S.PROJECT_ID
		   AND FRB.PAYLIST_CODE = HA.PAYLIST_CODE
		   AND FRB.BEGINNING_NAME = #{KHBZJ}
		   AND S.ID = #{SCHEME_ID}
		   AND HA.PAYLIST_CODE = #{PAYLIST_CODE}
  	</select>
  	
  	<select id="toFindScheme1" parameterType="Map" resultType="Map">
		SELECT SC.SCHEME_CODE,
		       MAX(DECODE(SC.KEY_NAME_EN, 'DEPOSIT_PERCENT', SC.CALCULATE))DEPOSIT_PERCENT,
		       MAX(DECODE(SC.KEY_NAME_EN, 'DB_BAIL_PERCENT', SC.CALCULATE))DB_BAIL_PERCENT,
		       MAX(DECODE(SC.KEY_NAME_EN, 'BZJSYQSBL', SC.VALUE_STR)) BZJSYQSBL,
		       MAX(DECODE(SC.KEY_NAME_EN, 'BZJSYL', SC.VALUE_STR)) BZJSYL
		  FROM T_BASE_SCHEME SC
		 WHERE SC.SCHEME_CODE = #{SCHEME_CODE}
		 GROUP BY SC.SCHEME_CODE
  	</select>
  	
  	<select id="toViewReturnApp" parameterType="Map" resultType="Map">
  		select rf.id,
		       rf.proceeds_per,
		       rf.proceeds_bank,
		       rf.proceeds_account,
		       rf.payment_per,
		       rf.payment_bank,
		       rf.payment_account,
		       rf.type,
		       rf.purpose,
		       rf.payment_money,
		       to_char(rf.appoint_date,'yyyy-MM-dd') appoint_date,
		       rf.bzj_earnings,
		       rf.payment_evidence,
		       rf.remark
		  from fi_return_fund rf
		  where id = #{rf_id}  		
  	</select>
  	
  	<update id="doUpRentStatus" parameterType="Map">
  		UPDATE FIL_RENT_PLAN_HEAD_MAX_V V
		   SET V.DEPOSIT_STATUS = #{DEPOSIT_STATUS}
		   <if test="DEPOSIT_SY!=null">, V.DEPOSIT_SY = #{DEPOSIT_SY}</if>
		 WHERE V.PAYLIST_CODE = #{PAY_CODE}
  	</update>
  	
  	<insert id="doAddReturnApp" parameterType="Map">
  		insert into fi_return_fund
		  (id,
		   <if test="PROCEEDS_PER != null and PROCEEDS_PER != ''">PROCEEDS_PER,</if>
		   <if test="PROCEEDS_BANK != null and PROCEEDS_BANK != ''">PROCEEDS_BANK,</if>
		   <if test="PROCEEDS_ACCOUNT != null and PROCEEDS_ACCOUNT != ''">PROCEEDS_ACCOUNT,</if>
		   <if test="PAYMENT_PER != null and PAYMENT_PER != ''">PAYMENT_PER,</if>
		   <if test="PAYMENT_BANK != null and PAYMENT_BANK != ''">PAYMENT_BANK,</if>
		   <if test="PAYMENT_ACCOUNT != null and PAYMENT_ACCOUNT != ''">PAYMENT_ACCOUNT,</if>
		   <if test="TYPE != null and TYPE != ''">TYPE,</if>
		   <if test="PURPOSE != null and PURPOSE != ''">PURPOSE,</if>
		   <if test="PAYMENT_MONEY != null and PAYMENT_MONEY != ''">PAYMENT_MONEY,</if>
		   <if test="APPOINT_DATE != null and APPOINT_DATE != ''">APPOINT_DATE,</if>
		   <if test="BZJ_EARNINGS != null and BZJ_EARNINGS != ''">BZJ_EARNINGS,</if>
		   <if test="PAYMENT_EVIDENCE != null and PAYMENT_EVIDENCE != ''">PAYMENT_EVIDENCE,</if>
		   <if test="REMARK != null and REMARK != ''">REMARK,</if>
		   <if test="PAY_CODE != null and PAY_CODE != ''">PAY_CODE,</if>
		   <if test="PRO_CODE != null and PRO_CODE != ''">PRO_CODE,</if>
		   CREATE_TIME,
		   CREATE_CODE)values(
		   #{rf_id},
		   <if test="PROCEEDS_PER != null and PROCEEDS_PER != ''">#{PROCEEDS_PER},</if>
		   <if test="PROCEEDS_BANK != null and PROCEEDS_BANK != ''">#{PROCEEDS_BANK},</if>
		   <if test="PROCEEDS_ACCOUNT != null and PROCEEDS_ACCOUNT != ''">#{PROCEEDS_ACCOUNT},</if>
		   <if test="PAYMENT_PER != null and PAYMENT_PER != ''">#{PAYMENT_PER},</if>
		   <if test="PAYMENT_BANK != null and PAYMENT_BANK != ''">#{PAYMENT_BANK},</if>
		   <if test="PAYMENT_ACCOUNT != null and PAYMENT_ACCOUNT != ''">#{PAYMENT_ACCOUNT},</if>
		   <if test="TYPE != null and TYPE != ''">#{TYPE},</if>
		   <if test="PURPOSE != null and PURPOSE != ''">#{PURPOSE},</if>
		   <if test="PAYMENT_MONEY != null and PAYMENT_MONEY != ''">#{PAYMENT_MONEY},</if>
		   <if test="APPOINT_DATE != null and APPOINT_DATE != ''">to_date(#{APPOINT_DATE},'yyyy-MM-dd'),</if>
		   <if test="BZJ_EARNINGS != null and BZJ_EARNINGS != ''">#{BZJ_EARNINGS},</if>
		   <if test="PAYMENT_EVIDENCE != null and PAYMENT_EVIDENCE != ''">#{PAYMENT_EVIDENCE},</if>
		   <if test="REMARK != null and REMARK != ''">#{REMARK},</if>
		   <if test="PAY_CODE != null and PAY_CODE != ''">#{PAY_CODE},</if>
		   <if test="PRO_CODE != null and PRO_CODE != ''">#{PRO_CODE},</if>
		   sysdate,
		   #{USERCODE}
		   )
  	</insert>
  	
  	<update id="doUpReturnApp" parameterType="Map">
  		update fi_return_fund set jbpm_id=#{jbpmid} where id=#{rf_id}
  	</update>
  	<select id="search_BzjCD_All_List" parameterType="map" resultType="map">
  	select t3.* from ( 
	 select t2.*,ROWNUM R from (
	 	select tt.* from (
  		 select t.*,case when t.sy_zj - t.bzj &lt;= curr_zj then '提醒' else '不提醒' end TX
   		    from (select 
   				mv.ID 
   			   ,mv.PAYLIST_CODE --还款计划编号
   			   ,mv.STATUS --还款状态
               ,fcc.NAME --客户名
               ,fcc.TEL_PHONE --客户电话
               ,su.NAME MANAGER_NAME	--客户经理
               ,su.EMAIL --客户经理邮箱
               ,nvl(mv.lease_topric, 0) * nvl(mv.deposit_rate, 0) / 100 BZJ --客户保证金
               ,fph.LEASE_CODE--合同编号
               ,fph.PRO_CODE -- 项目编号
               ,mv.POUNDAGE_WAY --冲抵方式
               ,mv.TX_STATUS
               ,(select ROUND(NVL(sum(fb.beginning_money - fb.beginning_paid),0),2) sy_zj from fi_r_beginning fb 
                 where fb.paylist_code = mv.paylist_code and fb.beginning_num &lt;=mv.lease_term
                ) SY_ZJ --剩余租金
               ,(select ROUND(NVL(sum(frb.beginning_money - frb.beginning_paid),0),2) from fi_r_beginning frb
                 where frb.paylist_code = mv.PAYLIST_CODE and frb.beginning_num = (select min(frb.beginning_num) beginning_num
                 from fi_r_beginning frb where frb.beginning_num &lt;=mv.lease_term and frb.paylist_code = mv.PAYLIST_CODE
                 and frb.beginning_money - frb.beginning_paid > 0.0005 group by frb.paylist_code
                )) CURR_ZJ --未还的第一期租金
               ,(select min(frb.beginning_num)-1 beginning_num from fi_r_beginning frb where frb.beginning_num &lt;=mv.LEASE_TERM
                  and frb.paylist_code = mv.PAYLIST_CODE and frb.beginning_money - frb.beginning_paid > 0.0005 group by frb.paylist_code
                ) BEGINNING_NUM
               ,mv.DEPOSIT_SY --剩余保证金
           from fil_rent_plan_head_max_v mv
                ,fil_project_head fph
                ,fil_cust_client fcc
               	,secu_user su
          where mv.START_DATE is not null and mv.POUNDAGE_WAY=2 and mv.STATUS in (0,4,7,8,24)
          		and mv.PROJECT_ID = fph.id and fph.client_id = fcc.id and su.code = fcc.clerk_code
         ) t
	  where t.sy_zj > 0.0005 and t.deposit_sy>0.0005
	   	<if test="CUST_NAME!=NULL and CUST_NAME!=''">and t.NAME LIKE '%'||#{CUST_NAME}||'%'</if>
		 <if test="LEASE_CODE!=NULL and LEASE_CODE!=''">and t.LEASE_CODE LIKE '%'||#{LEASE_CODE}||'%'</if>
		 <if test="PAYLIST_CODE!=NULL and PAYLIST_CODE!=''">and t.PAYLIST_CODE LIKE '%'||#{PAYLIST_CODE}||'%'</if>
	  ) tt where 1=1
	  	and tt.TX = '提醒' order by tt.TX_STATUS desc
	  )t2 where ROWNUM &lt;=#{PAGE_END}) t3 where t3.R&gt;=#{PAGE_BEGIN}
  	</select>
  	<select id="search_BzjCD_All_Count" parameterType="map" resultType="int">
	 select count(1) from (
	 	select t2.* from (
  		  select t.*,case when t.sy_zj - t.bzj &lt;= curr_zj then '提醒' else '不提醒' end TX
   		from (select
   				mv.ID 
   			   ,mv.PAYLIST_CODE --还款计划编号
   			   ,mv.STATUS --还款状态
   			   ,mv.IS_DUN_FLAG --是否逾期
               ,fcc.NAME --客户名
               ,fcc.TEL_PHONE --客户电话
               ,su.NAME MANAGER_NAME
               ,su.EMAIL
               ,nvl(mv.lease_topric, 0) * nvl(mv.deposit_rate, 0) / 100 BZJ --客户保证金
               ,fph.LEASE_CODE--合同编号
               ,fph.PRO_CODE -- 项目编号
               ,mv.POUNDAGE_WAY --冲抵方式
               ,mv.TX_STATUS
               ,to_char(fph.create_time,'yyyy-MM-dd') CREATE_TIME --项目创建时间
               ,(select ROUND(NVL(sum(fb.beginning_money - fb.beginning_paid),
                                  0),
                              2) sy_zj
                   from fi_r_beginning fb
                  where fb.paylist_code = mv.paylist_code
                    and fb.beginning_num &lt;=mv.lease_term) SY_ZJ --剩余租金
               ,
                (select ROUND(NVL(sum(frb.beginning_money -
                                      frb.beginning_paid),
                                  0),
                              2)
                   from fi_r_beginning frb
                  where frb.paylist_code = mv.PAYLIST_CODE
                    and frb.beginning_num =
                        (select min(frb.beginning_num) beginning_num
                           from fi_r_beginning frb
                          where frb.beginning_num &lt;=mv.lease_term
                            and frb.paylist_code = mv.PAYLIST_CODE
                            and frb.beginning_money - frb.beginning_paid >
                                0.0005
                          group by frb.paylist_code)) CURR_ZJ --未还的第一期租金
               ,mv.DEPOSIT_SY --剩余保证金
           from fil_rent_plan_head_max_v mv
                ,fil_project_head fph
                ,fil_cust_client fcc
                ,secu_user su
          where mv.START_DATE is not null and mv.POUNDAGE_WAY=2 and mv.STATUS in (0,4,7,8)
          		and mv.PROJECT_ID = fph.id and fph.client_id = fcc.id and su.code = fcc.clerk_code
         ) t
	  where t.sy_zj > 0.0005 and t.deposit_sy>0.0005
	     <if test="CUST_NAME!=NULL and CUST_NAME!=''">and t.NAME LIKE '%'||#{CUST_NAME}||'%'</if>
		 <if test="LEASE_CODE!=NULL and LEASE_CODE!=''">and t.LEASE_CODE LIKE '%'||#{LEASE_CODE}||'%'</if>
		 <if test="PAYLIST_CODE!=NULL and PAYLIST_CODE!=''">and t.PAYLIST_CODE LIKE '%'||#{PAYLIST_CODE}||'%'</if>
	  ) t2 where 1=1
	  	and t2.TX = '提醒' order by t2.TX_STATUS desc
	  )
  	</select>
  	<select id="search_BzjCD_List" parameterType="map" resultType="map">
  			select tt.* from (
  		 select t.*,case when t.sy_zj - t.bzj &lt;= curr_zj then '提醒' else '不提醒' end TX
   		from (select mv.PAYLIST_CODE --还款计划编号
               ,fcc.NAME --客户名
               ,fcc.TEL_PHONE --客户电话
               ,su.NAME MANAGER_NAME	--客户经理
               ,su.EMAIL --客户经理邮箱
               ,nvl(mv.lease_topric, 0) * nvl(mv.deposit_rate, 0) / 100 BZJ --客户保证金
               ,fph.LEASE_CODE--合同编号
               ,fph.PRO_CODE -- 项目编号
               ,mv.POUNDAGE_WAY --冲抵方式
               ,to_char(fph.create_time,'yyyy-MM-dd') CREATE_TIME --项目创建时间
               ,(select ROUND(NVL(sum(fb.beginning_money - fb.beginning_paid),
                                  0),
                              2) sy_zj
                   from fi_r_beginning fb
                  where fb.paylist_code = mv.paylist_code
                    and fb.beginning_num &lt;=mv.lease_term) SY_ZJ --剩余租金
               ,
                (select ROUND(NVL(sum(frb.beginning_money -
                                      frb.beginning_paid),
                                  0),
                              2)
                   from fi_r_beginning frb
                  where frb.paylist_code = mv.PAYLIST_CODE
                    and frb.beginning_num =
                        (select min(frb.beginning_num) beginning_num
                           from fi_r_beginning frb
                          where frb.beginning_num &lt;=mv.lease_term
                            and frb.paylist_code = mv.PAYLIST_CODE
                            and frb.beginning_money - frb.beginning_paid >
                                0.0005
                          group by frb.paylist_code)) CURR_ZJ --未还的第一期租金
                 ,mv.deposit_sy
           from fil_rent_plan_head_max_v mv
                ,fil_project_head fph
                ,fil_cust_client fcc
               	,secu_user su
          where mv.START_DATE is not null and (mv.TX_STATUS=1 or mv.TX_STATUS is null) and mv.POUNDAGE_WAY=2 and mv.STATUS in (0,4,7,8)
          		and mv.PROJECT_ID = fph.id and fph.client_id = fcc.id and su.code = fcc.clerk_code
         ) t
	  where t.sy_zj > 0.0005 and t.deposit_sy>0.0005
	  ) tt where tt.TX = '提醒'
  	</select>
  	<update id="update_frph_TX_STATUS" parameterType="map">
  		update fil_rent_plan_head set TX_STATUS = 2 
  		where PAYLIST_CODE = #{PAYLIST_CODE}
  	</update>
  	<insert id="insert_fbr_record" parameterType="map">
      insert into fi_bzj_record(
             ID
             <if test="PAYLIST_CODE!=null and PAYLIST_CODE!=''">,PAYLIST_CODE</if>
             <if test="BZJ!=null and BZJ!=''">,BEGIN_BZJ</if>
             <if test="BZJ!=null and BZJ!=''">,SY_BZJ</if>
             <if test="REMARK!=null and REMARK!=''">,REMARK</if>
             ,CREATE_TIME
             <if test="TYPE!=NULL and TYPE!=''">,TYPE</if>
      ) values(
             seq_fi_bzj_record.nextval
             <if test="PAYLIST_CODE!=null and PAYLIST_CODE!=''">,#{PAYLIST_CODE}</if>
             <if test="BZJ!=null and BZJ!=''">,#{BZJ}</if>
             <if test="BZJ!=null and BZJ!=''">,#{BZJ}</if>
             <if test="REMARK!=null and REMARK!=''">,#{REMARK}</if>
             ,SYSDATE
             <if test="TYPE!=NULL and TYPE!=''">,#{TYPE}</if>
      )
  		
  	</insert>
  	<select id="searchApplayId" parameterType="map" resultType="int">
  		SELECT SEQ_FI_BZJ_QMCD_APPLY.NEXTVAL FROM DUAL
  	</select>
  	<select id="getIdByPaylist_Code" parameterType="String" resultType="map">
  		select frp.ID RENT_PLAN_HEAD_ID,frp.STATUS,frp.PAYLIST_CODE from fil_rent_plan_head_max_v frp where frp.paylist_code = #{PAYLIST_CODE}
  	</select>
  	<insert id="insertApplay" parameterType="map">
  		insert into fi_bzj_qmcd_apply(
  			ID
  			<if test="REMARK_ID!=null and REMARK_ID!=''">,REMARK_ID</if>
  			<if test="RENT_PLAN_HEAD_ID!=null and RENT_PLAN_HEAD_ID!=''">,RENT_PLAN_HEAD_ID</if>
  			<if test="PAYLIST_CODE!=null and PAYLIST_CODE!=''">,PAYLIST_CODE</if>
  			<if test="CUST_NAME!=null and CUST_NAME!=''">,CUST_NAME</if>
  			<if test="BANK_ACCOUNT!=null and BANK_ACCOUNT!=''">,BANK_ACCOUNT</if>
  			<if test="BANK_NAME!=null and BANK_NAME!=''">,BANK_NAME</if>
  			<if test="FA_NAME!=null and FA_NAME!=''">,FA_NAME</if>
  			<if test="FA_ACCOUNT!=null and FA_ACCOUNT!=''">,FA_ACCOUNT</if>
  			<if test="FA_BINK!=null and FA_BINK!=''">,FA_BINK</if>
  			<if test="GOBACK_TIME!=null and GOBACK_TIME!=''">,GOBACK_TIME</if>
  			<if test="DEPOSIT_SY!=null and DEPOSIT_SY!=''">,DEPOSIT_SY</if>
  			<if test="STATUS!=null and STATUS!=''">,STATUS</if>
  		)values(
  			seq_fi_bzj_qmcd_apply.nextval
  			<if test="REMARK_ID!=null and REMARK_ID!=''">,#{REMARK_ID}</if>
  			<if test="RENT_PLAN_HEAD_ID!=null and RENT_PLAN_HEAD_ID!=''">,${RENT_PLAN_HEAD_ID}</if>
			<if test="PAYLIST_CODE!=null and PAYLIST_CODE!=''">,#{PAYLIST_CODE}</if>
  			<if test="CUST_NAME!=null and CUST_NAME!=''">,#{CUST_NAME}</if>
  			<if test="BANK_ACCOUNT!=null and BANK_ACCOUNT!=''">,#{BANK_ACCOUNT}</if>
  			<if test="BANK_NAME!=null and BANK_NAME!=''">,#{BANK_NAME}</if>
  			<if test="FA_NAME!=null and FA_NAME!=''">,#{FA_NAME}</if>
  			<if test="FA_ACCOUNT!=null and FA_ACCOUNT!=''">,#{FA_ACCOUNT}</if>
  			<if test="FA_BINK!=null and FA_BINK!=''">,#{FA_BINK}</if>
  			<if test="GOBACK_TIME!=null and GOBACK_TIME!=''">,to_date(#{GOBACK_TIME},'yyyy-MM-dd')</if>
  			<if test="DEPOSIT_SY!=null and DEPOSIT_SY!=''">,#{DEPOSIT_SY}</if>
  			<if test="STATUS!=null and STATUS!=''">,#{STATUS}</if>
  			)
  	</insert>
  	<select id="selectRentPlanHeadId" parameterType="map" resultType="map">
         select fb.rent_plan_head_id,fb.paylist_code,fb.status from fi_bzj_qmcd_apply fb where fb.remark_id = #{ID}
  	</select>
  	<select id="" parameterType="map" resultType="map">
  		select tt.* from (
  		 select t.*,case when t.sy_zj - t.bzj &lt;= curr_zj then '提醒' else '不提醒' end TX
   		from (select 
   				mv.ID 
   			   ,mv.PAYLIST_CODE --还款计划编号
   			   ,mv.STATUS --还款状态
   			   ,mv.IS_DUN_FLAG --是否逾期
               ,fcc.NAME --客户名
               ,fcc.TEL_PHONE --客户电话
               ,su.NAME MANAGER_NAME	--客户经理
               ,su.EMAIL --客户经理邮箱
               ,nvl(mv.lease_topric, 0) * nvl(mv.deposit_rate, 0) / 100 BZJ --客户保证金
               ,fph.LEASE_CODE--合同编号
               ,fph.PRO_CODE -- 项目编号
               ,mv.POUNDAGE_WAY --冲抵方式
               ,mv.TX_STATUS
               ,to_char(fph.create_time,'yyyy-MM-dd') CREATE_TIME --项目创建时间
               ,(select ROUND(NVL(sum(fb.beginning_money - fb.beginning_paid),
                                  0),
                              2) sy_zj
                   from fi_r_beginning fb
                  where fb.paylist_code = mv.paylist_code
                    and fb.beginning_num &lt;=mv.lease_term) SY_ZJ --剩余租金
               ,
                (select ROUND(NVL(sum(frb.beginning_money -
                                      frb.beginning_paid),
                                  0),
                              2)
                   from fi_r_beginning frb
                  where frb.paylist_code = mv.PAYLIST_CODE
                    and frb.beginning_num =
                        (select min(frb.beginning_num) beginning_num
                           from fi_r_beginning frb
                          where frb.beginning_num &lt;=mv.lease_term
                            and frb.paylist_code = mv.PAYLIST_CODE
                            and frb.beginning_money - frb.beginning_paid >
                                0.0005
                          group by frb.paylist_code)) CURR_ZJ --未还的第一期租金
               ,mv.DEPOSIT_SY --剩余保证金
           from fil_rent_plan_head_max_v mv
                ,fil_project_head fph
                ,fil_cust_client fcc
               	,secu_user su
          where mv.START_DATE is not null and mv.POUNDAGE_WAY=2 and mv.STATUS in (0,4,7,8) and id in (#{RENT_PLAN_HEAD_ID})
          		and mv.PROJECT_ID = fph.id and fph.client_id = fcc.id and su.code = fcc.clerk_code
         ) t
	  where t.sy_zj > 0.0005 and t.deposit_sy>0.0005
	  ) tt where 1=1
	  	and tt.TX = '提醒' order by tt.TX_STATUS desc
  	</select>
  	<select id="getBzjSYRecordList" parameterType="map" resultType="map">
  		select PAYLIST_CODE,BEGIN_BZJ,SY_BZJ,REMARK,TO_CHAR(CREATE_TIME,'yyyy-MM-dd') CREATE_TIME,OPERATOR_MAN,TYPE 
  		from fi_bzj_record where PAYLIST_CODE = #{PAYLIST_CODE} order by sy_bzj
  	</select>
  	<update id="update_FRPH_Status" parameterType="map">
  		update fil_rent_plan_head f set f.status = 24 where f.PAYLIST_CODE in (#{param}) 
  	</update>
  	<update id="update_FRPH_Status_QMTH" parameterType="map">
  		update fil_rent_plan_head f set f.status = #{STATUS_T} where f.id = #{ID}
  	</update>
  	<update id="update_FRPH_StatusById" parameterType="map">
  		update fil_rent_plan_head f set f.status = #{STATUS_T} where f.id = #{RENT_PLAN_HEAD_ID}
  	</update>
  	<select id="getDeposit_syInfo" parameterType="map" resultType="map">
  		select fr.DEPOSIT_SY,fr.STATUS from fil_rent_plan_head_max_v fr where fr.PAYLIST_CODE = #{PAYLIST_CODE}
  	</select>
  	<select id="getBzj_Qmth_Status" resultType="map">
  		select tssd.CODE from t_sys_site_dictionary tssd where tssd.type='保证金退回是否结清' and rownum=1
  	</select>
  	<select id="getBzj_Qmth_List_One" parameterType="map" resultType="map">
  	select t2.* from (
  	  select t1.*,ROWNUM R from (
  		select 
		   mv.ID
		  ,mv.PAYLIST_CODE
		  ,fcc.NAME --客户名
		  ,fcc.TEL_PHONE --客户电话
		  ,su.NAME MANAGER_NAME	--客户经理 
		  ,fph.LEASE_CODE--合同编号
		  ,fph.PRO_CODE -- 项目编号
		  ,mv.STATUS --支付表状态
		  ,to_char(fph.CREATE_TIME,'yyyy-MM-dd') CREATE_TIME
		  ,NVL(mv.DEPOSIT_SY,0) DEPOSIT_SY --客户剩余保证金
		from fil_rent_plan_head_max_v mv
		 ,fil_project_head fph
		 ,fil_cust_client fcc
		 ,secu_user su
		 where mv.status in (3,6,25) and mv.START_DATE is not null and mv.POUNDAGE_WAY=3 and mv.DEPOSIT_SY&gt;0
		 and mv.PROJECT_ID = fph.id and fph.client_id = fcc.id and su.code = fcc.clerk_code
		 <if test="CUST_NAME!=NULL and CUST_NAME!=''">and t.NAME LIKE '%'||#{CUST_NAME}||'%'</if>
		 <if test="LEASE_CODE!=NULL and LEASE_CODE!=''">and t.LEASE_CODE LIKE '%'||#{LEASE_CODE}||'%'</if>
		 <if test="PAYLIST_CODE!=NULL and PAYLIST_CODE!=''">and t.PAYLIST_CODE LIKE '%'||#{PAYLIST_CODE}||'%'</if>
		 ) t1 WHERE ROWNUM&lt;=#{PAGE_END}) t2 where t2.R&gt;=#{PAGE_BEGIN}
  	</select>
  	<select id="getBzj_Qmth_One_Count" parameterType="map" resultType="int">
  		select count(1)
		from fil_rent_plan_head_max_v mv
		 ,fil_project_head fph
		 ,fil_cust_client fcc
		 ,secu_user su
		 where mv.status in (3,6,25) and mv.START_DATE is not null and mv.POUNDAGE_WAY=3 and mv.DEPOSIT_SY&gt;0
		 and mv.PROJECT_ID = fph.id and fph.client_id = fcc.id and su.code = fcc.clerk_code
		 <if test="CUST_NAME!=NULL and CUST_NAME!=''">and t.NAME LIKE '%'||#{CUST_NAME}||'%'</if>
		 <if test="LEASE_CODE!=NULL and LEASE_CODE!=''">and t.LEASE_CODE LIKE '%'||#{LEASE_CODE}||'%'</if>
		 <if test="PAYLIST_CODE!=NULL and PAYLIST_CODE!=''">and t.PAYLIST_CODE LIKE '%'||#{PAYLIST_CODE}||'%'</if>
  	</select>
	<select id="getBzj_Qmth_List_Two" parameterType="map" resultType="map">
	select t2.* from (
  	  select t1.*,ROWNUM R from (
	  select t.* from (
		select 
		   fr.id
		  ,fr.PAYLIST_CODE
		  ,round(NVL(sum(frb.beginning_money - frb.beginning_paid),0),2) +round(NVL(sum(NVL(fo.penalty_rece,0) - NVL(fo.penalty_paid,0)),0),2) sy_money
		  ,fcc.NAME --客户名
		  ,fcc.TEL_PHONE --客户电话
		  ,su.NAME MANAGER_NAME	--客户经理
		  ,fph.LEASE_CODE--合同编号
		  ,fph.PRO_CODE -- 项目编号
		  ,fr.STATUS
		  ,to_char(fph.CREATE_TIME,'yyyy-MM-dd') CREATE_TIME
		  ,NVL(fr.deposit_sy,0) DEPOSIT_SY --剩余保证金
		from fil_rent_plan_head_max_v fr 
		left join fi_r_beginning frb on fr.PAYLIST_CODE=frb.paylist_code
		left join fi_overdue fo on fr.PAYLIST_CODE=fo.pay_code
		left join fil_project_head fph on fr.PROJECT_ID=fph.id
		left join fil_cust_client fcc on fcc.id=fph.client_id
		left join secu_user su on su.code=fcc.clerk_code
		where fr.START_DATE is not null and fr.POUNDAGE_WAY=3 and fr.deposit_sy>0
		<if test="CUST_NAME!=NULL and CUST_NAME!=''">and t.NAME LIKE '%'||#{CUST_NAME}||'%'</if>
		<if test="LEASE_CODE!=NULL and LEASE_CODE!=''">and t.LEASE_CODE LIKE '%'||#{LEASE_CODE}||'%'</if>
		<if test="PAYLIST_CODE!=NULL and PAYLIST_CODE!=''">and t.PAYLIST_CODE LIKE '%'||#{PAYLIST_CODE}||'%'</if>
		group by fr.PAYLIST_CODE ,fcc.NAME --客户名
		  ,fr.id
		  ,fcc.TEL_PHONE --客户电话
		  ,su.NAME--客户经理
		  ,su.EMAIL --客户经理邮箱 
		  ,fph.LEASE_CODE--合同编号
		  ,fph.PRO_CODE -- 项目编号
		   ,fr.STATUS
		   ,fr.lease_topric
		   ,fr.deposit_rate
		   ,fph.create_time
		   ,fr.deposit_sy
		) t where t.sy_money&lt;=0.0005
		) t1 WHERE ROWNUM&lt;=#{PAGE_END}) t2 where t2.R&gt;=#{PAGE_BEGIN}
  	</select>
  	<select id="getBzj_Qmth_Two_Count" parameterType="map" resultType="int">
  		select count(1) from (
		select 
		  fr.PAYLIST_CODE
		  ,round(NVL(sum(frb.beginning_money - frb.beginning_paid),0),2) +round(NVL(sum(NVL(fo.penalty_rece,0) - NVL(fo.penalty_paid,0)),0),2) sy_money
		  ,fcc.NAME --客户名
		  ,fcc.TEL_PHONE --客户电话
		  ,su.NAME MANAGER_NAME	--客户经理
		  ,fph.LEASE_CODE--合同编号
		  ,fph.PRO_CODE -- 项目编号
		  ,fr.STATUS
		  ,to_char(fph.CREATE_TIME,'yyyy-MM-dd') CREATE_TIME
		  ,NVL(fr.deposit_sy,0) DEPOSIT_SY --剩余保证金
		from fil_rent_plan_head_max_v fr 
		left join fi_r_beginning frb on fr.PAYLIST_CODE=frb.paylist_code
		left join fi_overdue fo on fr.PAYLIST_CODE=fo.pay_code
		left join fil_project_head fph on fr.PROJECT_ID=fph.id
		left join fil_cust_client fcc on fcc.id=fph.client_id
		left join secu_user su on su.code=fcc.clerk_code
		where fr.START_DATE is not null and fr.POUNDAGE_WAY=3 and fr.deposit_sy>0
		<if test="CUST_NAME!=NULL and CUST_NAME!=''">and t.NAME LIKE '%'||#{CUST_NAME}||'%'</if>
		<if test="LEASE_CODE!=NULL and LEASE_CODE!=''">and t.LEASE_CODE LIKE '%'||#{LEASE_CODE}||'%'</if>
		<if test="PAYLIST_CODE!=NULL and PAYLIST_CODE!=''">and t.PAYLIST_CODE LIKE '%'||#{PAYLIST_CODE}||'%'</if>
		group by fr.PAYLIST_CODE ,fcc.NAME --客户名
		  ,fcc.TEL_PHONE --客户电话
		  ,su.NAME--客户经理
		  ,su.EMAIL --客户经理邮箱 
		  ,fph.LEASE_CODE--合同编号
		  ,fph.PRO_CODE -- 项目编号
		   ,fr.STATUS
		   ,fr.lease_topric
		   ,fr.deposit_rate
		   ,fr.deposit_sy
		) t where t.sy_money&lt;=0.0005
  	</select>
  	<select id="selectWSBzjDetail" parameterType="map" resultType="map">
	   select t.*
	      from (
            select 
            	fr.BEGINNING_NUM --期次
                ,to_char(fr.BEGINNING_RECEIVE_DATA,'yyyy-MM-dd') BEGINNING_RECEIVE_DATA --应收时间
                ,fr.ITEM_FLAG --1 首期款 2 租金 3 保证金
                ,sum(fr.beginning_money) YS_MONEY --应收
                ,sum(fr.beginning_paid) SS_MONEY --实收
                ,sum(fr.beginning_money) - sum(fr.beginning_paid) WS_MONEY --未收money
                ,mv.LEASE_TERM
              from fi_r_beginning fr,fil_rent_plan_head_max_v mv
          		  where mv.PAYLIST_CODE=fr.paylist_code and fr.beginning_num &lt;= mv.LEASE_TERM and mv.ID=#{ID} 
             group by fr.beginning_num,fr.beginning_receive_data ,fr.item_flag,mv.LEASE_TERM
             ) t
	   where t.ws_money > 0.0005 order by t.beginning_num
  	</select>
  	<select id="getApplayPageData" parameterType="map" resultType="map">
  		 select 
           mv.ID 
            ,mv.PAYLIST_CODE --还款计划编号
            ,mv.STATUS --还款状态
               ,fcc.NAME --客户名
               ,fcc.TEL_PHONE --客户电话
               ,su.NAME MANAGER_NAME  --客户经理
               ,nvl(mv.lease_topric, 0) * nvl(mv.deposit_rate, 0) / 100 BZJ --客户保证金
               ,fph.LEASE_CODE--合同编号
               ,fph.PRO_CODE -- 项目编号
               ,mv.TX_STATUS
               ,to_char(fph.create_time,'yyyy-MM-dd') CREATE_TIME --项目创建时间
               ,(select ROUND(NVL(sum(fb.beginning_money - fb.beginning_paid),
                                  0),
                              2) sy_zj
                   from fi_r_beginning fb
                  where fb.paylist_code = mv.paylist_code
                    and fb.beginning_num &lt;=mv.lease_term) SY_ZJ --剩余租金
               ,
                (select ROUND(NVL(sum(frb.beginning_money -
                                      frb.beginning_paid),
                                  0),
                              2)
                   from fi_r_beginning frb
                  where frb.paylist_code = mv.PAYLIST_CODE
                    and frb.beginning_num =
                        (select min(frb.beginning_num) beginning_num
                           from fi_r_beginning frb
                          where frb.beginning_num &lt;=mv.lease_term
                            and frb.paylist_code = mv.PAYLIST_CODE
                            and frb.beginning_money - frb.beginning_paid >
                                0.0005
                          group by frb.paylist_code)) CURR_ZJ --未还的第一期租金
               ,mv.DEPOSIT_SY --剩余保证金
           from fil_rent_plan_head_max_v mv
                ,fil_project_head fph
                ,fil_cust_client fcc
               	,secu_user su
                where mv.id in (${IDS2}) and  mv.PROJECT_ID = fph.id and fph.client_id = fcc.id and su.code = fcc.clerk_code
  	</select>
  	<select id="getFi_R_Beginning_List" parameterType="map" resultType="map">
  		   select fr.BEGINNING_NUM --期次
                  ,to_char(fr.BEGINNING_RECEIVE_DATA,'yyyy-MM-dd') BEGINNING_RECEIVE_DATA --应收时间
                  ,fr.ITEM_FLAG --1 首期款 2 租金 3 保证金
                  ,sum(fr.beginning_money) YS_MONEY --应收
                  ,sum(fr.beginning_paid) SS_MONEY --实收
                  ,sum(fr.beginning_money) - sum(fr.beginning_paid) WS_MONEY --未收money
                  ,mv.LEASE_TERM --总期次
             from fi_r_beginning fr,fil_rent_plan_head_max_v mv
         		  where mv.PAYLIST_CODE=fr.paylist_code and (fr.beginning_num&lt;=mv.LEASE_TERM or fr.beginning_num is null) 
         		  	and mv.ID = #{ID}
            group by fr.beginning_num,fr.beginning_receive_data ,fr.item_flag,mv.LEASE_TERM order by fr.beginning_num
  	</select>
  	<select id="getFRBListByRemarkId" parameterType="map" resultType="map">
  		   select fr.BEGINNING_NUM --期次
                  ,to_char(fr.BEGINNING_RECEIVE_DATA,'yyyy-MM-dd') BEGINNING_RECEIVE_DATA --应收时间
                  ,fr.ITEM_FLAG --1 首期款 2 租金 3 保证金
                  ,sum(fr.beginning_money) YS_MONEY --应收
                  ,sum(fr.beginning_paid) SS_MONEY --实收
                  ,sum(fr.beginning_money) - sum(fr.beginning_paid) WS_MONEY --未收money
                  ,mv.LEASE_TERM --总期次
             from fi_r_beginning fr,fil_rent_plan_head_max_v mv,fi_bzj_qmcd_apply fp
         		  where mv.PAYLIST_CODE=fr.paylist_code and (fr.beginning_num&lt;=mv.LEASE_TERM or fr.beginning_num is null) 
         		  		 and fp.rent_plan_head_id = mv.ID and fp.remark_id = #{ID}
            group by fr.beginning_num,fr.beginning_receive_data ,fr.item_flag,mv.LEASE_TERM order by fr.beginning_num
  	</select>
  	<select id="checkApplay_Status" parameterType="map" resultType="int">
  		select mv.STATUS from fil_rent_plan_head_max_v mv where mv.ID = #{ID}
  	</select>
  	<select id="selectTHInfoById" parameterType="map" resultType="map">
  		 select 
		       mv.ID
		      ,mv.PAYLIST_CODE
		      ,fcc.NAME --客户名
		      ,fcc.TEL_PHONE --客户电话
		      ,(select f.BANK_NAME from fil_cust_openingbank f where f.client_id = fcc.id and rownum = 1 ) BANK_NAME --开户行
     		  ,(select f.BANK_ACCOUNT  from fil_cust_openingbank f where f.client_id = fcc.id and rownum = 1) BANK_ACCOUNT --银行账号
		      ,su.NAME MANAGER_NAME  --客户经理 
		      ,fph.LEASE_CODE--合同编号
		      ,fph.PRO_CODE -- 项目编号
		      ,mv.STATUS --支付表状态
		      ,to_char(fph.CREATE_TIME,'yyyy-MM-dd') CREATE_TIME
		      ,NVL(mv.DEPOSIT_SY,0) DEPOSIT_SY --客户剩余保证金
		    from fil_rent_plan_head_max_v mv
		     ,fil_project_head fph
		     ,fil_cust_client fcc
		     ,secu_user su
		     ,fil_cust_openingbank fco
		     where  mv.PROJECT_ID = fph.id and fph.client_id = fcc.id and su.code = fcc.clerk_code and fcc.id = fco.client_id
		     and mv.id = #{ID}
  	</select>
  	<select id="selectTHById" parameterType="map" resultType="map">
  		select 
		       mv.ID
		      ,fcc.TEL_PHONE --客户电话
		      ,su.NAME MANAGER_NAME  --客户经理 
		      ,fph.LEASE_CODE--合同编号
		      ,fph.PRO_CODE -- 项目编号
		      ,mv.STATUS --支付表状态
		      ,to_char(fph.CREATE_TIME,'yyyy-MM-dd') CREATE_TIME
	          ,fbq.PAYLIST_CODE
	          ,fbq.CUST_NAME
	          ,fbq.BANK_ACCOUNT
	          ,fbq.BANK_NAME
	          ,fbq.FA_NAME
	          ,fbq.FA_ACCOUNT
	          ,fbq.FA_BINK
	          ,TO_CHAR(fbq.GOBACK_TIME,'yyyy-MM-dd') GOBACK_TIME
	          ,fbq.DEPOSIT_SY
		    from fil_rent_plan_head_max_v mv
		     ,fil_project_head fph
		     ,fil_cust_client fcc
		     ,secu_user su
		     ,fil_cust_openingbank fco
             ,fi_bzj_qmcd_apply fbq
		 where mv.PROJECT_ID = fph.id and fph.client_id = fcc.id and su.code = fcc.clerk_code and fcc.id = fco.client_id and fbq.rent_plan_head_id = mv.ID
		     and fbq.remark_id = #{ID}
  	</select>
  	<select id="getBankData" parameterType="map" resultType="map">
  		SELECT T2.* FROM ( SELECT T1.*,ROWNUM RN FROM (
		select
		FM.FA_BINK,FM.FA_ACCOUNT from FHFA_MANAGER_BANK_INFO FM,fhfa_manager F
		where F.Id=FM.Manager_Id and F.Organization_Id=#{ID} and (FM.FLAG=1 or
		(FM.FLAG=2 and FM.Fa_Bank_Type=#{FA_BANK_TYPE}))
		<if test="FA_ACCOUNT != null and FA_ACCOUNT != ''">AND (FM.FA_ACCOUNT LIKE '%${FA_ACCOUNT}%' OR FM.FA_BINK
			LIKE '%${FA_ACCOUNT}%')</if>
		order by FLAG
		) T1 WHERE ROWNUM &lt;=#{PAGE_END} ) t2 WHERE t2.RN>=#{PAGE_BEGIN}
  	</select>
  	<select id="getBankDataCount" parameterType="map" resultType="int">
  		SELECT COUNT(1) FROM (
		select FM.FA_BINK,FM.FA_ACCOUNT from
		FHFA_MANAGER_BANK_INFO FM,fhfa_manager F
		where F.Id=FM.Manager_Id and F.Organization_Id=#{ID} and (FM.FLAG=1 or
		(FM.FLAG=2 and FM.Fa_Bank_Type=#{FA_BANK_TYPE}))
		<if test="FA_ACCOUNT != null and FA_ACCOUNT != ''">AND (FM.FA_ACCOUNT LIKE '%${FA_ACCOUNT}%' OR FM.FA_BINK
			LIKE '%${FA_ACCOUNT}%')</if>
		) T
  	</select>
  	
  	<select id="getPjcdDataList" parameterType="map" resultType="map">
  	  select t2.* from (
  		select t.*,ROWNUM R from (
  		   select 
   				mv.ID 
   			   ,mv.PAYLIST_CODE --还款计划编号
   			   ,mv.STATUS --还款状态
               ,fcc.NAME CUST_NAME--客户名
               ,fcc.TEL_PHONE --客户电话
               ,su.NAME MANAGER_NAME	--客户经理
               ,nvl(mv.lease_topric, 0) * nvl(mv.deposit_rate, 0) / 100 BZJ --客户保证金
               ,fph.LEASE_CODE--合同编号
               ,fph.PRO_CODE -- 项目编号
               ,to_char(fph.create_time,'yyyy-MM-dd') CREATE_TIME --项目创建时间
               ,(select ROUND(NVL(sum(fb.beginning_money - fb.beginning_paid),
                                  0),
                              2) sy_zj
                   from fi_r_beginning fb
                  where fb.paylist_code = mv.paylist_code
                    and fb.beginning_num &lt;=mv.lease_term) SY_ZJ --剩余租金
               ,mv.DEPOSIT_SY --剩余保证金
               ,(select fr.beginning_num from fi_r_beginning fr where fr.paylist_code=mv.PAYLIST_CODE and trunc(sysdate)&lt;=trunc(fr.beginning_receive_data)  and rownum = 1 group by fr.beginning_num,fr.beginning_receive_data ) BEGINNING_NUM --当前期次
           from fil_rent_plan_head_max_v mv
                ,fil_project_head fph
                ,fil_cust_client fcc
               	,secu_user su
          where mv.STATUS in (0,4,7,8,26) and mv.POUNDAGE_WAY=1 and mv.START_DATE is not null and mv.DEPOSIT_SY>0
          		and mv.PROJECT_ID = fph.id and fph.client_id = fcc.id and su.code = fcc.clerk_code
          		<if test="CUST_NAME!=NULL and CUST_NAME!=''">and fcc.NAME LIKE '%'||#{CUST_NAME}||'%'</if>
				<if test="LEASE_CODE!=NULL and LEASE_CODE!=''">and fph.LEASE_CODE LIKE '%'||#{LEASE_CODE}||'%'</if>
		 		<if test="PRO_CODE!=NULL and PRO_CODE!=''">and fph.PRO_CODE LIKE '%'||#{PRO_CODE}||'%'</if>
  		)t WHERE ROWNUM&lt;=#{PAGE_END}) t2 where t2.R&gt;=#{PAGE_BEGIN}
  	</select>
  	<select id="getPjcdDataCount" parameterType="map" resultType="int">
  		select count(1)
           from fil_rent_plan_head_max_v mv
                ,fil_project_head fph
                ,fil_cust_client fcc
               	,secu_user su
          where mv.STATUS in (0,4,7,8,26) and mv.POUNDAGE_WAY=1 and mv.START_DATE is not null and mv.DEPOSIT_SY>0
          		and mv.PROJECT_ID = fph.id and fph.client_id = fcc.id and su.code = fcc.clerk_code
          		<if test="CUST_NAME!=NULL and CUST_NAME!=''">and fcc.NAME LIKE '%'||#{CUST_NAME}||'%'</if>
				<if test="LEASE_CODE!=NULL and LEASE_CODE!=''">and fph.LEASE_CODE LIKE '%'||#{LEASE_CODE}||'%'</if>
		 		<if test="PRO_CODE!=NULL and PRO_CODE!=''">and fph.PRO_CODE LIKE '%'||#{PRO_CODE}||'%'</if>
  	</select>
  	<select id="getPjcdDataById" parameterType="map" resultType="map">
  		   select 
   				mv.ID 
   			   ,mv.PAYLIST_CODE --还款计划编号
   			   ,mv.STATUS --还款状态
               ,fcc.NAME CUST_NAME--客户名
               ,fcc.TEL_PHONE --客户电话
               ,su.NAME MANAGER_NAME	--客户经理
               ,nvl(mv.lease_topric, 0) * nvl(mv.deposit_rate, 0) / 100 BZJ --客户保证金
               ,fph.LEASE_CODE--合同编号
               ,fph.PRO_CODE -- 项目编号
               ,to_char(fph.create_time,'yyyy-MM-dd') CREATE_TIME --项目创建时间
               ,(select ROUND(NVL(sum(fb.beginning_money - fb.beginning_paid),
                                  0),
                              2) sy_zj
                   from fi_r_beginning fb
                  where fb.paylist_code = mv.paylist_code
                    and fb.beginning_num &lt;=mv.lease_term) SY_ZJ --剩余租金
               ,mv.DEPOSIT_SY --剩余保证金
               ,(select fr.beginning_num from fi_r_beginning fr where fr.paylist_code=mv.PAYLIST_CODE and trunc(sysdate)&lt;=trunc(fr.beginning_receive_data)  and rownum = 1 group by fr.beginning_num,fr.beginning_receive_data ) BEGINNING_NUM --当前期次
           from fil_rent_plan_head_max_v mv
                ,fil_project_head fph
                ,fil_cust_client fcc
               	,secu_user su
          where mv.id = #{ID}
          		and mv.PROJECT_ID = fph.id and fph.client_id = fcc.id and su.code = fcc.clerk_code
  	</select>
  	<select id="getPjcd_Fi_R_Beginning" parameterType="map" resultType="map">
  		 select fr.BEGINNING_NUM --期次
                  ,to_char(fr.BEGINNING_RECEIVE_DATA,'yyyy-MM-dd') BEGINNING_RECEIVE_DATA --应收时间
                  ,fr.ITEM_FLAG --1 首期款 2 租金 3 保证金
                  ,sum(fr.beginning_money) YS_MONEY --应收
                  ,(mv.DEPOSIT_SY/(mv.LEASE_TERM-#{BEGINNING_NUM}+1)) money --分摊金额
                  ,mv.LEASE_TERM --总期次
             from fi_r_beginning fr,fil_rent_plan_head_max_v mv
         		  where mv.PAYLIST_CODE=fr.paylist_code and (fr.beginning_num&lt;=mv.LEASE_TERM or fr.beginning_num is null) 
         		  	and mv.ID = #{ID} and fr.beginning_num >= #{BEGINNING_NUM}
            group by fr.beginning_num,fr.beginning_receive_data ,fr.item_flag,mv.LEASE_TERM,mv.DEPOSIT_SY order by fr.beginning_num
  	</select>
  	<select id="getPjcdById" parameterType="map" resultType="map">
  		 select  mv.id RENT_PLAN_HEAD_ID
  		 	,mv.PAYLIST_CODE --还款计划编号
            ,mv.STATUS --还款状态   
            ,mv.DEPOSIT_SY --剩余保证金
          from fil_rent_plan_head_max_v mv
          where mv.id = #{RENT_PLAN_HEAD_ID}
  	</select>
  	<select id="getProcessDataByRemark_Id" parameterType="map" resultType="map">
  		select 
           mv.ID 
            ,mv.PAYLIST_CODE --还款计划编号
            ,mv.STATUS --还款状态
            ,fcc.NAME CUST_NAME--客户名
            ,fcc.TEL_PHONE --客户电话
            ,su.NAME MANAGER_NAME  --客户经理
            ,nvl(mv.lease_topric, 0) * nvl(mv.deposit_rate, 0) / 100 BZJ --客户保证金
            ,fph.LEASE_CODE--合同编号
            ,fph.PRO_CODE -- 项目编号
            ,to_char(fph.create_time,'yyyy-MM-dd') CREATE_TIME --项目创建时间
            ,(select ROUND(NVL(sum(fb.beginning_money - fb.beginning_paid),
                               0),
                           2) sy_zj
                from fi_r_beginning fb
               where fb.paylist_code = mv.paylist_code
                 and fb.beginning_num &lt;=mv.lease_term) SY_ZJ --剩余租金
            ,(select fr.beginning_num from fi_r_beginning fr where fr.paylist_code=mv.PAYLIST_CODE and trunc(sysdate)&lt;=trunc(fr.beginning_receive_data)  and rownum = 1 group by fr.beginning_num,fr.beginning_receive_data ) BEGINNING_NUM --当前期次
       		,fbq.DEPOSIT_SY --剩余保证金
            ,fbq.GOBACK_TIME
        from fil_rent_plan_head_max_v mv
             ,fil_project_head fph
             ,fil_cust_client fcc
             ,secu_user su
             ,fi_bzj_qmcd_apply fbq
       where fbq.remark_id = #{ID}
           and mv.PROJECT_ID = fph.id and fph.client_id = fcc.id and su.code = fcc.clerk_code and fbq.rent_plan_head_id = mv.ID
  	</select>
  	<select id="getBzjQmdkDataList" parameterType="map" resultType="map">
  	select t2.* from (
  	  select t.*,ROWNUM R from (
  		 select 
	          mv.ID
	         ,mv.STATUS
	         ,mv.POUNDAGE_WAY --抵扣方式
	         ,(select ROUND(NVL(sum(fb.beginning_money - fb.beginning_paid), 0), 2) sy_zj from fi_r_beginning fb where fb.paylist_code = mv.paylist_code and fb.beginning_num &lt;=mv.lease_term) SY_ZJ --剩余租金
	         ,fph.LEASE_CODE
	         ,to_char(fph.create_time,'yyyy-MM-dd') CREATE_TIME --项目创建时间
	         ,mv.PAYLIST_CODE
	         ,fph.PRO_CODE
	         ,fcc.name CUST_NAME --客户
	         ,fcc.TEL_PHONE
	         ,su.name MANAGER_NAME --客户经理
	         ,nvl(mv.DEPOSIT_SY,0) DEPOSIT_SY--剩余保证金
	   from fil_rent_plan_head_max_v mv
	        ,fil_project_head fph
	        ,fil_cust_client fcc
	        ,secu_user su
	   where mv.START_DATE is not null and mv.STATUS in (0,4,7,8,24,3,6,25,26)
	        and mv.PROJECT_ID = fph.id and fph.client_id = fcc.id and su.code = fcc.clerk_code 
            <if test="CUST_NAME!=NULL and CUST_NAME!=''">and fcc.NAME LIKE '%'||#{CUST_NAME}||'%'</if>
			<if test="LEASE_CODE!=NULL and LEASE_CODE!=''">and fph.LEASE_CODE LIKE '%'||#{LEASE_CODE}||'%'</if>
		 	<if test="PAYLIST_CODE!=NULL and PAYLIST_CODE!=''">and fph.PAYLIST_CODE LIKE '%'||#{PAYLIST_CODE}||'%'</if>
		    order by mv.id desc
  		)t WHERE ROWNUM&lt;=#{PAGE_END}) t2 where t2.R&gt;=#{PAGE_BEGIN}
  	</select>
  	<select id="getBzjQmdkDataCount" parameterType="map" resultType="int">
  		select count(1)
	   from fil_rent_plan_head_max_v mv
	        ,fil_project_head fph
	        ,fil_cust_client fcc
	        ,secu_user su
	   where mv.START_DATE is not null and mv.STATUS in (0,4,7,8,24,3,6,25,26)
	         and mv.PROJECT_ID = fph.id and fph.client_id = fcc.id and su.code = fcc.clerk_code
            <if test="CUST_NAME!=NULL and CUST_NAME!=''">and fcc.NAME LIKE '%'||#{CUST_NAME}||'%'</if>
			<if test="LEASE_CODE!=NULL and LEASE_CODE!=''">and fph.LEASE_CODE LIKE '%'||#{LEASE_CODE}||'%'</if>
		 	<if test="PAYLIST_CODE!=NULL and PAYLIST_CODE!=''">and fph.PAYLIST_CODE LIKE '%'||#{PAYLIST_CODE}||'%'</if>
		order by mv.id desc
  	</select>
  	<select id="getCustNameBankInfo" parameterType="map" resultType="map">
  		select 
  			fcc.id CUST_ID
         	,fcc.name CUST_NAME
         	,(select f.BANK_NAME from fil_cust_openingbank f where f.client_id = fcc.id and rownum = 1 ) BANK_NAME --开户行
         	,(select f.BANK_ACCOUNT  from fil_cust_openingbank f where f.client_id = fcc.id and rownum = 1) BANK_ACCOUNT --银行账号
         	,mv.DEPOSIT_SY --剩余保证金
         	,mv.STATUS
            ,mv.ID RENT_PLAN_HEAD_ID
            ,mv.PAYLIST_CODE
 		from fil_rent_plan_head_max_v mv 
      		,fil_project_head fph
      		,fil_cust_client fcc
        where  mv.PROJECT_ID = fph.id and fph.client_id = fcc.id
      		and mv.PAYLIST_CODE = #{PAYLIST_CODE}
  	</select>
  	<update id="update_Deposit_sy" parameterType="map">
  		update fil_rent_plan_head frph set frph.DEPOSIT_SY = frph.deposit_sy - #{REFUND_MONEY} where frph.PAYLIST_CODE=#{PAYLIST_CODE}
  	</update>
  	<select id="getDataByPaylist_Code" parameterType="map" resultType="map">
  		select mv.STATUS,mv.IS_DUN_FLAG,mv.PAYLIST_CODE from fil_rent_plan_head_max_v mv where mv.PAYLIST_CODE in (#{array})
  	</select>
</mapper>