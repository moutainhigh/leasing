<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="rentAccountMonitoring">

<delete id="delTempRent">
delete from TEMP_RENT
</delete>

<insert id="addTempRent" parameterType="java.lang.String" >
INSERT INTO TEMP_RENT (ID,PRO_ID) VALUES (SEQ_TEMP_RENT.NEXTVAL,#{PRO_ID})
</insert>

<sql id="queryStatement">

select 

 PLATFORM_TYPE,flag,  PROJECT_ID,LEASE_CODE, 
 CONTRACTSTATUS
 , NAME,ID_CARD_NO,TEL_PHONE, CITYNAME, STORESNAME
,SCHEME_NAME,CARNAME
,CAR_SYMBOL , FINANCE_TOPRIC, FIRSTPAYALL , LEASE_TERM, MONTHRATE ,START_PERCENT ,  DEPOSIT_MONEY
,BEGINNING_MONEY,PREPAYRENT,INTERESTREDUCTION, FIRSTMONEY
,CROSSTOWNDATE , FIRSTDATE,ENDDATE
,to_char(A.PAYMENTSDATE,'yyyy-MM-dd') PAYMENTSDATE, RECEIVEPAYMENTSMONEY,RETURNRENT,
RESIDUALRENT , CURRENTPRINCIPAL,CURRENTINTEREST
,RESIDUALPRINCIPAL ,RESIDUALPERIOD
,ISYQ
,YQMONEY,PENALTY_DAY,PENALTY, WYJ_REALITY_TIME,PERIOD
, YQQS,REALITY_TIME,BEGINNING_PAID

 from (

SELECT H.PLATFORM_TYPE,tsdd.flag, H.ID PROJECT_ID, H.LEASE_CODE,

case 
WHEN H.CONTRACTSTATUS IS NULL OR H.CONTRACTSTATUS=0 OR H.CONTRACTSTATUS ='' THEN '正常'
WHEN H.CONTRACTSTATUS = 1  THEN '作废'
WHEN H.CONTRACTSTATUS = 2 THEN '合同终止'
WHEN H.CONTRACTSTATUS = 3 THEN '提前结清'
WHEN H.CONTRACTSTATUS = 4 THEN '逾期'
WHEN H.CONTRACTSTATUS = 5 THEN '损失'
end CONTRACTSTATUS


, FCL.NAME,FCL.ID_CARD_NO,FCL.TEL_PHONE,TSA.NAME CITYNAME, SO2.NAME STORESNAME
,TBS1.SCHEME_NAME,TP.PRODUCT_NAME||TPC.CATENA_NAME||TPT.NAME CARNAME
,FPE.CAR_SYMBOL ,FPS.FINANCE_TOPRIC||'' FINANCE_TOPRIC,FPS.FIRSTPAYALL||'' FIRSTPAYALL ,FPS.LEASE_TERM||'' LEASE_TERM,((FPS.YEAR_INTEREST)/12*100)||'%' MONTHRATE ,FPS.START_PERCENT||'' START_PERCENT , FPS.DEPOSIT_MONEY ||'' DEPOSIT_MONEY
,FRB1.BEGINNING_MONEY ||'' BEGINNING_MONEY,(NVL(FSC.VALUE_STR,0)* NVL(FRB1.BEGINNING_MONEY,0))||'' PREPAYRENT,'利息减免待处理' INTERESTREDUCTION,FRB1.BEGINNING_MONEY||'' FIRSTMONEY
,TO_CHAR(FER.RECEIVE_DATE,'yyyy-MM-dd') CROSSTOWNDATE ,TO_CHAR(FRB1.BEGINNING_RECEIVE_DATA,'yyyy-MM-dd') FIRSTDATE,TO_CHAR(add_months(FRB1.BEGINNING_RECEIVE_DATA ,FPS.LEASE_TERM-1),'yyyy-MM-dd') ENDDATE
,to_date('','yyyy-MM-dd') PAYMENTSDATE,'' RECEIVEPAYMENTSMONEY,FRB3.BEGINNING_PAID||'' RETURNRENT /*FRB2.BEGINNING_RECEIVE_DATA,FRB2.BEGINNING_MONEY,FRB2.BEGINNING_PAID*/,
(NVL(FRB3.BEGINNING_MONEY,0)-NVL(FRB3.BEGINNING_PAID,0))||'' RESIDUALRENT ,'' CURRENTPRINCIPAL,'' CURRENTINTEREST/*FRB2.BJ,FRB2.LX*/
,(NVL(FRB4.BEGINNING_MONEY,0)-NVL(FRB4.BEGINNING_PAID,0))||'' RESIDUALPRINCIPAL ,nvl(months_between((add_months(FRB1.BEGINNING_RECEIVE_DATA ,FPS.LEASE_TERM-1)),FRB5.HIREDATE),FPS.LEASE_TERM)||'' RESIDUALPERIOD
,''  ISYQ
,'' YQMONEY,'' PENALTY_DAY,'' PENALTY,''  WYJ_REALITY_TIME,'' PERIOD
,FOT1.YQQS||'' YQQS,TO_CHAR(FRB6.REALITY_TIME,'yyyy-MM-dd') REALITY_TIME,FRB6.BEGINNING_PAID||'' BEGINNING_PAID

FROM FIL_PROJECT_HEAD H

LEFT JOIN FIL_CUST_CLIENT FCL ON FCL.ID = H.CLIENT_ID

LEFT JOIN T_SYS_AREA TSA ON TSA.ID = H.CITY_ID

LEFT JOIN SECU_ORG SO ON SO.ID = H.ORD_ID

LEFT JOIN SECU_ORG SO1 ON SO1.ID = SO.PARENT_ID

LEFT JOIN SECU_ORG SO2 ON SO2.ID = SO1.PARENT_ID

LEFT JOIN FIL_PROJECT_SCHEME FPS ON FPS.PROJECT_ID = H.ID

LEFT JOIN V_BASE_SCHEME TBS1 ON  TBS1.Scheme_Code = FPS.SCHEME_CODE 

LEFT JOIN FIL_PROJECT_EQUIPMENT FPE ON FPE.PROJECT_ID = H.ID

LEFT JOIN T_PRODUCT TP ON TP.PRODUCT_ID = FPE.PRODUCT_ID

LEFT JOIN T_PRODUCT_CATENA TPC ON TPC.CATENA_ID = FPE.CATENA_ID

LEFT JOIN T_PRODUCT_TYPE TPT ON TPT.ID = FPE.SPEC_ID

LEFT JOIN (SELECT FRB.PROJECT_ID ,SUM(FRB.BEGINNING_MONEY) BEGINNING_MONEY ,FRB.BEGINNING_RECEIVE_DATA FROM FI_R_BEGINNING FRB WHERE FRB.BEGINNING_NUM =1  GROUP BY FRB.BEGINNING_NUM,FRB.BEGINNING_RECEIVE_DATA,FRB.ITEM_FLAG,FRB.PROJECT_ID ) FRB1 ON FRB1.PROJECT_ID = H.ID

LEFT JOIN FIL_SCHEME_CLOB FSC ON FSC.SCHEME_ID = FPS.ID AND FSC.KEY_NAME_ZN LIKE '%首期租金预付月数%'

LEFT JOIN FIL_EQUIPMENT_SENDNOTICE FES ON FES.PROJECT_ID = H.ID  and FES.status =0

LEFT JOIN FIL_EQUIMENT_RECEIPT FER ON FER.ID= FES.ID

LEFT JOIN (SELECT FRB.PROJECT_ID ,SUM(FRB.BEGINNING_MONEY) BEGINNING_MONEY ,SUM(FRB.BEGINNING_PAID) BEGINNING_PAID FROM FI_R_BEGINNING FRB WHERE FRB.ITEM_FLAG =2  GROUP BY FRB.ITEM_FLAG,FRB.PROJECT_ID  )FRB3 ON FRB3.PROJECT_ID = H.ID

LEFT JOIN (SELECT  FR.PROJECT_ID ,SUM(FR.BEGINNING_MONEY) BEGINNING_MONEY,SUM(FR.BEGINNING_PAID) BEGINNING_PAID   FROM FI_R_BEGINNING FR WHERE FR.BEGINNING_NAME ='本金'  GROUP BY FR.ITEM_FLAG,FR.PROJECT_ID  ) FRB4 ON FRB4.PROJECT_ID = H.ID

LEFT JOIN (SELECT PROJECT_ID, MAX(F.BEGINNING_RECEIVE_DATA) HIREDATE FROM FI_R_BEGINNING F WHERE  F.BEGINNING_NAME ='本金' AND F.BEGINNING_FLAG =1 GROUP BY PROJECT_ID)FRB5 ON FRB5.PROJECT_ID =H.ID

LEFT JOIN (SELECT PROJECT_ID ,COUNT(PROJECT_ID) YQQS FROM FI_OVERDUE_TREATMENTE FOT WHERE   FOT.PENALTY_PAID &lt; FOT.PENALTY_RECE GROUP BY PROJECT_ID ) FOT1 ON FOT1.PROJECT_ID = H.ID 

LEFT JOIN (SELECT PROJECT_ID , MAX(B.REALITY_TIME) REALITY_TIME ,MAX(B.BEGINNING_PAID) BEGINNING_PAID FROM FI_R_BEGINNING B 
WHERE B.BEGINNING_NAME ='本金' AND B.BEGINNING_FLAG =1  AND B.REALITY_TIME IS NOT NULL GROUP BY PROJECT_ID )FRB6  ON FRB6.PROJECT_ID = H.ID AND H.CONTRACTSTATUS = 3


LEFT JOIN t_sys_site_dictionary TSDD ON TSDD.TYPE ='业务类型' and TSDD.STATUS = 0 AND TSDD.CODE = H.PLATFORM_TYPE
--WHERE H.ID = 570987--550007 -- ORDER BY FRB2.BEGINNING_RECEIVE_DATA --550019


UNION ALL



SELECT FRB0.PLATFORM_TYPE, FRB0.FLAG,FRB0.PROJECT_ID,
 '' LEASE_CODE,'' CONTRACTSTATUS, '' NAME, '' ID_CARD_NO, '' TEL_PHONE,'' CITYNAME, '' STORESNAME
,'' SCHEME_NAME,'' CARNAME
,'' CAR_SYMBOL ,'' FINANCE_TOPRIC,'' FIRSTPAYALL , '' LEASE_TERM,'' MONTHRATE ,'' START_PERCENT , '' DEPOSIT_MONEY 
, '' BEGINNING_MONEY ,'' PREPAYRENT,'' interestReduction,'' FIRSTMONEY
,'' CROSSTOWNDATE ,'' FIRSTDATE,'' ENDDATE,

FRB0.BEGINNING_RECEIVE_DATA PAYMENTSDATE,FRB0.BEGINNING_MONEY||''  RECEIVEPAYMENTSMONEY,FRB0.BEGINNING_PAID||'' RETURNRENT 

, '' RESIDUALRENT ,FRB0.BJ||'' CURRENTPRINCIPAL,FRB0.LX||'' CURRENTINTEREST,'' RESIDUALPRINCIPAL,'' RESIDUALPERIOD

,CASE 
WHEN FRB0.ISYQ IS NOT NULL THEN '是'
ELSE '否'
END ISYQ
,FRB0.ISYQ||'' YQMONEY,FRB0.PENALTY_DAY||'' PENALTY_DAY,FRB0.PENALTY||'' PENALTY,TO_CHAR(FRB0.REALITY_TIME,'yyyy-MM-dd') WYJ_REALITY_TIME,FRB0.PERIOD||'' PERIOD

,'' YQQS ,'' REALITY_TIME,'' BEGINNING_PAID
FROM (

SELECT H.PLATFORM_TYPE,TSDD.FLAG,FRB.PROJECT_ID , FRB.BEGINNING_RECEIVE_DATA , SUM(FRB.BEGINNING_MONEY) BEGINNING_MONEY ,SUM(FRB.BEGINNING_PAID) BEGINNING_PAID,FRB.REALITY_TIME,FR.BEGINNING_MONEY BJ,FR2.BEGINNING_MONEY LX
,FT.LIQUIDATED_DAMAGES ISYQ,FT.PENALTY_DAY PENALTY_DAY,FT.PENALTY,FT.PERIOD

FROM FI_R_BEGINNING FRB 

LEFT JOIN FI_R_BEGINNING FR ON FR.BEGINNING_NAME='本金' AND FR.PROJECT_ID = FRB.PROJECT_ID and FR.BEGINNING_RECEIVE_DATA = FRB.BEGINNING_RECEIVE_DATA and FR.BEGINNING_NUM = FRB.BEGINNING_NUM

LEFT JOIN FI_R_BEGINNING FR2  ON  FR2.BEGINNING_NAME='利息' AND FR2.PROJECT_ID = FRB.PROJECT_ID and FR2.BEGINNING_RECEIVE_DATA = FRB.BEGINNING_RECEIVE_DATA  and FR2.BEGINNING_NUM = FRB.BEGINNING_NUM

LEFT JOIN FI_OVERDUE_TREATMENTE FT ON FT.PROJECT_ID = FRB.PROJECT_ID AND FT.PERIOD = FRB.BEGINNING_NUM AND FT.PENALTY_PAID &lt; FT.PENALTY_RECE

LEFT JOIN FIL_PROJECT_HEAD H ON H.ID = FRB.PROJECT_ID

LEFT JOIN t_sys_site_dictionary TSDD ON TSDD.TYPE ='业务类型' and TSDD.STATUS = 0 AND TSDD.CODE = H.PLATFORM_TYPE

WHERE FRB.ITEM_FLAG =2  and FRB.BEGINNING_MONEY >0  /*AND FRB.PROJECT_ID =570987*/  GROUP BY FRB.BEGINNING_NUM,FRB.BEGINNING_RECEIVE_DATA,FRB.ITEM_FLAG,FRB.PROJECT_ID,FRB.REALITY_TIME,FR.BEGINNING_MONEY,FR2.BEGINNING_MONEY,FT.LIQUIDATED_DAMAGES
,FT.PENALTY_DAY ,FT.PENALTY,FT.PERIOD,TSDD.FLAG ,H.PLATFORM_TYPE ) FRB0

)A
WHERE 

A.project_id  IN (<!-- SELECT PRO_ID FROM TEMP_RENT -->

 SELECT  PROJECT_ID FROM FI_R_BEGINNING B
 
 LEFT JOIN  FIL_PROJECT_HEAD H ON H.ID = B.PROJECT_ID
 
 LEFT JOIN FIL_CUST_CLIENT FCC ON FCC.ID=H.CLIENT_ID
 
--WHERE B.BEGINNING_RECEIVE_DATA = TO_DATE('2016/7/1','YYYY-MM-dd')
  
--AND  H.LEASE_CODE = '2423423sdf' AND H.PLATFORM_TYPE = 13 AND FCC.NAME = '欧阳天热' 
  
  WHERE  H.lease_code is not null 
<if test="YW_TYPE != null and YW_TYPE !=''">AND H.PLATFORM_TYPE = #{YW_TYPE} </if>
<if test="NAME != null and NAME !=''">AND  FCC.NAME = #{NAME} </if>
<if test="LEASE_CODE != null and LEASE_CODE !=''">AND  H.LEASE_CODE  = #{LEASE_CODE} </if>
<if test="PLAN_START_DATE != null and PLAN_START_DATE !=''">AND   B.BEGINNING_RECEIVE_DATA = TO_DATE( #{PLAN_START_DATE} ,'yyyy-MM-dd') </if>
  
 GROUP BY B.PROJECT_ID

) 
<!-- <foreach collection="proList" item="item" open="("
				separator="," close=")">
					#{item}
			</foreach> -->
ORDER BY  A.PROJECT_ID ,LEASE_CODE ,A.PAYMENTSDATE
</sql>

	
	<!-- 查询初始化 -->
	
	<select id ="selectInit" parameterType="java.util.Map" resultType="java.util.Map">
	 
 SELECT  PROJECT_ID FROM FI_R_BEGINNING B
 
 LEFT JOIN  FIL_PROJECT_HEAD H ON H.ID = B.PROJECT_ID
 
 LEFT JOIN FIL_CUST_CLIENT FCC ON FCC.ID=H.CLIENT_ID
 
--WHERE B.BEGINNING_RECEIVE_DATA = TO_DATE('2016/7/1','YYYY-MM-dd')
  
--AND  H.LEASE_CODE = '2423423sdf' AND H.PLATFORM_TYPE = 13 AND FCC.NAME = '欧阳天热' 
  
  WHERE  H.lease_code is not null 
<if test="YW_TYPE != null and YW_TYPE !=''">AND H.PLATFORM_TYPE = #{YW_TYPE} </if>
<if test="NAME != null and NAME !=''">AND  FCC.NAME = #{NAME} </if>
<if test="LEASE_CODE != null and LEASE_CODE !=''">AND  H.LEASE_CODE  = #{LEASE_CODE} </if>
<if test="PLAN_START_DATE != null and PLAN_START_DATE !=''">AND   B.BEGINNING_RECEIVE_DATA = TO_DATE( #{PLAN_START_DATE} ,'yyyy-MM-dd') </if>
  
 GROUP BY B.PROJECT_ID
	</select>

	<!-- 查询按钮start -->
	<select id="query" parameterType="java.util.Map" resultType="java.util.Map">
		 SELECT * FROM (
		SELECT CC.*,ROWNUM ROWNO FROM ( 
		<include refid="queryStatement" />
		 ) CC where rownum
		&lt;=#{PAGE_END1}
		) CCC
		WHERE CCC.ROWNO
		>=
		#{PAGE_BEGIN1} 

	</select>
	<select id="queryCount" parameterType="java.util.Map"
		resultType="int">
		select count(*) from (
		<include refid="queryStatement" />
		)tt
	</select>
	<!-- 查询按钮end -->


	<!-- 未锁定全部导出start -->
	<select id="excelALL" parameterType="java.util.Map" resultType="java.util.Map">
		<include refid="queryStatement" />
	</select>
	<!-- 未锁定全部导出end -->

</mapper>