<?xml version="1.0" encoding="GBK"?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="targetCompany">
<select id="toMgTargetCompany" parameterType="Map" resultType="Map">
	SELECT TT.* FROM (
	   SELECT T.*,ROWNUM ROWNO FROM (
		   SELECT SUP.SUP_ID,
		          SUP.SCODE,
				  SUP.SUP_FLAG,
				  SUP.SUP_CODE,
				  SUP.SUP_NAME,
				  SUP.SUP_SHORTNAME,
				  SUP.COMPANY_ID,
				  SUP.CORP_BUSINESS_LICENSE,
				  SUP.SUP_ADDRESS,
				  SUP.SUP_FAX,
				  SUP.SUP_ZIP,
				  SUP.ORAGNIZATION_CODE,
				  SUP.TAX_CODE,
				  SUP.CREDIT_GRADE,
				  TO_CHAR(SUP.SETUP_DATE,'YYYY-MM-DD') SETUP_DATE,
				  TO_CHAR(SUP.PERIOD_VALIDITY,'YYYY-MM-DD') PERIOD_VALIDITY,
				  SUP.REGISTE_CAPITAL,
				  SUP.PAICLUP_CAPITAL,
				  SUP.BUSINESS_RANGE,
				  SUP.SUP_WEBSITE,
				  SUP.SUP_MANAGER,
				  SUP.PRO_INDUSTRY,
				  SUP.IS_REPO,
				  SUP.AREA_ID,
				  (SELECT AR.NAME FROM T_SYS_AREA AR WHERE AR.ID=SUP.AREA_ID) AREA_NAME,
				  SUP.PROV_ID,
				  (SELECT AR.NAME FROM T_SYS_AREA AR WHERE AR.ID=SUP.PROV_ID) PROV_NAME,
				  SUP.CITY_ID,
				  (SELECT AR.NAME FROM T_SYS_AREA AR WHERE AR.ID=SUP.CITY_ID) CITY_NAME,
				  TO_CHAR(SUP.SIGN_DATE,'YYYY-MM-DD') SIGN_DATE,
				  SUP.OPEN_BANK,
				  SUP.OPEN_BANK_NUMBER,
				  SUP.SUP_LEGAL_NAME,
				  SUP.SUP_LEGAL_PHONE,
				  SUP.SUP_LEGAL_MOBIL,
				  SUP.SUB_LEGAL_ADDRESS,
				  SUP.SUB_LEGAL_EMAIL,
				  SUP.BILL_ADDRESS,
				  SUP.BILL_PHONE,
				  SUP.TAX_QUAL,
				  SUP.TAX_IDEN_NUM,
				  SUP.EMS_TO_NAME,
				  SUP.EMS_TO_ADDRESS,
				  SUP.EMS_TO_PHONE,
				  SUP.EMS_TO_ZIP,
				  SUP.LOANS_OWN_UNIT,
				  SUP.LOANS_OWN_ADDR,
				  SUP.LOANS_OWN_BANK,
				  SUP.LOANS_OWN_ACCOUNT,
				  SUP.LOANS_TOTAL_UNIT,
				  SUP.LOANS_TOTAL_ADDDR,
				  SUP.LOANS_TOTAL_BANK,
				  SUP.LOANS_TOTAL_ACCOUNT,
				  SUP.SUB_SCORE,
				  SUP.FILE_NUMBER,
				  SUP.USER_ID,
				  SUP.CREATE_DATE,
				  SUP.SUP_LEVEL,
				  NVL(SUP.SUP_SWITCH,0) SUP_SWITCH,
				  NVL(SUP.SCAN_SWITCH,0) SCAN_SWITCH,
				  NVL(SUP.CREDIT_SWITCH,0) CREDIT_SWITCH,
				  NVL(SUP.PAYMENT_SWITCH,0) PAYMENT_SWITCH, 
				  NVL(SUP.YINGYE_STATUS,0) YINGYE_STATUS,
				  NVL(SUP.BALANCE_LOAN_SWITCH,0) BALANCE_LOAN_SWITCH,
				  NVL(SUP.IRREGULAR_REPAYMENT_SWITCH,0) IRREGULAR_REPAYMENT_SWITCH,
				  NVL(SUP.B_MODEL_SWITCH,0) B_MODEL_SWITCH,
				  NVL(SUP.SMS_SWITCH,0) SMS_SWITCH,
				  NVL(SUP.DATAFILL_SWITCH,0) DATAFILL_SWITCH,
				  (SELECT DIC.FLAG FROM T_SYS_DATA_DICTIONARY DIC WHERE DIC.CODE = SUP.STATUS AND DIC.TYPE = #{DIC_SUP_STATUS}) STATUS,
				  COM.BUSINESS_SECTOR,
				  TTT.ZLSTATUS,
				  SUP.SCORE,
				  SUP.SUP_TYPE
			 FROM T_SYS_SUPPLIERS SUP,
			      T_SYS_COMPANY COM,
			      --存在已到期未补齐的项目 STATUS是4
			      (SELECT  VESC.SUPPLIER_IDS SUPPLIER_ID,
						   FPSI.STATUS ZLSTATUS
				   FROM FIL_PROJ_SUB_INFO FPSI
				   LEFT JOIN FIL_PROJECT_HEAD FPH
				     ON FPH.ID = FPSI.PROJ_ID
				   LEFT JOIN FIL_CUST_CLIENT FCC
				     ON FCC.ID = FPH.CLIENT_ID
				   LEFT JOIN V_EQUIPMENT_SUPS_COMS VESC
				     ON VESC.PROJECT_ID = FPH.ID
				   LEFT JOIN T_SYS_DATA_DICTIONARY TSDD
				     ON TSDD.TYPE = '资料补齐状态'
				    AND FPSI.STATUS = TSDD.CODE
				  WHERE FPH.PRO_CODE NOT LIKE '%TEST%'
				    AND FPSI.QZ_DATE IS NOT NULL 
				    AND FPSI.STATUS = 4
			   GROUP BY VESC.SUPPLIER_IDS,FPSI.STATUS) TTT
			WHERE SUP.COMPANY_ID = COM.COMPANY_ID(+)
			 AND SUP.SUP_ID = TTT.SUPPLIER_ID(+) 
			<if test="SUP_NAME !=null and SUP_NAME !=''">AND SUP.SUP_NAME LIKE  '%${SUP_NAME}%'</if>
			<if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND SUP.SUP_SHORTNAME LIKE  '%${SUP_SHORTNAME}%'</if>
			<if test="BUSINESS_SECTOR !=null and BUSINESS_SECTOR !=''">AND COM.BUSINESS_SECTOR = #{BUSINESS_SECTOR}</if>
			<if test="CREATE_TIME !=null and CREATE_TIME !=''">AND SUP.CREATE_DATE = TO_DATE(#{CREATE_TIME},'YYYY-MM-DD')</if>
			--经销商和集团
			AND SUP.SUP_TYPE = 5
			<if test="SYS_BIGAREAID != null and SYS_BIGAREAID != ''">and SUP.AREA_ID = #{SYS_BIGAREAID}</if>
			ORDER BY SUP.CREATE_DATE DESC
	 )T)TT WHERE ROWNO BETWEEN #{PAGE_BEGIN} AND #{PAGE_END}
</select>

<select id="toMgTargetCompanyC" parameterType="Map" resultType="int">
   SELECT COUNT(1)
	 FROM T_SYS_SUPPLIERS SUP,
	      T_SYS_COMPANY COM
	WHERE SUP.COMPANY_ID = COM.COMPANY_ID(+)
	<if test="SUP_NAME !=null and SUP_NAME !=''">AND SUP.SUP_NAME LIKE  '%${SUP_NAME}%'</if>
	<if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND SUP.SUP_SHORTNAME LIKE  '%${SUP_SHORTNAME}%'</if>
	<if test="BUSINESS_SECTOR !=null and BUSINESS_SECTOR !=''">AND COM.BUSINESS_SECTOR = #{BUSINESS_SECTOR}</if>
	<if test="CREATE_TIME !=null and CREATE_TIME !=''">AND SUP.CREATE_DATE = TO_DATE(#{CREATE_TIME},'YYYY-MM-DD')</if>
	AND SUP.SUP_TYPE = 5
</select>
</mapper>