<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="VatInvoice">
<select id="getFirstPayApplyList" parameterType="Map" resultType="Map">
  SELECT * FROM (
SELECT S.*,NVL(S.ACCRUE_MONEY,0)+NVL(S.STARTLX_MONEY,0)+NVL(S.FIRSTRENT_MONEY,0)+${COLUMNSITEMTOTALMONEY} TOTAL_MONEY,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.PAYLIST_CODE,
         TT.PAY_WAY,
         MAX(DECODE(T.BEGINNING_NAME,'首期租金',T.BEGINNING_MONEY)) ACCRUE_MONEY,
         CASE WHEN TT.PAY_WAY IN (2,4,6) THEN sum(DECODE(T.BEGINNING_NAME,'第一期租金',T.BEGINNING_MONEY))
           ELSE 0 END FIRSTRENT_MONEY,
		 CASE WHEN TT.PAY_WAY IN (2,4,6) THEN MAX(DECODE(T.BEGINNING_NAME,'租前利息',T.BEGINNING_MONEY))
           ELSE 0 END STARTLX_MONEY,
         ${COLUMNSITEM},
		 GETDICTSITEDATABYCODE('业务类型',TT.MULTIPLE_MODEL) PROJECT_MODEL,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TTT.SHOW_NODE,
         TTT.TAX_TYPE,
         TT.LEASE_CODE,
		 TT.PAY_ID,
		 TT.MULTIPLE_MODEL,
		 TTT.TAX_RATE
    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  CASE WHEN (BA.PERIOD = 1 and BA.D_PAY_PROJECT='利息增值税') THEN '第一期租金' WHEN (BA.PERIOD = 1 and BA.D_PAY_PROJECT='手续费') THEN '第一期租金' WHEN (BA.PERIOD = 1 and BA.D_PAY_PROJECT='管理费') THEN '第一期租金' WHEN BA.D_PAY_PROJECT='本金' THEN '第一期租金' WHEN BA.D_PAY_PROJECT='利息' THEN '租前利息' ELSE BA.D_PAY_PROJECT END BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.RE_STATUS = 0 AND BA.RED_STATUS = 0 AND BA.D_STATUS=0
              AND (BA.PERIOD = 1 OR BA.PERIOD IS NULL)
              AND BA.D_PAY_PROJECT IN(<include refid="aykpColumns"/>)
         )W
   LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND ((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD 
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
        SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
     WHERE  TTT.IF_INVOICE = 1 
        AND TT.PROJECT_STATUS >= TTT.SHOW_NODE 
        AND TT.IS_INVOICE_MONTH = '按月开具' 
        AND TT.PRO_CODE NOT LIKE '%TEST%'
      GROUP BY TT.SUP_SHORTNAME,T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START
	  ,TT.PAY_WAY, TT.ON_CARD,TTT.SHOW_NODE,TTT.TAX_TYPE,TT.LEASE_CODE,TT.PAY_ID,TT.MULTIPLE_MODEL,TTT.TAX_RATE
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE
  )S WHERE NVL(S.ACCRUE_MONEY,0)+NVL(S.FIRSTRENT_MONEY,0)+NVL(S.STARTLX_MONEY,0)+${COLUMNSITEMTOTALMONEY} !=0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND S.MULTIPLE_MODEL= #{PLATFORM_TYPE}</if>
  AND <![CDATA[ROWNUM <= #{PAGE_END}]]>
  )SS  WHERE SS.ROWNO >=#{PAGE_BEGIN}
</select>

<select id="getFirstPayApplyCount" parameterType="Map" resultType="int">
SELECT COUNT(1) FROM (    
  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.PAYLIST_CODE,
         TT.PAY_WAY,
         MAX(DECODE(T.BEGINNING_NAME,'首期租金',T.BEGINNING_MONEY)) ACCRUE_MONEY,
         CASE WHEN TT.PAY_WAY IN (2,4,6) THEN sum(DECODE(T.BEGINNING_NAME,'第一期租金',T.BEGINNING_MONEY))
           ELSE 0 END FIRSTRENT_MONEY,
		 CASE WHEN TT.PAY_WAY IN (2,4,6) THEN MAX(DECODE(T.BEGINNING_NAME,'租前利息',T.BEGINNING_MONEY))
           ELSE 0 END STARTLX_MONEY,
        ${COLUMNSITEM},
		 GETDICTSITEDATABYCODE('业务类型',TT.MULTIPLE_MODEL) PROJECT_MODEL,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TTT.SHOW_NODE,
         TTT.TAX_TYPE,
         TT.LEASE_CODE,
		 TT.PAY_ID,
		 TT.MULTIPLE_MODEL,
		 TTT.TAX_RATE
    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  CASE WHEN (BA.PERIOD = 1 and BA.D_PAY_PROJECT='利息增值税') THEN '第一期租金' WHEN (BA.PERIOD = 1 and BA.D_PAY_PROJECT='手续费') THEN '第一期租金' WHEN (BA.PERIOD = 1 and BA.D_PAY_PROJECT='管理费') THEN '第一期租金' WHEN BA.D_PAY_PROJECT='本金' THEN '第一期租金' WHEN BA.D_PAY_PROJECT='利息' THEN '租前利息' ELSE BA.D_PAY_PROJECT END BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.RE_STATUS = 0 AND BA.RED_STATUS = 0  AND BA.D_STATUS=0
              AND (BA.PERIOD = 1 OR BA.PERIOD IS NULL)
              AND BA.D_PAY_PROJECT IN(<include refid="aykpColumns"/>)
         )W
    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD 
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
        )TT ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
        SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
   WHERE TTT.IF_INVOICE = 1 
        AND TT.PROJECT_STATUS >= TTT.SHOW_NODE 
        AND TT.IS_INVOICE_MONTH = '按月开具' 
        AND TT.PRO_CODE NOT LIKE '%TEST%'
   GROUP BY TT.SUP_SHORTNAME,T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START
	  ,TT.PAY_WAY, TT.ON_CARD,TTT.SHOW_NODE,TTT.TAX_TYPE,TT.LEASE_CODE,TT.PAY_ID,TT.MULTIPLE_MODEL,TTT.TAX_RATE
  )S WHERE NVL(S.ACCRUE_MONEY,0)+NVL(S.FIRSTRENT_MONEY,0)+NVL(S.STARTLX_MONEY,0)+${COLUMNSITEMTOTALMONEY} !=0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
   <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND S.MULTIPLE_MODEL= #{PLATFORM_TYPE}</if>
</select>

<select id="getAllFirstInviceMess" parameterType="Map" resultType="Map">
SELECT S.*,NVL(S.ACCRUE_MONEY,0)+NVL(S.FIRSTRENT_MONEY,0)+NVL(S.STARTLX_MONEY,0)+${COLUMNSITEMTOTALMONEY} INVOICE_AMT FROM (    
  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.PAYLIST_CODE,
         TT.PAY_WAY,
         MAX(DECODE(T.BEGINNING_NAME,'首期租金',T.BEGINNING_MONEY)) ACCRUE_MONEY,
         CASE WHEN TT.PAY_WAY IN (2,4,6) THEN sum(DECODE(T.BEGINNING_NAME,'第一期租金',T.BEGINNING_MONEY))
           ELSE 0 END FIRSTRENT_MONEY,
		 CASE WHEN TT.PAY_WAY IN (2,4,6) THEN MAX(DECODE(T.BEGINNING_NAME,'租前利息',T.BEGINNING_MONEY))
           ELSE 0 END STARTLX_MONEY,
         ${COLUMNSITEM},
		 GETDICTSITEDATABYCODE('业务类型',TT.MULTIPLE_MODEL) PROJECT_MODEL,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TTT.SHOW_NODE,
         TTT.TAX_TYPE,
         TT.LEASE_CODE,
		 TT.PAY_ID,
		 TT.MULTIPLE_MODEL,
		 TTT.TAX_RATE
    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           W.ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  CASE WHEN (BA.PERIOD = 1 and BA.D_PAY_PROJECT='利息增值税') THEN '第一期租金' WHEN (BA.PERIOD = 1 and BA.D_PAY_PROJECT='手续费') THEN '第一期租金' WHEN (BA.PERIOD = 1 and BA.D_PAY_PROJECT='管理费') THEN '第一期租金' WHEN BA.D_PAY_PROJECT='本金' THEN '第一期租金' WHEN BA.D_PAY_PROJECT='利息' THEN '租前利息' ELSE BA.D_PAY_PROJECT END BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.RE_STATUS = 0 AND BA.RED_STATUS = 0  AND BA.D_STATUS=0
              AND (BA.PERIOD = 1 OR BA.PERIOD IS NULL)
              AND BA.D_PAY_PROJECT IN(<include refid="aykpColumns"/>)
         )W
    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND ((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD 
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
       SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE 
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if> 
     WHERE TTT.IF_INVOICE = 1 
        AND TT.PROJECT_STATUS >= TTT.SHOW_NODE 
        AND TT.IS_INVOICE_MONTH = '按月开具' 
        AND TT.PRO_CODE NOT LIKE '%TEST%'
   GROUP BY TT.SUP_SHORTNAME,T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START
	  ,TT.PAY_WAY, TT.ON_CARD,TTT.SHOW_NODE,TTT.TAX_TYPE,TT.LEASE_CODE,TT.PAY_ID,TT.MULTIPLE_MODEL,TTT.TAX_RATE
       ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE
  )S WHERE NVL(S.ACCRUE_MONEY,0)+NVL(S.FIRSTRENT_MONEY,0)+NVL(S.STARTLX_MONEY,0)+${COLUMNSITEMTOTALMONEY} !=0
   <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND S.MULTIPLE_MODEL= #{PLATFORM_TYPE}</if>
</select>

<select id="getRentApplyList" parameterType="Map" resultType="Map">
SELECT * FROM (
SELECT S.*,NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0)+NVL(S.OVER_PRICE,0)+NVL(S.SXF_PRICE,0)+NVL(S.GLF_PRICE,0)+NVL(S.LXZZS_PRICE,0) RENT_PRICE,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.BEGINNING_NUM,
         T.ITEM_FLAG,
         T.PAYLIST_CODE,
         CASE WHEN TT.PAY_WAY IN (2,4,6) AND T.BEGINNING_NUM =1
         THEN MAX(DECODE(T.BEGINNING_NAME,'本金',0)) 
         ELSE MAX(DECODE(T.BEGINNING_NAME,'本金',T.BEGINNING_MONEY)) END CAPITAL_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'利息',T.BEGINNING_MONEY)) INTEREST_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'违约金',T.BEGINNING_MONEY)) OVER_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'手续费',T.BEGINNING_MONEY)) SXF_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'管理费',T.BEGINNING_MONEY)) GLF_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'利息增值税',T.BEGINNING_MONEY)) LXZZS_PRICE,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TTT.SHOW_NODE,
         TTT.TAX_TYPE,
		 TT.LEASE_CODE,
		 TT.PAY_ID,
		 TTT.TAX_RATE
     FROM ( SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           CASE WHEN W.ITEM_FLAG = 1 THEN '租金' ELSE '违约金' END ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  BA.D_PAY_PROJECT BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.RED_STATUS = 0
              AND BA.D_STATUS IN(1,2)
         )W
    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND W.BEGINNING_NUM = WW.RENT_LIST 
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.PRO_NAME,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD 
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
        AND FIA.INVOICEPATTERN in ('FP_MONTH','FP_ALL')
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
       SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if>
      WHERE TTT.IF_INVOICE = 1 
        AND TT.PROJECT_STATUS >= TTT.SHOW_NODE 
        AND ((TT.IS_INVOICE_MONTH in ('按月开具','提前开具')  AND T.BEGINNING_NAME='违约金') or (TT.IS_INVOICE_MONTH='按月开具' and T.BEGINNING_NAME !='违约金'))
        AND TT.PRO_CODE NOT LIKE '%TEST%'
      GROUP BY TT.SUP_SHORTNAME, T.BEGINNING_NUM, T.ITEM_FLAG, T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START, TT.ON_CARD,TT.PAY_WAY,TT.SUB_COMPANY_NAME, TTT.SHOW_NODE,TTT.TAX_TYPE,TT.LEASE_CODE,TT.PAY_ID,TTT.TAX_RATE         
      ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE,T.BEGINNING_NUM,nlssort(T.ITEM_FLAG,'NLS_SORT=SCHINESE_PINYIN_M')
  )S WHERE NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0)+NVL(S.OVER_PRICE,0)+NVL(S.SXF_PRICE,0)+NVL(S.GLF_PRICE,0)+NVL(S.LXZZS_PRICE,0) >0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE != null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE != null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
  AND <![CDATA[ROWNUM <= #{PAGE_END} ]]>
  )SS  WHERE SS.ROWNO >=#{PAGE_BEGIN}
</select>

<select id="getRentApplyCount" parameterType="Map" resultType="int">
SELECT COUNT(1) FROM (
SELECT S.*,NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0)+NVL(S.OVER_PRICE,0)+NVL(S.SXF_PRICE,0)+NVL(S.GLF_PRICE,0)+NVL(S.LXZZS_PRICE,0) RENT_PRICE,ROWNUM ROWNO FROM (    
  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.BEGINNING_NUM,
         T.ITEM_FLAG,
         T.PAYLIST_CODE,
         CASE WHEN TT.PAY_WAY IN (2,4,6) AND T.BEGINNING_NUM =1
         THEN MAX(DECODE(T.BEGINNING_NAME,'本金',0)) 
         ELSE MAX(DECODE(T.BEGINNING_NAME,'本金',T.BEGINNING_MONEY)) END CAPITAL_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'利息',T.BEGINNING_MONEY)) INTEREST_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'违约金',T.BEGINNING_MONEY)) OVER_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'手续费',T.BEGINNING_MONEY)) SXF_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'管理费',T.BEGINNING_MONEY)) GLF_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'利息增值税',T.BEGINNING_MONEY)) LXZZS_PRICE,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TTT.SHOW_NODE,
         TTT.TAX_TYPE,
		 TT.LEASE_CODE,
		 TT.PAY_ID,
		 TTT.TAX_RATE
     FROM ( SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           CASE WHEN W.ITEM_FLAG = 1 THEN '租金' ELSE '违约金' END ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  BA.D_PAY_PROJECT BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.RED_STATUS = 0
              AND BA.D_STATUS IN(1,2)
         )W
    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1  AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND W.BEGINNING_NUM = WW.RENT_LIST 
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
                 HE.PRO_NAME,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD 
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
        AND FIA.INVOICEPATTERN in ('FP_MONTH','FP_ALL')
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
       SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if>
      WHERE  TTT.IF_INVOICE = 1
       	AND TT.PROJECT_STATUS >= TTT.SHOW_NODE 
       	AND ((TT.IS_INVOICE_MONTH in ('按月开具','提前开具')  AND T.BEGINNING_NAME='违约金') or (TT.IS_INVOICE_MONTH='按月开具' and T.BEGINNING_NAME !='违约金'))
       	AND TT.PRO_CODE NOT LIKE '%TEST%'
      GROUP BY TT.SUP_SHORTNAME, T.BEGINNING_NUM, T.ITEM_FLAG, T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START,TT.SUB_COMPANY_NAME, TT.ON_CARD,TT.PAY_WAY, TTT.SHOW_NODE,TTT.TAX_TYPE,TT.LEASE_CODE,TT.PAY_ID,TTT.TAX_RATE     
  )S WHERE NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0)+NVL(S.OVER_PRICE,0)+NVL(S.SXF_PRICE,0)+NVL(S.GLF_PRICE,0)+NVL(S.LXZZS_PRICE,0)>0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE != null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE != null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
)SS
</select>

<select id="getAllRentInvoiceMess" parameterType="Map" resultType="Map">
SELECT S.*,NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0)+NVL(S.OVER_PRICE,0)+NVL(S.SXF_PRICE,0)+NVL(S.GLF_PRICE,0)+NVL(S.LXZZS_PRICE,0) INVOICE_AMT FROM (    
  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.BEGINNING_NUM,
         T.ITEM_FLAG,
         T.PAYLIST_CODE,
         CASE WHEN TT.PAY_WAY IN (2,4,6) AND T.BEGINNING_NUM =1
         THEN MAX(DECODE(T.BEGINNING_NAME,'本金',0)) 
         ELSE MAX(DECODE(T.BEGINNING_NAME,'本金',T.BEGINNING_MONEY)) END CAPITAL_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'利息',T.BEGINNING_MONEY)) INTEREST_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'违约金',T.BEGINNING_MONEY)) OVER_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'手续费',T.BEGINNING_MONEY)) SXF_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'管理费',T.BEGINNING_MONEY)) GLF_PRICE,
         MAX(DECODE(T.BEGINNING_NAME,'利息增值税',T.BEGINNING_MONEY)) LXZZS_PRICE,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TT.SUP_SHORTNAME,
         TTT.SHOW_NODE,
         TTT.TAX_TYPE,
		 TT.LEASE_CODE,
		 TT.PAY_ID,
		 TTT.TAX_RATE     
    FROM ( SELECT W.BEGINNING_RECEIVE_DATA,
           W.BEGINNING_NUM,
           CASE WHEN W.ITEM_FLAG = 1 THEN '租金' ELSE '违约金' END ITEM_FLAG,
           W.PAYLIST_CODE,
           W.BEGINNING_NAME,
           W.BEGINNING_MONEY 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  BA.PERIOD BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  BA.D_PAY_PROJECT BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH
            WHERE BA.D_FUND_ID = FH.ID AND FH.FI_STATUS =2 AND BA.RED_STATUS = 0
              AND BA.D_STATUS IN(1,2)
         )W
    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.RENT_LIST,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID
                FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1 AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
              )WW ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
              AND W.BEGINNING_NUM = WW.RENT_LIST 
	          AND W.BEGINNING_NAME = WW.ITEM_NAME
	        WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
           SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
                 HE.PRO_NAME,
				 V.PAY_ID,
				 HE.LEASE_CODE,
                 HE.CLIENT_ID,
                 HE.STATUS PROJECT_STATUS,
                 V.company_name SUB_COMPANY_NAME,
                 CL.NAME CLIENT_NAME,
                 V.START_DATE CONFIRM_DATE_START,
                 V.START_DATE CONFIRM_DATE_END,
                 V.PAY_WAY,
                 CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                 V.platform_type MULTIPLE_MODEL,
                 getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                 V.PAYLIST_CODE,
                 V.SUP_NAME SUP_SHORTNAME,
                 GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD 
          FROM  v_plan_scheme V,
                FIL_PROJECT_HEAD HE,
		        FIL_CUST_CLIENT CL,
            FIL_INVOICE_APPLICATION FIA
		  WHERE V.PROJECT_ID =HE.ID
		    AND HE.CLIENT_ID = CL.ID
        AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
        AND FIA.INVOICEPATTERN in ('FP_MONTH','FP_ALL')
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
        SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
       ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
       ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
       ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if>
      WHERE TTT.IF_INVOICE = 1
       	AND TT.PROJECT_STATUS >= TTT.SHOW_NODE 
       	AND ((TT.IS_INVOICE_MONTH in ('按月开具','提前开具')  AND T.BEGINNING_NAME='违约金') or (TT.IS_INVOICE_MONTH='按月开具' and T.BEGINNING_NAME !='违约金'))
       	AND TT.PRO_CODE NOT LIKE '%TEST%'
      GROUP BY TT.SUP_SHORTNAME, T.BEGINNING_NUM, T.ITEM_FLAG, T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START,TT.SUB_COMPANY_NAME, TT.ON_CARD,TT.PAY_WAY, TTT.SHOW_NODE,TTT.TAX_TYPE,TT.LEASE_CODE,TT.PAY_ID,TTT.TAX_RATE     
     ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE,T.BEGINNING_NUM,nlssort(T.ITEM_FLAG,'NLS_SORT=SCHINESE_PINYIN_M')
  )S WHERE NVL(S.CAPITAL_PRICE,0)+NVL(S.INTEREST_PRICE,0)+NVL(S.OVER_PRICE,0)+NVL(S.SXF_PRICE,0)+NVL(S.GLF_PRICE,0)+NVL(S.LXZZS_PRICE,0) >0
  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
  <if test="STOP_TIME !=null and STOP_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{STOP_TIME}]]></if>
  <if test="BEGIN_TIME !=null and BEGIN_TIME !=''">AND S.BEGINNING_RECEIVE_DATA >= #{BEGIN_TIME}</if>
  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.BEGINNING_RECEIVE_DATA <= #{END_TIME}]]></if>
  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
  <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
  <if test="PRO_NAME !=null and PRO_NAME !=''">AND S.PRO_NAME LIKE '%${PRO_NAME}%'</if>
  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
  <if test="LEASE_CODE != null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
  <if test="PAYLIST_CODE != null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
</select>

<select id="getVatHeXiaoList" parameterType="Map" resultType="Map">
SELECT * FROM (
SELECT TTT.*,ROWNUM ROWNO FROM (
	  SELECT SI.ID,
			  SI.PROJ_ID,
        SI.LEASE_CODE,
        SI.PAY_ID,
        SI.Paylist_Code,
		SI.AMOUNT_MEMO,
			  SI.INVOICE_TYPE,
			  SI.FUND_TYPE,
			  SI.FUND_NAME,
			  SI.RENT_LIST,
			  SI.INVOICE_CODE,
			  TO_CHAR(SI.INVOICE_DATE,'YYYY-MM-DD') INVOICE_DATE,
			  SI.IF_EXPORT_FP,
			  SI.STATUS,
			  SI.CREATOR,
			  SI.CREATE_DATE,
			  SI.MODIFICATOR,
			  SI.MODIFY_DATE,
			  SI.IS_HEBING,
			  SI.ERRFLAG,
			  SI.ALL_INVOICE_ID,
			  SI.ALL_INVOICE_NUM COUNT_NO,
			  SI.INVOICE_AMT,
        GETDICTDATABYCODE('上牌方式',VPS.CARDWAY) ON_CARD,
			  HE.PRO_NAME,
			  HE.PRO_CODE,
			  HE.STATUS PROJECT_STATUS,
			  GETDICTSITEDATABYCODE('业务类型',HE.PLATFORM_TYPE) PROJECT_MODEL,
			  CL.NAME CLIENT_NAME,
			  VPS.SUP_NAME SUP_SHORTNAME,
			  VPS.SUP_NAME,
			  VPS.START_DATE START_CONFIRM_DATE,
			  FIA.NO TARGET_ID,
	          FIA.W_NAME TARGET_NAME,
	          FIA.W_ADDR TARGET_ADD,
	          CASE WHEN FIA.W_DUTY is not null THEN FIA.W_DUTY
	               ELSE FIA.W_CODE_OR_CARD END  TARGET_TAX_CODE,
	          FIA.W_PHONE TARGET_TEL,
	          FIA.W_PHONE TARGET_ADD_PHONE,
	          CASE WHEN SI.TAX_TYPE=1
	          THEN DECODE(FIA.W_TAX_QUALIFICATION,'一般纳税人','专票','个人','普票','小规模纳税人','普票','其他')
	          ELSE DECODE(SI.TAX_TYPE,0,'专票',2,'普票') END TAX_TYPE,
	          FIA.W_TAX_QUALIFICATION TARGET_TAX_QUALIFICATION,
	          FIA.W_BANK TARGET_BANK,
	          (FIA.W_BANK ||' ' || FIA.W_BANK_NUMBER) TARGET_BANK_ACCOUNT,
	          FIA.W_BANK_NUMBER TARGET_ACCOUNT,
	          tsei.EMS_FLAG,
	          tsei.EMS_TO_NAME,
	          tsei.EMS_TO_PHONE,
	          tsei.EMS_TO_DW,
	          tsei.EMS_TO_ADDR,
	          tsei.EMS_TO_CITY,
	          tsei.EMS_TO_CODE,
			  HE.PLATFORM_TYPE,
			  SI.TAX_RATE
		FROM FI_SALEITEM_INVOICE SI 
     LEFT join v_plan_scheme VPS on SI.Paylist_Code=VPS.PAYLIST_CODE
     left join FIL_INVOICE_APPLICATION FIA on VPS.PAYLIST_CODE=FIA.PAYLIST_CODE
     left join t_sys_ems_info tsei on FIA.EMS_ID=tsei.id
    LEFT JOIN FIL_PROJECT_HEAD HE ON  SI.PROJ_ID = HE.ID
    LEFT JOIN FIL_CUST_CLIENT CL ON HE.CLIENT_ID = CL.ID
    WHERE (SI.IS_HEBING IS NULL OR SI.IS_HEBING =0)  and SI.IS_TQKJ=1
     ORDER BY SI.PAYLIST_CODE,SI.RENT_LIST,nlssort(FIA.W_NAME,'NLS_SORT=SCHINESE_PINYIN_M')
   )TTT WHERE TTT.INVOICE_TYPE = #{INVOICE_TYPE}
		  AND TTT.STATUS = 0 
		  AND TTT.INVOICE_CODE IS NULL
        <if test="START_TIME !=null and START_TIME !=''">AND TTT.START_CONFIRM_DATE >= TO_DATE(#{START_TIME},'YYYY-MM-DD')</if>
	      <if test="END_TIME !=null and END_TIME !=''">AND <![CDATA[TTT.START_CONFIRM_DATE <= TO_DATE(#{END_TIME},'YYYY-MM-DD') ]]></if>
	      <if test="PRO_CODE !=null and PRO_CODE !=''">AND TTT.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
	      <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND TTT.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
		  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND TTT.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if> 
	      <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND TTT.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if> 
	      <if test="CLIENT_NAME !=null and CLIENT_NAME !=''">AND TTT.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if>
	      <if test="FUND_NAME !=null and FUND_NAME !=''">AND TTT.FUND_TYPE = #{FUND_NAME}</if>
	      <if test="TAX_TYPE !=null and TAX_TYPE !=''">AND TTT.TAX_TYPE = #{TAX_TYPE}</if>
	      <if test="ON_CARD !=null and ON_CARD !=''">AND TTT.ON_CARD = #{ON_CARD}</if> 
	      <if test="IF_EXPORT_FP !=null and IF_EXPORT_FP !=''">AND TTT.IF_EXPORT_FP = #{IF_EXPORT_FP}</if>
		  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND TTT.PLATFORM_TYPE = #{PLATFORM_TYPE}</if>
		   AND <![CDATA[ROWNUM <= #{PAGE_END}]]>
   )WT WHERE WT.ROWNO >= #{PAGE_BEGIN}  
</select>

<select id="getVatHeXiaoCount" parameterType="Map" resultType="Int">
   SELECT COUNT(*) FROM (
	   SELECT SI.ID,
			  SI.PROJ_ID,
        SI.LEASE_CODE,
        SI.PAY_ID,
        SI.Paylist_Code,
			SI.AMOUNT_MEMO,
			  SI.INVOICE_TYPE,
			  SI.FUND_TYPE,
			  SI.FUND_NAME,
			  SI.RENT_LIST,
			  SI.INVOICE_CODE,
			  TO_CHAR(SI.INVOICE_DATE,'YYYY-MM-DD') INVOICE_DATE,
			  SI.IF_EXPORT_FP,
			  SI.STATUS,
			  SI.CREATOR,
			  SI.CREATE_DATE,
			  SI.MODIFICATOR,
			  SI.MODIFY_DATE,
			  SI.IS_HEBING,
			  SI.ERRFLAG,
			  SI.ALL_INVOICE_ID,
			  SI.ALL_INVOICE_NUM COUNT_NO,
			  SI.INVOICE_AMT,
        GETDICTDATABYCODE('上牌方式',VPS.CARDWAY) ON_CARD,
			  HE.PRO_NAME,
			  HE.PRO_CODE,
			  HE.STATUS PROJECT_STATUS,
			  GETDICTSITEDATABYCODE('业务类型',HE.PLATFORM_TYPE) PROJECT_MODEL,
			  CL.NAME CLIENT_NAME,
			  VPS.SUP_NAME SUP_SHORTNAME,
			  VPS.SUP_NAME,
			  VPS.START_DATE START_CONFIRM_DATE,
			  FIA.NO TARGET_ID,
	          FIA.W_NAME TARGET_NAME,
	          FIA.W_ADDR TARGET_ADD,
	          CASE WHEN FIA.W_DUTY is not null THEN FIA.W_DUTY
	               ELSE FIA.W_CODE_OR_CARD END  TARGET_TAX_CODE,
	          FIA.W_PHONE TARGET_TEL,
	          FIA.W_PHONE TARGET_ADD_PHONE,
	          CASE WHEN SI.TAX_TYPE=1
	          THEN DECODE(FIA.W_TAX_QUALIFICATION,'一般纳税人','专票','个人','普票','小规模纳税人','普票','其他')
	          ELSE DECODE(SI.TAX_TYPE,0,'专票',2,'普票') END TAX_TYPE,
	          FIA.W_TAX_QUALIFICATION TARGET_TAX_QUALIFICATION,
	          FIA.W_BANK TARGET_BANK,
	          (FIA.W_BANK ||' ' || FIA.W_BANK_NUMBER) TARGET_BANK_ACCOUNT,
	          FIA.W_BANK_NUMBER TARGET_ACCOUNT,
	          tsei.EMS_FLAG,
	          tsei.EMS_TO_NAME,
	          tsei.EMS_TO_PHONE,
	          tsei.EMS_TO_DW,
	          tsei.EMS_TO_ADDR,
	          tsei.EMS_TO_CITY,
	          tsei.EMS_TO_CODE,
			  HE.PLATFORM_TYPE,
			  SI.TAX_RATE
		FROM FI_SALEITEM_INVOICE SI 
     LEFT join v_plan_scheme VPS on SI.Paylist_Code=VPS.PAYLIST_CODE
     left join FIL_INVOICE_APPLICATION FIA on VPS.PAYLIST_CODE=FIA.PAYLIST_CODE
     left join t_sys_ems_info tsei on FIA.EMS_ID=tsei.id
    LEFT JOIN FIL_PROJECT_HEAD HE ON  SI.PROJ_ID = HE.ID
    LEFT JOIN FIL_CUST_CLIENT CL ON HE.CLIENT_ID = CL.ID
    WHERE (SI.IS_HEBING IS NULL OR SI.IS_HEBING =0)  and SI.IS_TQKJ=1
     ORDER BY SI.PAYLIST_CODE,SI.RENT_LIST,nlssort(FIA.W_NAME,'NLS_SORT=SCHINESE_PINYIN_M')
   )TTT WHERE TTT.INVOICE_TYPE = #{INVOICE_TYPE}
		  AND TTT.STATUS = 0 
		  AND TTT.INVOICE_CODE IS NULL
	      <if test="START_TIME !=null and START_TIME !=''">AND TTT.START_CONFIRM_DATE >= TO_DATE(#{START_TIME},'YYYY-MM-DD')</if>
	      <if test="END_TIME !=null and END_TIME !=''">AND <![CDATA[TTT.START_CONFIRM_DATE <= TO_DATE(#{END_TIME},'YYYY-MM-DD') ]]></if>
	      <if test="PRO_CODE !=null and PRO_CODE !=''">AND TTT.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
	      <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND TTT.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
		  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND TTT.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if> 
	      <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND TTT.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if> 
	      <if test="CLIENT_NAME !=null and CLIENT_NAME !=''">AND TTT.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if>
	      <if test="FUND_NAME !=null and FUND_NAME !=''">AND TTT.FUND_TYPE = #{FUND_NAME}</if>
	      <if test="TAX_TYPE !=null and TAX_TYPE !=''">AND TTT.TAX_TYPE = #{TAX_TYPE}</if>
	      <if test="ON_CARD !=null and ON_CARD !=''">AND TTT.ON_CARD = #{ON_CARD}</if> 
	      <if test="IF_EXPORT_FP !=null and IF_EXPORT_FP !=''">AND TTT.IF_EXPORT_FP = #{IF_EXPORT_FP}</if>
		  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND TTT.PLATFORM_TYPE = #{PLATFORM_TYPE}</if>
</select>

<select id="getDropInvoiceList" parameterType="Map" resultType="Map">
  SELECT T.* FROM (
       SELECT SI.ID,
			  SI.PROJ_ID,
        SI.LEASE_CODE,
        SI.PAY_ID,
        SI.Paylist_Code,
				SI.AMOUNT_MEMO,
			  SI.INVOICE_TYPE,
			  SI.FUND_TYPE,
			  SI.FUND_NAME,
			  SI.RENT_LIST,
			  SI.INVOICE_CODE,
			  TO_CHAR(SI.INVOICE_DATE,'YYYY-MM-DD') INVOICE_DATE,
			  SI.IF_EXPORT_FP,
			  SI.STATUS,
			  SI.CREATOR,
			  SI.CREATE_DATE,
			  SI.MODIFICATOR,
			  SI.MODIFY_DATE,
			  SI.IS_HEBING,
			  SI.ERRFLAG,
			  SI.ALL_INVOICE_ID,
			  SI.ALL_INVOICE_NUM COUNT_NO,
			  SI.INVOICE_AMT,
        GETDICTDATABYCODE('上牌方式',VPS.CARDWAY) ON_CARD,
			  HE.PRO_NAME,
			  HE.PRO_CODE,
			  HE.STATUS PROJECT_STATUS,
			  GETDICTSITEDATABYCODE('业务类型',HE.PLATFORM_TYPE) PROJECT_MODEL,
			  CL.NAME CLIENT_NAME,
			 VPS.SUP_NAME SUP_SHORTNAME,
			  VPS.SUP_NAME,
			  VPS.START_DATE START_CONFIRM_DATE,
			  FIA.NO TARGET_ID,
	          FIA.W_NAME TARGET_NAME,
	          FIA.W_ADDR TARGET_ADD,
	          CASE WHEN FIA.W_DUTY is not null THEN FIA.W_DUTY
	               ELSE FIA.W_CODE_OR_CARD END  TARGET_TAX_CODE,
	          FIA.W_PHONE TARGET_TEL,
	          FIA.W_PHONE TARGET_ADD_PHONE,
	          CASE WHEN SI.TAX_TYPE=1
	          THEN DECODE(FIA.W_TAX_QUALIFICATION,'一般纳税人','专票','个人','普票','小规模纳税人','普票','其他')
	          ELSE DECODE(SI.TAX_TYPE,0,'专票',2,'普票') END TAX_TYPE,
	          FIA.W_TAX_QUALIFICATION TARGET_TAX_QUALIFICATION,
	          FIA.W_BANK TARGET_BANK,
	          (FIA.W_BANK ||' ' || FIA.W_BANK_NUMBER) TARGET_BANK_ACCOUNT,
	          FIA.W_BANK_NUMBER TARGET_ACCOUNT,
	          tsei.EMS_FLAG,
	          tsei.EMS_TO_NAME,
	          tsei.EMS_TO_PHONE,
	          tsei.EMS_TO_DW,
	          tsei.EMS_TO_ADDR,
	          tsei.EMS_TO_CITY,
	          tsei.EMS_TO_CODE,
			  HE.PLATFORM_TYPE
	    FROM FI_SALEITEM_INVOICE SI 
     LEFT join v_plan_scheme VPS on SI.Paylist_Code=VPS.PAYLIST_CODE
     left join FIL_INVOICE_APPLICATION FIA on VPS.PAYLIST_CODE=FIA.PAYLIST_CODE
     left join t_sys_ems_info tsei on FIA.EMS_ID=tsei.id
    LEFT JOIN FIL_PROJECT_HEAD HE ON  SI.PROJ_ID = HE.ID
    LEFT JOIN FIL_CUST_CLIENT CL ON HE.CLIENT_ID = CL.ID
	 )T WHERE T.IS_HEBING = 1
	      AND T.ALL_INVOICE_ID = #{INVOICE_ID} 
</select>

<select id="vatHeXiaoExcelData" parameterType="Map" resultType="Map">
SELECT *
	FROM (
	      SELECT T.IN_ID,
               T.ID INVOICE_ID,
               T.FUND_TYPE,
               T.FUND_NAME,
               T.PROJ_ID,
               T.INVOICE_TYPE,
               T.MEMO,
               T.PRO_CODE,
               T.PRO_NAME,
               T.START_CONFIRM_DATE,
               NVL(T.ITEM_NAME, ' ') ITEM_NAME,
               NVL(T.ITEM_MODEL, ' ') ITEM_MODEL,
               T.ITEM_UNIT,
               T.PROJECT_MODEL,
               T.ITEM_NUM,
               T.ITEM_UNIT_PRICE,
               T.ITEM_FACT_AMT,
               T.ITEM_SUB_AMT,
               T.ITEM_SUB_TAX_AMT,
               T.ITEM_TAX_RATE,
			   T.TARGET_ID,
               T.TARGET_NAME,
               T.TARGET_CARD_ID,
               NVL(T.ITEM_CODE, ' ') ITEM_CODE,
               T.TARGET_ADD,
               T.TARGET_TEL,
               T.TARGET_ADD_PHONE,
               T.TARGET_TAX_CODE,
               T.TARGET_TAX_QUALIFICATION,
               T.TARGET_BANK,
               T.TARGET_ACCOUNT,
               T.TARGET_BANK_ACCOUNT,
               T.EMS_FLAG,
               T.EMS_TO_NAME,
               T.EMS_TO_PHONE,
               T.EMS_TO_DW,
               T.EMS_TO_ADDR,
               T.EMS_TO_CITY,
			   T.EMS_TO_CODE,
               TO_CHAR(SYSDATE, 'YYYY-MM-DD') INVOICE_DATE,
               T.SUP_SHORTNAME,
               '0.00' DISCOUNT_PRICE,
               '0.00' DISCOUNT,
               '0.00' DISCOUNT_RATE,
               T.VAT_TYPE,
               T.TAX_TYPE,
               T.ON_CARD,
			   T.IS_TQKJ,
               T.IF_EXPORT_FP
					FROM (
			          SELECT DECODE(SI.IS_HEBING, '1', SI.ALL_INVOICE_ID, SI.ID) IN_ID,
                       SI.ID,
                       SI.PROJ_ID,
                       SI.LEASE_CODE,
                        SI.PAY_ID,
                        SI.Paylist_Code,
                       SI.AMOUNT_MEMO,
                       SI.INVOICE_TYPE,
                       SI.FUND_TYPE,
                       SI.FUND_NAME,
                       SI.RENT_LIST,
                       SI.STATUS,
                       SI.IS_HEBING,
                       SI.INVOICE_AMT,
                       SI.IF_EXPORT_FP,
					   SI.IS_TQKJ,
                       HE.Platform_Type PROJECT_MODEL,
                       VPS.START_DATE START_CONFIRM_DATE,
                       IT.ITEM_NAME,
                       IT.ITEM_MODEL,
                       IT.ITEM_UNIT,
                       IT.ITEM_NUM,
                       IT.ITEM_UNIT_PRICE,
                       IT.ITEM_FACT_AMT,
                       IT.ITEM_SUB_AMT,
                       IT.ITEM_SUB_TAX_AMT,
                       IT.ITEM_TAX_RATE,
                       HE.PRO_NAME,
                       HE.PRO_CODE,
					   VPS.SUP_NAME SUP_SHORTNAME,
                       (VPS.SUP_NAME ||' '||SI.Paylist_Code || DECODE(SI.RENT_LIST,NULL,'','_' || SI.RENT_LIST)) MEMO,
                       VPS.SUP_NAME,
                       HE.PRODUCT_NAME,
                       NA.ITEM_CODE,
                      GETDICTDATABYCODE('上牌方式',VPS.CARDWAY) ON_CARD,
					  FIA.NO TARGET_ID,
                       FIA.W_NAME TARGET_NAME,
                       FIA.W_CODE_OR_CARD TARGET_CARD_ID,
                       FIA.W_ADDR TARGET_ADD,
                       FIA.W_PHONE TARGET_TEL,
                       FIA.W_PHONE TARGET_ADD_PHONE,
                       CASE WHEN FIA.W_DUTY is not null THEN FIA.W_DUTY
	                          ELSE FIA.W_CODE_OR_CARD END  TARGET_TAX_CODE,
                       FIA.W_TAX_QUALIFICATION TARGET_TAX_QUALIFICATION,
                       CASE WHEN SI.TAX_TYPE = 1 THEN DECODE(FIA.W_TAX_QUALIFICATION,'一般纳税人',0,2) ELSE SI.TAX_TYPE END VAT_TYPE,
                      CASE WHEN SI.TAX_TYPE=1 THEN DECODE(FIA.W_TAX_QUALIFICATION,'一般纳税人','专票','个人','普票','小规模纳税人','普票','其他')
          	          ELSE DECODE(SI.TAX_TYPE,0,'专票',2,'普票') END TAX_TYPE,
                       FIA.W_BANK TARGET_BANK,
                       FIA.W_BANK_NUMBER TARGET_ACCOUNT,
                       (FIA.W_BANK ||' '  || FIA.W_BANK_NUMBER) TARGET_BANK_ACCOUNT,
                       tsei.EMS_FLAG,
	                     tsei.EMS_TO_NAME,
                       tsei.EMS_TO_PHONE,
	                     tsei.EMS_TO_DW,
                       tsei.EMS_TO_ADDR,
	                     tsei.EMS_TO_CITY,
						 tsei.EMS_TO_CODE
						FROM (SELECT *
                          FROM FI_SALEITEM_INVOICE
                         WHERE NVL(IS_HEBING, '1') = '1'
                           AND STATUS = 0) SI
                  LEFT JOIN FI_SALEITEM_INVOICE_ITEM IT ON SI.ID =
                                                           IT.SALEITEM_INVOICE_ID
                  LEFT JOIN FI_INVOICE_ITEM_NAMES NA ON IT.ITEM_NAME =
                                                        NA.ITEM_NAME
                                                    AND NVL(IT.ITEM_MODEL,
                                                            ' ') =
                                                        NVL(NA.ITEM_MODEL,
                                                            ' ')
                  LEFT JOIN FIL_PROJECT_HEAD HE ON SI.PROJ_ID = HE.ID
                  LEFT join v_plan_scheme VPS on SI.Paylist_Code=VPS.PAYLIST_CODE
                   left join FIL_INVOICE_APPLICATION FIA on VPS.PAYLIST_CODE=FIA.PAYLIST_CODE
                   left join t_sys_ems_info tsei on FIA.EMS_ID=tsei.id
                 ORDER BY SI.PAYLIST_CODE,IT.ITEM_MODEL,nlssort(FIA.W_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),NA.ITEM_CODE
                 ) T
        
        ) TTT
 WHERE TTT.INVOICE_TYPE = #{INVOICE_TYPE}
    <if test="START_TIME !=null and START_TIME !=''">AND TTT.START_CONFIRM_DATE >= TO_DATE(#{START_TIME},'YYYY-MM-DD')</if>
	      <if test="END_TIME !=null and END_TIME !=''">AND <![CDATA[TTT.START_CONFIRM_DATE <= TO_DATE(#{END_TIME},'YYYY-MM-DD') ]]></if>
	      <if test="PRO_CODE !=null and PRO_CODE !=''">AND TTT.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
	      <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND TTT.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
		  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND TTT.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if> 
	      <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND TTT.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if> 
	      <if test="CLIENT_NAME !=null and CLIENT_NAME !=''">AND TTT.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if>
	      <if test="FUND_NAME !=null and FUND_NAME !=''">AND TTT.FUND_TYPE = #{FUND_NAME}</if>
	      <if test="TAX_TYPE !=null and TAX_TYPE !=''">AND TTT.TAX_TYPE = #{TAX_TYPE}</if>
	      <if test="ON_CARD !=null and ON_CARD !=''">AND TTT.ON_CARD = #{ON_CARD}</if> 
	      <if test="IF_EXPORT_FP !=null and IF_EXPORT_FP !=''">AND TTT.IF_EXPORT_FP = #{IF_EXPORT_FP}</if>
		  <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND TTT.PLATFORM_TYPE = #{PLATFORM_TYPE}</if>
		  <if test="IS_TQKJ !=null and IS_TQKJ !=''">AND TTT.IS_TQKJ = #{IS_TQKJ}</if>
    <if test="exportAll !=null and exportAll !=''">AND TTT.IN_ID IN (${sqlData}) </if>    
</select>


<delete id="delInvoiceMain" parameterType="String">
 DELETE FROM FI_SALEITEM_INVOICE DE WHERE DE.ID IN(${reJectData})
</delete>

<delete id="delInvoiceItem" parameterType="String">
DELETE FROM FI_SALEITEM_INVOICE_ITEM SII WHERE SII.SALEITEM_INVOICE_ID IN(${reJectData})
</delete>

<delete id="delInvoiceDetail" parameterType="String">
DELETE FROM FI_SALEITEM_INVOICE_DETAIL SID WHERE SID.SALEITEM_INVOICE_ID IN (${reJectData})
</delete>

<select id="getVatMergerApplyList" parameterType="Map" resultType="Map">
  SELECT * FROM (
	SELECT S.*,
	        NVL(S.CAPITAL_PRICE_TOTAL,0)+NVL(S.INTEREST_PRICE_TOTAL,0)+NVL(S.LXZZS_PRICE_TOTAL,0)+NVL(S.GLF_PERIOD_PRICE_TOTAL,0)+NVL(S.SXF_PERIOD_PRICE_TOTAL,0) RENT_PRICE_TOTAL,
		   NVL(S.CAPITAL_PRICE_TOTAL,0)+NVL(S.INTEREST_PRICE_TOTAL,0)+NVL(S.LXZZS_PRICE_TOTAL,0)+NVL(S.GLF_PERIOD_PRICE_TOTAL,0)+NVL(S.SXF_PERIOD_PRICE_TOTAL,0)+NVL(S.OVER_PRICE_TOTAL,0)+NVL(S.ACCRUE_RENT_PRICE,0)+${COLUMNSITEMTOTALMONEY} INVOICE_AMT,
		   ROWNUM ROWNO FROM (    
	 SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
	         T.PAYLIST_CODE,
           TT.PAY_WAY,
	         CASE WHEN MIN(to_number(decode(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))= 
             MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM))) 
             THEN TO_CHAR(MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))) 
      		 ELSE (case when MIN(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))||'-'|| 
      		 MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))='-' then '' else 
      		 MIN(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))||'-'|| 
      		 MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM))) end) END RENT_LIST,
	         TT.LEASE_TERM,
	         TT.PROJECT_STATUS,
	         SUM(DECODE(T.BEGINNING_NAME,'本金',T.BEGINNING_MONEY,'第一期租金',T.BEGINNING_MONEY)) CAPITAL_PRICE_TOTAL,
	         SUM(DECODE(T.BEGINNING_NAME,'利息',T.BEGINNING_MONEY,'租前利息',T.BEGINNING_MONEY)) INTEREST_PRICE_TOTAL,
	         SUM(DECODE(T.BEGINNING_NAME,'违约金',T.BEGINNING_MONEY)) OVER_PRICE_TOTAL,
	         SUM(DECODE(T.BEGINNING_NAME,'利息增值税',T.BEGINNING_MONEY)) LXZZS_PRICE_TOTAL,
	         SUM(DECODE(T.BEGINNING_NAME,'每期管理费',T.BEGINNING_MONEY)) GLF_PERIOD_PRICE_TOTAL,
	         SUM(DECODE(T.BEGINNING_NAME,'每期手续费',T.BEGINNING_MONEY)) SXF_PERIOD_PRICE_TOTAL,
	         SUM(DECODE(T.BEGINNING_NAME,'首期租金',T.BEGINNING_MONEY)) ACCRUE_RENT_PRICE,
	         ${COLUMNSITEM},
           GETDICTSITEDATABYCODE('业务类型',TT.MULTIPLE_MODEL) PROJECT_MODEL,
	         TT.PROJECT_ID,
	         TT.PRO_CODE,
           TT.LEASE_CODE,
		       TT.PAY_ID,
           TT.MULTIPLE_MODEL,
	         TT.PRO_NAME,
	         TT.CLIENT_ID,
	         TT.CLIENT_NAME,
	         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
	         TT.ON_CARD,
	         TT.SUP_SHORTNAME,
	         TTT.SHOW_NODE,
	         TTT.TAX_TYPE,
           	TTT.TAX_RATE
	      FROM(SELECT W.BEGINNING_RECEIVE_DATA,
	           W.BEGINNING_NUM,
	           W.ITEM_FLAG,
	           W.PAYLIST_CODE,
	           W.BEGINNING_NAME,
	           W.BEGINNING_MONEY 
	      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
	                  nvl(BA.PERIOD,0)  BEGINNING_NUM,
	                  BA.D_STATUS ITEM_FLAG,
	                  BA.D_PAY_CODE PAYLIST_CODE ,	
                      CASE WHEN  BA.D_PAY_PROJECT='管理费' AND BA.PERIOD is not null  THEN '每期管理费'
				   			WHEN BA.D_PAY_PROJECT='手续费' AND BA.PERIOD is not null  THEN '每期手续费'
                        ELSE BA.D_PAY_PROJECT END BEGINNING_NAME,
	                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
	                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH,FIL_RENT_PLAN_HEAD_MAX_V MAV
	            WHERE BA.D_FUND_ID = FH.ID 
	              AND BA.D_PAY_CODE = MAV.PAYLIST_CODE
	              AND FH.FI_STATUS =2 AND BA.RED_STATUS = 0 
	              AND BA.RE_STATUS = 0 AND BA.D_RECEIVE_MONEY &lt;&gt;0
	         )W
	    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID,
				                  nvl(de.RENT_LIST,0) RENT_LIST
	                 FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
	                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1  AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
	               )WW
	          ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
	          AND (W.BEGINNING_NAME = WW.ITEM_NAME  OR W.BEGINNING_NAME = '每期' || WW.ITEM_NAME)
	           AND ((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
	          WHERE WW.SALEITEM_INVOICE_ID IS  NULL
	          )T
	    LEFT JOIN (
	          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
        				 V.PAY_ID,
        				 HE.LEASE_CODE,
                         HE.PRO_NAME,
                         HE.CLIENT_ID,
                         HE.STATUS PROJECT_STATUS,
                         V.company_name SUB_COMPANY_NAME,
                         CL.NAME CLIENT_NAME,
                         V.START_DATE CONFIRM_DATE_START,
                         V.START_DATE CONFIRM_DATE_END,
                         V.PAY_WAY,
                         CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                         V.platform_type MULTIPLE_MODEL,
                         getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                         V.PAYLIST_CODE,
                         V.SUP_NAME SUP_SHORTNAME,
                         GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD,
                         V.LEASE_TERM
                  FROM  v_plan_scheme V,
                        FIL_PROJECT_HEAD HE,
        		        FIL_CUST_CLIENT CL,
                    FIL_INVOICE_APPLICATION FIA
        		  WHERE V.PROJECT_ID =HE.ID
        		    AND HE.CLIENT_ID = CL.ID
                AND V.PAYLIST_CODE=FIA.PAYLIST_CODE 
	               )TT
	              ON T.PAYLIST_CODE = TT.PAYLIST_CODE
	     LEFT JOIN (
	        SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
	         ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
	         ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
	         ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
	     )TTT ON (T.BEGINNING_NAME = TTT.FUND_TYPE or T.BEGINNING_NAME = '每期' || TTT.FUND_TYPE)
	       <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if>
	      WHERE  TTT.IF_INVOICE = 1 
	        AND TT.PROJECT_STATUS >= TTT.SHOW_NODE 
	        AND TT.IS_INVOICE_MONTH = '合并开具' 
	        AND <![CDATA[ TT.PROJECT_STATUS < 100 ]]>
	        AND TT.PRO_CODE NOT LIKE '%TEST%'
	     GROUP BY TT.SUP_SHORTNAME, TT.LEASE_TERM,TT.PROJECT_STATUS, T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, 
        TT.CONFIRM_DATE_START, TT.ON_CARD, TTT.SHOW_NODE ,TTT.TAX_TYPE,TT.PAY_WAY,TT.LEASE_CODE,TT.PAY_ID,TT.MULTIPLE_MODEL,TTT.TAX_RATE
	     ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE
	  )S WHERE NVL(S.CAPITAL_PRICE_TOTAL,0)+NVL(S.INTEREST_PRICE_TOTAL,0)+NVL(S.LXZZS_PRICE_TOTAL,0)+NVL(S.GLF_PERIOD_PRICE_TOTAL,0)+NVL(S.SXF_PERIOD_PRICE_TOTAL,0)+NVL(S.OVER_PRICE_TOTAL,0)+NVL(S.ACCRUE_RENT_PRICE,0)+${COLUMNSITEMTOTALMONEY} !=0
		  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
	      <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
	      <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND S.MULTIPLE_MODEL=#{PLATFORM_TYPE}</if>
		  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
		  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
		  <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
		  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
		  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
		  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{END_TIME}]]></if>
		  AND <![CDATA[ROWNUM <= #{PAGE_END} ]]>
   )SS WHERE SS.ROWNO >= #{PAGE_BEGIN}
</select>

<select id="getVatMergerApplyCount" parameterType="Map" resultType="Int">
 SELECT COUNT(1) FROM (   
 SELECT S.*, NVL(S.CAPITAL_PRICE_TOTAL,0)+NVL(S.INTEREST_PRICE_TOTAL,0)+NVL(S.LXZZS_PRICE_TOTAL,0)+NVL(S.GLF_PERIOD_PRICE_TOTAL,0)+NVL(S.SXF_PERIOD_PRICE_TOTAL,0) RENT_PRICE_TOTAL,
		   NVL(S.CAPITAL_PRICE_TOTAL,0)+NVL(S.INTEREST_PRICE_TOTAL,0)+NVL(S.LXZZS_PRICE_TOTAL,0)+NVL(S.GLF_PERIOD_PRICE_TOTAL,0)+NVL(S.SXF_PERIOD_PRICE_TOTAL,0)+NVL(S.OVER_PRICE_TOTAL,0)+NVL(S.ACCRUE_RENT_PRICE,0)+${COLUMNSITEMTOTALMONEY} INVOICE_AMT,
		   ROWNUM ROWNO FROM ( 
	  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
	         T.PAYLIST_CODE,
           TT.PAY_WAY,
	         CASE WHEN MIN(to_number(decode(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))= 
             MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM))) 
             THEN TO_CHAR(MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))) 
      		 ELSE (case when MIN(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))||'-'|| 
      		 MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))='-' then '' else 
      		 MIN(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))||'-'|| 
      		 MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM))) end) END RENT_LIST,
	         TT.LEASE_TERM,
	         TT.PROJECT_STATUS,
	         SUM(DECODE(T.BEGINNING_NAME,'本金',T.BEGINNING_MONEY,'第一期租金',T.BEGINNING_MONEY)) CAPITAL_PRICE_TOTAL,
	         SUM(DECODE(T.BEGINNING_NAME,'利息',T.BEGINNING_MONEY,'租前利息',T.BEGINNING_MONEY)) INTEREST_PRICE_TOTAL,
	         SUM(DECODE(T.BEGINNING_NAME,'违约金',T.BEGINNING_MONEY)) OVER_PRICE_TOTAL,
	         SUM(DECODE(T.BEGINNING_NAME,'利息增值税',T.BEGINNING_MONEY)) LXZZS_PRICE_TOTAL,
	         SUM(DECODE(T.BEGINNING_NAME,'每期管理费',T.BEGINNING_MONEY)) GLF_PERIOD_PRICE_TOTAL,
	         SUM(DECODE(T.BEGINNING_NAME,'每期手续费',T.BEGINNING_MONEY)) SXF_PERIOD_PRICE_TOTAL,
	         SUM(DECODE(T.BEGINNING_NAME,'首期租金',T.BEGINNING_MONEY)) ACCRUE_RENT_PRICE,
	         ${COLUMNSITEM},
           GETDICTSITEDATABYCODE('业务类型',TT.MULTIPLE_MODEL) PROJECT_MODEL,
	         TT.PROJECT_ID,
	         TT.PRO_CODE,
           TT.LEASE_CODE,
		       TT.PAY_ID,
           TT.MULTIPLE_MODEL,
	         TT.PRO_NAME,
	         TT.CLIENT_ID,
	         TT.CLIENT_NAME,
	         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
	         TT.ON_CARD,
	         TT.SUP_SHORTNAME,
	         TTT.SHOW_NODE,
	         TTT.TAX_TYPE,
           TTT.TAX_RATE
	    FROM ( SELECT W.BEGINNING_RECEIVE_DATA,
	           W.BEGINNING_NUM,
	           W.ITEM_FLAG,
	           W.PAYLIST_CODE,
	           W.BEGINNING_NAME,
	           W.BEGINNING_MONEY 
	      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
	                  nvl(BA.PERIOD,0)  BEGINNING_NUM,
	                  BA.D_STATUS ITEM_FLAG,
	                  BA.D_PAY_CODE PAYLIST_CODE ,	
                      CASE WHEN  BA.D_PAY_PROJECT='管理费' AND BA.PERIOD is not null  THEN '每期管理费'
				   			WHEN BA.D_PAY_PROJECT='手续费' AND BA.PERIOD is not null  THEN '每期手续费'
                        ELSE BA.D_PAY_PROJECT END BEGINNING_NAME,
	                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
	                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH,FIL_RENT_PLAN_HEAD_MAX_V MAV
	            WHERE BA.D_FUND_ID = FH.ID 
	              AND BA.D_PAY_CODE = MAV.PAYLIST_CODE
	              AND FH.FI_STATUS =2 AND BA.RED_STATUS = 0 
	              AND BA.RE_STATUS = 0 AND BA.D_RECEIVE_MONEY &lt;&gt;0
	         )W
	    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID,
				                  nvl(de.RENT_LIST,0) RENT_LIST
	                 FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
	                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1  AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
	               )WW
	          ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
	          AND (W.BEGINNING_NAME = WW.ITEM_NAME  OR W.BEGINNING_NAME = '每期' || WW.ITEM_NAME)
	           AND ((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
	          WHERE WW.SALEITEM_INVOICE_ID IS  NULL
	          )T
	    LEFT JOIN (
	          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
        				 V.PAY_ID,
        				 HE.LEASE_CODE,
                         HE.PRO_NAME,
                         HE.CLIENT_ID,
                         HE.STATUS PROJECT_STATUS,
                         V.company_name SUB_COMPANY_NAME,
                         CL.NAME CLIENT_NAME,
                         V.START_DATE CONFIRM_DATE_START,
                         V.START_DATE CONFIRM_DATE_END,
                         V.PAY_WAY,
                         CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                         V.platform_type MULTIPLE_MODEL,
                         getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                         V.PAYLIST_CODE,
                         V.SUP_NAME SUP_SHORTNAME,
                         GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD,
                         V.LEASE_TERM
                  FROM  v_plan_scheme V,
                        FIL_PROJECT_HEAD HE,
        		        FIL_CUST_CLIENT CL,
                    FIL_INVOICE_APPLICATION FIA
        		  WHERE V.PROJECT_ID =HE.ID
        		    AND HE.CLIENT_ID = CL.ID
                AND V.PAYLIST_CODE=FIA.PAYLIST_CODE 
	               )TT
	               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
	     LEFT JOIN (
	        SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
	         ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
	         ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
	         ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
	     )TTT ON (T.BEGINNING_NAME = TTT.FUND_TYPE or T.BEGINNING_NAME = '每期' || TTT.FUND_TYPE)
	       <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if>
	      WHERE TTT.IF_INVOICE = 1 
	        AND TT.PROJECT_STATUS >=TTT.SHOW_NODE 
	        AND TT.IS_INVOICE_MONTH = '合并开具' 
	        AND <![CDATA[ TT.PROJECT_STATUS < 100 ]]>
	        AND TT.PRO_CODE NOT LIKE '%TEST%'
	      GROUP BY TT.SUP_SHORTNAME, TT.LEASE_TERM,TT.PROJECT_STATUS, T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, 
        	TT.CONFIRM_DATE_START, TT.ON_CARD, TTT.SHOW_NODE ,TTT.TAX_TYPE,TT.PAY_WAY,TT.LEASE_CODE,TT.PAY_ID,TT.MULTIPLE_MODEL,TTT.TAX_RATE
	     )S WHERE NVL(S.CAPITAL_PRICE_TOTAL,0)+NVL(S.INTEREST_PRICE_TOTAL,0)+NVL(S.LXZZS_PRICE_TOTAL,0)+NVL(S.GLF_PERIOD_PRICE_TOTAL,0)+NVL(S.SXF_PERIOD_PRICE_TOTAL,0)+NVL(S.OVER_PRICE_TOTAL,0)+NVL(S.ACCRUE_RENT_PRICE,0)+${COLUMNSITEMTOTALMONEY} !=0
		  <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
	      <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
	      <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND S.MULTIPLE_MODEL=#{PLATFORM_TYPE}</if>
		  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
		  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
		  <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
		  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
		  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
		  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{END_TIME}]]></if>
	  )SS
</select>

<select id="getAllMergerInvoiceMess" parameterType="Map" resultType="Map">
SELECT S.*, NVL(S.CAPITAL_PRICE_TOTAL,0)+NVL(S.INTEREST_PRICE_TOTAL,0)+NVL(S.LXZZS_PRICE_TOTAL,0)+NVL(S.GLF_PERIOD_PRICE_TOTAL,0)+NVL(S.SXF_PERIOD_PRICE_TOTAL,0) RENT_PRICE_TOTAL,
		   NVL(S.CAPITAL_PRICE_TOTAL,0)+NVL(S.INTEREST_PRICE_TOTAL,0)+NVL(S.LXZZS_PRICE_TOTAL,0)+NVL(S.GLF_PERIOD_PRICE_TOTAL,0)+NVL(S.SXF_PERIOD_PRICE_TOTAL,0)+NVL(S.OVER_PRICE_TOTAL,0)+NVL(S.ACCRUE_RENT_PRICE,0)+${COLUMNSITEMTOTALMONEY} INVOICE_AMT,
		   ROWNUM ROWNO FROM (     
	  SELECT TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
	         T.PAYLIST_CODE,
           TT.PAY_WAY,
	         CASE WHEN MIN(to_number(decode(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))= 
             MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM))) 
             THEN TO_CHAR(MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))) 
      		 ELSE (case when MIN(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))||'-'|| 
      		 MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))='-' then '' else 
      		 MIN(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM)))||'-'|| 
      		 MAX(to_number(DECODE(T.BEGINNING_NUM,0,NULL,T.BEGINNING_NUM))) end) END RENT_LIST,
	         TT.LEASE_TERM,
	         TT.PROJECT_STATUS,
	         SUM(DECODE(T.BEGINNING_NAME,'本金',T.BEGINNING_MONEY,'第一期租金',T.BEGINNING_MONEY)) CAPITAL_PRICE_TOTAL,
	         SUM(DECODE(T.BEGINNING_NAME,'利息',T.BEGINNING_MONEY,'租前利息',T.BEGINNING_MONEY)) INTEREST_PRICE_TOTAL,
	         SUM(DECODE(T.BEGINNING_NAME,'违约金',T.BEGINNING_MONEY)) OVER_PRICE_TOTAL,
	         SUM(DECODE(T.BEGINNING_NAME,'利息增值税',T.BEGINNING_MONEY)) LXZZS_PRICE_TOTAL,
	         SUM(DECODE(T.BEGINNING_NAME,'每期管理费',T.BEGINNING_MONEY)) GLF_PERIOD_PRICE_TOTAL,
	         SUM(DECODE(T.BEGINNING_NAME,'每期手续费',T.BEGINNING_MONEY)) SXF_PERIOD_PRICE_TOTAL,
	         SUM(DECODE(T.BEGINNING_NAME,'首期租金',T.BEGINNING_MONEY)) ACCRUE_RENT_PRICE,
	         ${COLUMNSITEM},
           GETDICTSITEDATABYCODE('业务类型',TT.MULTIPLE_MODEL) PROJECT_MODEL,
	         TT.PROJECT_ID,
	         TT.PRO_CODE,
           TT.LEASE_CODE,
		       TT.PAY_ID,
           TT.MULTIPLE_MODEL,
	         TT.PRO_NAME,
	         TT.CLIENT_ID,
	         TT.CLIENT_NAME,
	         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
	         TT.ON_CARD,
	         TT.SUP_SHORTNAME,
	         TTT.SHOW_NODE,
	         TTT.TAX_TYPE,
           TTT.TAX_RATE
	    FROM ( SELECT W.BEGINNING_RECEIVE_DATA,
	           W.BEGINNING_NUM,
	           W.ITEM_FLAG,
	           W.PAYLIST_CODE,
	           W.BEGINNING_NAME,
	           W.BEGINNING_MONEY 
	      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
	                  nvl(BA.PERIOD,0)  BEGINNING_NUM,
	                  BA.D_STATUS ITEM_FLAG,
	                  BA.D_PAY_CODE PAYLIST_CODE ,	
                      CASE WHEN  BA.D_PAY_PROJECT='管理费' AND BA.PERIOD is not null  THEN '每期管理费'
				   			WHEN BA.D_PAY_PROJECT='手续费' AND BA.PERIOD is not null  THEN '每期手续费'
                        ELSE BA.D_PAY_PROJECT END BEGINNING_NAME,
	                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY 
	                  FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH,FIL_RENT_PLAN_HEAD_MAX_V MAV
	            WHERE BA.D_FUND_ID = FH.ID 
	              AND BA.D_PAY_CODE = MAV.PAYLIST_CODE
	              AND FH.FI_STATUS =2 AND BA.RED_STATUS = 0 
	            AND BA.RE_STATUS = 0 AND BA.D_RECEIVE_MONEY &lt;&gt;0
	         )W
	    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID,
				                  nvl(de.RENT_LIST,0) RENT_LIST
	                 FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
	                WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1  AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
	               )WW
	            ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
	          AND (W.BEGINNING_NAME = WW.ITEM_NAME  OR W.BEGINNING_NAME = '每期' || WW.ITEM_NAME)
	           AND ((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
	          WHERE WW.SALEITEM_INVOICE_ID IS  NULL
	          )T
	    LEFT JOIN (
	          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
        				 V.PAY_ID,
        				 HE.LEASE_CODE,
                         HE.PRO_NAME,
                         HE.CLIENT_ID,
                         HE.STATUS PROJECT_STATUS,
                         V.company_name SUB_COMPANY_NAME,
                         CL.NAME CLIENT_NAME,
                         V.START_DATE CONFIRM_DATE_START,
                         V.START_DATE CONFIRM_DATE_END,
                         V.PAY_WAY,
                         CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                         V.platform_type MULTIPLE_MODEL,
                         getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                         V.PAYLIST_CODE,
                         V.SUP_NAME SUP_SHORTNAME,
                         GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD,
                         V.LEASE_TERM
                  FROM  v_plan_scheme V,
                        FIL_PROJECT_HEAD HE,
        		        FIL_CUST_CLIENT CL,
                    FIL_INVOICE_APPLICATION FIA
        		  WHERE V.PROJECT_ID =HE.ID
        		    AND HE.CLIENT_ID = CL.ID
                AND V.PAYLIST_CODE=FIA.PAYLIST_CODE 
	               )TT
	               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
	     LEFT JOIN (
	       SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
	         ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
	         ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
	         ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
	     )TTT ON (T.BEGINNING_NAME = TTT.FUND_TYPE or T.BEGINNING_NAME = '每期' || TTT.FUND_TYPE)
	       <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if>
	      WHERE TTT.IF_INVOICE = 1 
	        AND TT.PROJECT_STATUS >= TTT.SHOW_NODE 
	        <if test="VAT_FLAG !=null and VAT_FLAG !=''">AND TT.CONFIRM_DATE_START >= TO_DATE('2012-09-01','YYYY-MM-DD')</if>
	        <if test="BUS_FLAG !=null and BUS_FLAG !=''">AND <![CDATA[TT.CONFIRM_DATE_START <= TO_DATE('2012-09-01','YYYY-MM-DD')]]></if>
	        AND TT.IS_INVOICE_MONTH = '合并开具' 
	        AND <![CDATA[ TT.PROJECT_STATUS < 100 ]]>
	        AND TT.PRO_CODE NOT LIKE '%TEST%'
	     GROUP BY TT.SUP_SHORTNAME, TT.LEASE_TERM,TT.PROJECT_STATUS, T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, 
        	T.CONFIRM_DATE_START, TT.ON_CARD, TTT.SHOW_NODE ,TTT.TAX_TYPE,TT.PAY_WAY,TT.LEASE_CODE,TT.PAY_ID,TT.MULTIPLE_MODEL,TTT.TAX_RATE
	     	ORDER BY nlssort(TT.CLIENT_NAME,'NLS_SORT=SCHINESE_PINYIN_M'),TT.PRO_CODE,TT.LEASE_CODE,T.PAYLIST_CODE 
	  )S WHERE NVL(S.CAPITAL_PRICE_TOTAL,0)+NVL(S.INTEREST_PRICE_TOTAL,0)+NVL(S.LXZZS_PRICE_TOTAL,0)+NVL(S.GLF_PERIOD_PRICE_TOTAL,0)+NVL(S.SXF_PERIOD_PRICE_TOTAL,0)+NVL(S.OVER_PRICE_TOTAL,0)+NVL(S.ACCRUE_RENT_PRICE,0)+${COLUMNSITEMTOTALMONEY} !=0
		 <if test="PRO_CODE !=null and PRO_CODE !=''">AND S.PRO_CODE LIKE '%${PRO_CODE}%'</if> 
	      <if test="CLIENT_NAME != null and CLIENT_NAME !=''">AND S.CLIENT_NAME LIKE '%${CLIENT_NAME}%'</if> 
	      <if test="PLATFORM_TYPE !=null and PLATFORM_TYPE !=''">AND S.MULTIPLE_MODEL=#{PLATFORM_TYPE}</if>
		  <if test="SUP_SHORTNAME !=null and SUP_SHORTNAME !=''">AND S.SUP_SHORTNAME LIKE '%${SUP_SHORTNAME}%'</if>
		  <if test="ON_CARD != null and ON_CARD !=''">AND S.ON_CARD = #{ON_CARD}</if>
		  <if test="LEASE_CODE !=null and LEASE_CODE !=''">AND S.LEASE_CODE LIKE '%${LEASE_CODE}%'</if>
		  <if test="PAYLIST_CODE !=null and PAYLIST_CODE !=''">AND S.PAYLIST_CODE LIKE '%${PAYLIST_CODE}%'</if>
		  <if test="START_TIME !=null and START_TIME !=''">AND S.CONFIRM_DATE_START >= #{START_TIME}</if>
		  <if test="END_TIME != null and END_TIME !=''">AND <![CDATA[S.CONFIRM_DATE_START <= #{END_TIME}]]></if>
</select>

<select id="getMergerDetailMess" parameterType="Map" resultType="Map">
SELECT * FROM (  
 SELECT T.BEGINNING_RECEIVE_DATA,
           T.BEGINNING_NUM,
           T.ITEM_FLAG,
           T.PAYLIST_CODE,
           T.BEGINNING_NAME,
           T.BEGINNING_MONEY  FROM (
           SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  NVL(BA.PERIOD,0) BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  D_PAY_PROJECT BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,0) BEGINNING_MONEY 
             FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH,FIL_RENT_PLAN_HEAD_MAX_V MAV
            WHERE BA.D_FUND_ID = FH.ID 
            AND BA.D_PAY_CODE = MAV.PAYLIST_CODE
            AND FH.FI_STATUS =2 AND BA.RED_STATUS = 0 
            AND BA.RE_STATUS = 0 AND BA.D_RECEIVE_MONEY &lt;&gt;0
    )T  LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID,
    					  NVL(DE.RENT_LIST,0) RENT_LIST
	                 FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
	                 WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1  AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
	               )WW
	           ON T.PAYLIST_CODE = WW.PAYLIST_CODE 
	          AND T.BEGINNING_NAME = WW.ITEM_NAME
	          AND ((T.BEGINNING_NUM is not null and T.BEGINNING_NUM = WW.RENT_LIST ) or T.BEGINNING_NUM is null)
	          WHERE WW.SALEITEM_INVOICE_ID IS  NULL
	          
    )W  LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
        				 V.PAY_ID,
        				 HE.LEASE_CODE,
                         HE.PRO_NAME,
                         HE.CLIENT_ID,
                         HE.STATUS PROJECT_STATUS,
                         V.company_name SUB_COMPANY_NAME,
                         CL.NAME CLIENT_NAME,
                         V.START_DATE CONFIRM_DATE_START,
                         V.START_DATE CONFIRM_DATE_END,
                         V.PAY_WAY,
                         CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                         V.platform_type MULTIPLE_MODEL,
                         getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                         V.PAYLIST_CODE,
                         V.SUP_NAME SUP_SHORTNAME,
                         GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD,
                         V.LEASE_TERM
                  FROM  v_plan_scheme V,
                        FIL_PROJECT_HEAD HE,
        		        FIL_CUST_CLIENT CL,
                    FIL_INVOICE_APPLICATION FIA
        		  WHERE V.PROJECT_ID =HE.ID
        		    AND HE.CLIENT_ID = CL.ID
                AND V.PAYLIST_CODE=FIA.PAYLIST_CODE
     )TT ON W.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
           SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
	         ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
	         ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
	         ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
	     )TTT ON W.BEGINNING_NAME = TTT.FUND_TYPE
     <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if>   
     WHERE TTT.IF_INVOICE = 1 
     AND W.PAYLIST_CODE = #{PAYLIST_CODE}
	 <if test="TAX_RATE !=null and TAX_RATE !=''">and TTT.TAX_RATE=#{TAX_RATE}</if>   
</select>

<select id="getMergerItemMess" parameterType="Map" resultType="Map">
SELECT * FROM (
  SELECT T.D_BEGING_ID BEGINNING_ID,
  		 TO_CHAR(MAX(T.BEGINNING_RECEIVE_DATA),'YYYY-MM-DD') BEGINNING_RECEIVE_DATA,
         T.PAYLIST_CODE,
         SUM(T.BEGINNING_MONEY) BEGINNING_MONEY,
         TT.PROJECT_ID,
         TT.PRO_CODE,
         TT.PRO_NAME,
         TT.CLIENT_ID,
         TT.CLIENT_NAME,
         TO_CHAR(TT.CONFIRM_DATE_START,'YYYY-MM-DD') CONFIRM_DATE_START,
         TT.ON_CARD,
         TTT.SHOW_NODE,
         TTT.MERGE_NAME,
         TTT.TAX_TYPE,
         TT.IS_INVOICE_MONTH,
         TT.PAY_ID,
		 TT.LEASE_CODE,
		 TTT.TAX_RATE
    FROM (SELECT W.BEGINNING_RECEIVE_DATA,
	             W.BEGINNING_NUM,
	             W.ITEM_FLAG,
	             W.PAYLIST_CODE,
	             W.BEGINNING_NAME,
	             W.BEGINNING_MONEY, 
	             W.D_BEGING_ID 
      FROM(SELECT BA.D_REALITY_DATE BEGINNING_RECEIVE_DATA, 
                  NVL(BA.PERIOD,0) BEGINNING_NUM,
                  BA.D_STATUS ITEM_FLAG,
                  BA.D_PAY_CODE PAYLIST_CODE ,	
                  BA.D_PAY_PROJECT BEGINNING_NAME,
                  round(BA.D_RECEIVE_MONEY,2) BEGINNING_MONEY,BA.d_Beging_Id
             FROM FI_FUND_DETAIL BA,FI_FUND_HEAD FH,FIL_RENT_PLAN_HEAD_MAX_V MAV
            WHERE BA.D_FUND_ID = FH.ID 
            AND BA.D_PAY_CODE = MAV.PAYLIST_CODE
            AND FH.FI_STATUS =2 AND BA.RED_STATUS = 0 
            AND BA.RE_STATUS = 0 AND BA.D_RECEIVE_MONEY &lt;&gt;0
         )W
    LEFT JOIN (SELECT DE.PAYLIST_CODE,DE.TARGET_TYPE,DE.TARGET_ID,DE.ITEM_NAME,DE.SALEITEM_INVOICE_ID,
                      NVL(DE.RENT_LIST,0) RENT_LIST
                 FROM FI_SALEITEM_INVOICE SI, FI_SALEITEM_INVOICE_DETAIL DE 
                 WHERE SI.ID = DE.SALEITEM_INVOICE_ID AND SI.INVOICE_STATUS =1  AND SI.INVOICE_TYPE=#{INVOICE_TYPE}
               )WW
           ON W.PAYLIST_CODE = WW.PAYLIST_CODE 
          AND W.BEGINNING_NAME = WW.ITEM_NAME
          AND ((W.BEGINNING_NUM is not null and W.BEGINNING_NUM = WW.RENT_LIST ) or W.BEGINNING_NUM is null)
          WHERE WW.SALEITEM_INVOICE_ID IS  NULL
          )T
    LEFT JOIN (
          SELECT HE.ID PROJECT_ID,
                 HE.PRO_CODE,
        				 V.PAY_ID,
        				 HE.LEASE_CODE,
                         HE.PRO_NAME,
                         HE.CLIENT_ID,
                         HE.STATUS PROJECT_STATUS,
                         V.company_name SUB_COMPANY_NAME,
                         CL.NAME CLIENT_NAME,
                         V.START_DATE CONFIRM_DATE_START,
                         V.START_DATE CONFIRM_DATE_END,
                         V.PAY_WAY,
                         CASE WHEN V.platform_type='4' THEN getDictShortnameByCode('租赁模式',HE.LEASE_MODEL) ELSE 'NO' END LEASING_MODEL,
                         V.platform_type MULTIPLE_MODEL,
                         getDictShortnameByCode('开票方式',FIA.INVOICEPATTERN) IS_INVOICE_MONTH,
                         V.PAYLIST_CODE,
                         V.SUP_NAME SUP_SHORTNAME,
                         GETDICTDATABYCODE('上牌方式',V.CARDWAY) ON_CARD,
                         V.LEASE_TERM
                  FROM  v_plan_scheme V,
                        FIL_PROJECT_HEAD HE,
        		        FIL_CUST_CLIENT CL,
                    FIL_INVOICE_APPLICATION FIA
        		  WHERE V.PROJECT_ID =HE.ID
        		    AND HE.CLIENT_ID = CL.ID
                AND V.PAYLIST_CODE=FIA.PAYLIST_CODE 
               )TT
               ON T.PAYLIST_CODE = TT.PAYLIST_CODE
     LEFT JOIN (
         SELECT HF.ID,HF.ruler_head_id,HF.ruler_name,HF.descr,HF.create_time,HF.create_code,HF.update_time,HF.update_code,HF.on_card,HF.multiple_model
	         ,HF.confirm_date_start,HF.confirm_date_end,HF.is_invoice_month
	         ,CASE WHEN HF.multiple_model='4' THEN HF.leasing_model ELSE 'NO' END leasing_model
	         ,CF.RULER_ID,CF.FUND_TYPE,CF.IF_INVOICE,CF.IF_RECEIPT,CF.MERGE_NAME,CF.SHOW_NODE,CF.TAX_TYPE,CF.TAX_RATE FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF WHERE HF.ID = CF.RULER_ID  
	     )TTT
      ON T.BEGINNING_NAME = TTT.FUND_TYPE
      <if test="SQL_STR !=null and SQL_STR !=''">${SQL_STR}</if>
      WHERE TTT.IF_INVOICE = 1
   GROUP BY T.D_BEGING_ID,T.PAYLIST_CODE, TT.PROJECT_ID, TT.PRO_CODE, TT.PRO_NAME, TT.CLIENT_ID, TT.CLIENT_NAME, TT.CONFIRM_DATE_START, TT.ON_CARD, TTT.SHOW_NODE
   ,TTT.TAX_TYPE,TT.IS_INVOICE_MONTH ,TTT.MERGE_NAME,TT.PAY_ID,TT.LEASE_CODE,TTT.TAX_RATE
  ) Q WHERE Q.PAYLIST_CODE = #{PAYLIST_CODE} 
       <if test="TAX_RATE !=null and TAX_RATE !=''">AND Q.TAX_RATE=#{TAX_RATE}</if>
</select>

<update id="insertIntoFi_Invoice_Info_Tax">
	insert into fi_INVOICE_INFO_TAX select ${SQL_VALUES},1 from dual 
	where not exists (select id from fi_INVOICE_INFO_TAX where INVOICE_NO = #{SQL_INVOICE_CODE} and equip_num = #{SQL_EQUIP_NUM}) 
</update>
<update id="updateCheckByBillCode">
	update FI_SALEITEM_INVOICE  
	set IF_EXPORT_FP=1,status=1,INVOICE_CODE=#{INVOICE_CODE},INVOICE_DATE=to_date(#{INVOICE_DATE},'yyyy-mm-dd'),
		 MODIFICATOR=#{SQL_USER_ID},MODIFY_DATE=sysdate,INVOICE_DLD=#{INVOICE_DLD},
		 INVOICE_TO_NAME=#{INVOICE_TO_NAME},EMS_NAME=#{EMS_NAME},EMS_NUM=#{EMS_NUM},EMS_DATE=sysdate
	 where id  = #{EXPORT_MEMO} 
</update>

<update id="updateMergeCheckByBillCode">
	update FI_SALEITEM_INVOICE  
	set IF_EXPORT_FP=1,status=1,MODIFICATOR=#{SQL_USER_ID},MODIFY_DATE=sysdate 
	 where id =(select ALL_INVOICE_ID from FI_SALEITEM_INVOICE where id  = #{EXPORT_MEMO} and rownum=1) 
</update>

<select id="getSonInvoice" parameterType="Map" resultType="Map">
   SELECT FI.ID,
          FI.ALL_INVOICE_ID,
          FI.PROJ_ID,
          FI.PROJ_CODE,
          FI.FUND_NAME,
          FI.FUND_TYPE,
          FI.TARGET_ID,
          FI.TARGET_TYPE,
          FI.INVOICE_AMT,
          FI.INVOICE_CODE,
          FI.INVOICE_DATE,
          FI.INVOICE_STATUS,
          FI.INVOICE_TO_NAME,
          FI.INVOICE_TYPE,
          FI.IS_HEBING,
          FI.IF_EXPORT_FP,
          FI.MERGE_FLAG,
          FI.RENT_LIST,
          FI.CREATE_DATE 
     FROM FI_SALEITEM_INVOICE FI 
    WHERE FI.ALL_INVOICE_ID IN(${reJectData})
</select>

<update id="updateExportFlag" parameterType="Map">
  UPDATE FI_SALEITEM_INVOICE SI SET SI.IF_EXPORT_FP = 1 WHERE SI.ID = #{IN_ID} AND SI.IF_EXPORT_FP !=1
</update>

<select id="getUpLimitMess" parameterType="Map" resultType="Int">
 SELECT COUNT(SI.ID) FROM FI_SALEITEM_INVOICE SI 
  WHERE NVL(SI.IS_HEBING, '1') = '1' 
  <if test="INVOICE_TYPE !=null and INVOICE_TYPE !=''">AND SI.INVOICE_TYPE = #{INVOICE_TYPE}</if>
  <if test="UP_LIMIT !=null and UP_LIMIT !=''">AND SI.INVOICE_AMT > #{UP_LIMIT}</if>
  <if test="exportAll !=null and exportAll !=''">AND DECODE(NVL(SI.IS_HEBING, '1'), '1', SI.ALL_INVOICE_ID, SI.ID) IN (${sqlData}) </if> 
    AND SI.INVOICE_CODE IS NULL 
    AND SI.PROJ_CODE NOT LIKE '%TEST%'  
    AND SI.STATUS = 0 
</select>

<select id="getDicShortNameByTypeCode" parameterType="Map" resultType="Map">
  SELECT GETDICTSHORTNAMEBYCODE(#{DIC_TYPE},#{DIC_CODE}) LIMIT_NUM FROM DUAL WHERE ROWNUM = 1
</select>


<sql id="hbkpColumns"> 
   SELECT distinct CF.FUND_TYPE
       FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF,T_SYS_DATA_DICTIONARY tsdd  
       WHERE HF.ID = CF.RULER_ID  and HF.is_invoice_month='合并开具' and CF.IF_INVOICE=1 and tsdd.type='发票_资金别名' and CF.FUND_TYPE=tsdd.flag
</sql>

<select id="hbkpColumnsMaxMoney" resultType="String">
	select 
          WM_CONCAT('MAX(DECODE(T.BEGINNING_NAME,''' || t1.FUND_TYPE || ''',T.BEGINNING_MONEY)) ' || t1.shortname) 
    from (
          SELECT distinct CF.FUND_TYPE,tsdd.shortname
       FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF,T_SYS_DATA_DICTIONARY tsdd  
       WHERE HF.ID = CF.RULER_ID  and HF.is_invoice_month='合并开具' and CF.IF_INVOICE=1 and tsdd.type='发票_资金别名' and CF.FUND_TYPE=tsdd.flag
        and CF.FUND_TYPE not in ('首期租金','第一期租金','租前利息','本金','利息','违约金','利息增值税')
   ) t1 
</select>

<select id="hbkpColumnsTotalMoney" resultType="String">
		select 
		       replace(replace(WM_CONCAT('NVL(' || 'S.' || t1.shortname  || ';0)'),',','+'),';',',')
    from (
          SELECT distinct tsdd.shortname
       FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF,T_SYS_DATA_DICTIONARY tsdd  
       WHERE HF.ID = CF.RULER_ID  and HF.is_invoice_month='合并开具' and CF.IF_INVOICE=1 and tsdd.type='发票_资金别名' and CF.FUND_TYPE=tsdd.flag
        and CF.FUND_TYPE not in ('首期租金','第一期租金','租前利息','本金','利息','违约金','利息增值税')
   ) t1 
</select>

<select id="hbkjColumnsAllTitel" resultType="map">
	SELECT distinct CF.FUND_TYPE,upper(tsdd.shortname) shortname
       FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF,T_SYS_DATA_DICTIONARY tsdd  
       WHERE HF.ID = CF.RULER_ID  and HF.is_invoice_month='合并开具' and CF.IF_INVOICE=1 and tsdd.type='发票_资金别名' and CF.FUND_TYPE=tsdd.flag
        and CF.FUND_TYPE not in ('首期租金','第一期租金','租前利息','本金','利息','违约金','利息增值税'
        )
</select>



<sql id="aykpColumns"> 
   SELECT distinct CF.FUND_TYPE
       FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF,T_SYS_DATA_DICTIONARY tsdd  
       WHERE HF.ID = CF.RULER_ID  and HF.is_invoice_month='按月开具' and CF.IF_INVOICE=1 and tsdd.type='发票_资金别名' and CF.FUND_TYPE=tsdd.flag
</sql>

<select id="aykpColumnsMaxMoney" resultType="String">
	select 
          WM_CONCAT('MAX(DECODE(T.BEGINNING_NAME,''' || t1.FUND_TYPE || ''',T.BEGINNING_MONEY)) ' || t1.shortname) 
    from (
          SELECT distinct CF.FUND_TYPE,tsdd.shortname
       FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF,T_SYS_DATA_DICTIONARY tsdd  
       WHERE HF.ID = CF.RULER_ID  and HF.is_invoice_month='按月开具' and CF.IF_INVOICE=1 and tsdd.type='发票_资金别名' and CF.FUND_TYPE=tsdd.flag
        and CF.FUND_TYPE not in ('首期租金','第一期租金','租前利息'
        
        )
   ) t1 
</select>

<select id="aykpColumnsTotalMoney" resultType="String">
		select 
		       replace(replace(WM_CONCAT('NVL(' || 'S.' || t1.shortname  || ';0)'),',','+'),';',',')
    from (
          SELECT distinct tsdd.shortname
       FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF,T_SYS_DATA_DICTIONARY tsdd  
       WHERE HF.ID = CF.RULER_ID  and HF.is_invoice_month='按月开具' and CF.IF_INVOICE=1 and tsdd.type='发票_资金别名' and CF.FUND_TYPE=tsdd.flag
        and CF.FUND_TYPE not in ('首期租金','第一期租金','租前利息'
        
        )
   ) t1 
</select>

<select id="aykjColumnsAllTitel" resultType="map">
	SELECT distinct CF.FUND_TYPE,upper(tsdd.shortname) shortname
       FROM V_FI_INVOICE_RULER_HEAD_FINAL HF,FI_INVOICE_RULER_CONFIG_FINAL CF,T_SYS_DATA_DICTIONARY tsdd  
       WHERE HF.ID = CF.RULER_ID  and HF.is_invoice_month='按月开具' and CF.IF_INVOICE=1 and tsdd.type='发票_资金别名' and CF.FUND_TYPE=tsdd.flag
        and CF.FUND_TYPE not in ('首期租金','第一期租金','租前利息','本金','利息','违约金','利息增值税'
        )
</select>
</mapper>